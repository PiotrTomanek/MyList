<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyList</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        button:focus { outline: none; }
        @media (hover: none) { button:hover { background: inherit; } }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #000; }

        header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            z-index: 100;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
        }

        .header-action-btn {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px;
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer; transition: all 0.2s ease;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.5);
            letter-spacing: 0.05em;
        }
        .header-action-btn:hover { border-color: #fff; color: #fff; }

        .carousel-container {
            position: fixed; top: 74px; left: 0; right: 0; bottom: 80px;
            perspective: 2000px;
            display: flex; align-items: center; justify-content: center;
        }
        .carousel-track { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

        .category-card {
            position: absolute; width: 85%; max-width: 900px; height: 85%;
            background: transparent; padding: 40px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; overflow-x: hidden;
        }
        .category-card::-webkit-scrollbar { width: 4px; }
        .category-card::-webkit-scrollbar-track { background: transparent; }
        .category-card::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 2px; }

        .category-card.active { z-index: 10; opacity: 1; transform: translateX(0) translateZ(0) scale(1) rotateY(0deg); pointer-events: auto; filter: blur(0); }
        .category-card.prev { z-index: 5; opacity: 0.15; transform: translateX(-45%) translateZ(-400px) scale(0.7) rotateY(15deg); pointer-events: none; filter: blur(3px); }
        .category-card.next { z-index: 5; opacity: 0.15; transform: translateX(45%) translateZ(-400px) scale(0.7) rotateY(-15deg); pointer-events: none; filter: blur(3px); }
        .category-card.hidden { opacity: 0; transform: translateX(0) translateZ(-600px) scale(0.5); pointer-events: none; filter: blur(5px); }

        .category-header { display: flex; align-items: baseline; gap: 20px; margin-bottom: 50px; padding-bottom: 20px; }
        .category-title {
            font-family: 'Bebas Neue', 'Impact', sans-serif;
            font-size: 5rem; color: #fff; font-weight: 400;
            letter-spacing: 0.02em; flex-grow: 1;
            cursor: text; padding: 4px 8px; outline: none; text-transform: uppercase;
            line-height: 0.9;
        }
        .category-title:hover { background: rgba(255, 255, 255, 0.05); }
        .category-title:focus { background: rgba(255, 255, 255, 0.1); }
        .category-count { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: rgba(255, 255, 255, 0.3); letter-spacing: 0.1em; }

        .add-task-btn {
            width: 44px; height: 44px; border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent; color: rgba(255, 255, 255, 0.4);
            font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .add-task-btn:hover { color: #fff; border-color: #fff; transform: rotate(90deg); }

        .task-list { list-style: none; margin-bottom: 30px; }
        .task-item { padding: 20px 0; transition: all 0.2s ease; position: relative; overflow: hidden; }
        .task-item:hover { padding-left: 12px; }

        .task-swipe-container { position: relative; touch-action: pan-y pinch-zoom; overflow: hidden; }
        .task-swipe-content { position: relative; background: transparent; transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); will-change: transform; }
        .task-swipe-content.swiping { transition: none; }
        .task-swipe-content.snapping { transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        .task-delete-bg {
            position: absolute; top: 0; right: 0; bottom: 0; width: 100%;
            background: linear-gradient(90deg, transparent 30%, rgba(255, 255, 255, 0.05) 70%, rgba(255, 255, 255, 0.1) 100%);
            display: flex; align-items: center; justify-content: flex-end;
            padding-right: 25px; color: #fff;
            font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.1em;
            opacity: 0; transition: opacity 0.2s ease;
        }
        .task-delete-bg.visible { opacity: 1; }
        .task-delete-bg.ready { background: linear-gradient(90deg, transparent 20%, rgba(255, 255, 255, 0.1) 60%, rgba(255, 255, 255, 0.2) 100%); }

        @keyframes poof { 0% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(-30px); opacity: 0; } }
        .task-item.poofing { animation: poof 0.3s ease-out forwards; pointer-events: none; }

        .swipe-hint { font-size: 0.7rem; color: rgba(255, 255, 255, 0.3); margin-top: 6px; font-style: italic; opacity: 0; transition: opacity 0.3s ease; text-transform: uppercase; letter-spacing: 0.1em; }
        .task-item.completed:hover .swipe-hint { opacity: 1; }
        @media (max-width: 768px) { .task-item.completed .swipe-hint { opacity: 0.7; } }

        .task-main { display: flex; align-items: flex-start; gap: 15px; }
        .task-checkbox {
            width: 24px; height: 24px; min-width: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer; flex-shrink: 0; transition: all 0.2s ease;
            margin-top: 6px; display: flex; align-items: center; justify-content: center;
            background: transparent;
        }
        .task-checkbox:hover { border-color: #fff; transform: scale(1.1); }
        .task-checkbox.checked { background: #fff; border-color: #fff; }
        .task-checkbox.checked::after { content: '✓'; color: #000; font-size: 14px; font-weight: bold; }

        .task-content { flex-grow: 1; }
        .task-text {
            font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; line-height: 1.2;
            color: #fff; cursor: text; padding: 4px 8px; outline: none; letter-spacing: 0.02em;
        }
        .task-text:hover { background: rgba(255, 255, 255, 0.05); }
        .task-text:focus { background: rgba(255, 255, 255, 0.1); }
        .task-item.completed .task-text { text-decoration: line-through; opacity: 0.3; }

        .task-meta { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .priority-badge { padding: 4px 12px; font-family: 'Bebas Neue', sans-serif; font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; border: 1px solid; }
        .priority-urgent { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }
        .priority-high { border-color: rgba(255,255,255,0.5); color: rgba(255,255,255,0.7); }
        .priority-medium { border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.4); }

        .subtask-toggle {
            margin-top: 12px; color: rgba(255, 255, 255, 0.4);
            font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; user-select: none;
            padding: 6px 10px; display: inline-block; letter-spacing: 0.1em; text-transform: uppercase;
        }
        .subtask-toggle:hover { color: #fff; }

        .subtask-list { margin-top: 15px; margin-left: 35px; padding-left: 20px; border-left: 1px solid rgba(255, 255, 255, 0.1); }
        .subtask-item { padding: 10px 0; font-size: 1rem; color: rgba(255, 255, 255, 0.6); display: flex; align-items: center; gap: 12px; }
        .subtask-number { min-width: 28px; height: 28px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); flex-shrink: 0; }
        .subtask-text { cursor: text; padding: 4px 8px; outline: none; flex-grow: 1; font-family: 'Inter', sans-serif; }
        .subtask-text:hover { background: rgba(255, 255, 255, 0.05); }
        .subtask-text:focus { background: rgba(255, 255, 255, 0.1); }

        .subcategory { margin-left: 30px; margin-top: 40px; padding: 25px; padding-left: 25px; border-left: 1px solid rgba(255, 255, 255, 0.15); }
        .subcategory-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .subcategory-title { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: rgba(255, 255, 255, 0.7); cursor: text; padding: 4px 8px; outline: none; letter-spacing: 0.05em; text-transform: uppercase; }
        .subcategory-title:hover { background: rgba(255, 255, 255, 0.05); }
        .subcategory-title:focus { background: rgba(255, 255, 255, 0.1); }

        .add-subtask-btn { width: 32px; height: 32px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: rgba(255, 255, 255, 0.3); font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .add-subtask-btn:hover { color: #fff; border-color: #fff; transform: rotate(90deg); }
        
        .delete-group-btn { width: 32px; height: 32px; border: 1px solid transparent; background: transparent; color: rgba(255, 255, 255, 0.2); font-size: 1rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 8px; opacity: 0; }
        .subcategory:hover .delete-group-btn { opacity: 1; }
        .delete-group-btn:hover { color: #fff; border-color: rgba(255,255,255,0.3); }

        .carousel-indicator { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 100; }
        .carousel-dot { width: 8px; height: 8px; background: rgba(255, 255, 255, 0.2); border: none; cursor: pointer; transition: all 0.3s ease; }
        .carousel-dot.active { background: #fff; transform: scale(1.5); }
        .carousel-dot:hover { background: rgba(255, 255, 255, 0.5); transform: scale(1.3); }

        .manage-btn-container { position: fixed; bottom: 30px; right: 20px; z-index: 100; display: flex; gap: 12px; align-items: center; }
        .fab-add-task { width: 56px; height: 56px; border: none; background: #fff; color: #000; font-size: 2rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .fab-add-task:hover { transform: scale(1.1) rotate(90deg); }
        .manage-categories-btn { width: 44px; height: 44px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: rgba(255, 255, 255, 0.4); font-family: 'Bebas Neue', sans-serif; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; letter-spacing: 0.05em; }
        .manage-categories-btn:hover { color: #fff; border-color: #fff; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal { background: #000; border: 1px solid rgba(255, 255, 255, 0.1); padding: 40px; width: 90%; max-width: 450px; animation: modal-pop 0.3s ease-out; }
        @keyframes modal-pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .modal h2 { font-family: 'Bebas Neue', sans-serif; color: #fff; margin-bottom: 30px; font-size: 2.5rem; font-weight: 400; letter-spacing: 0.05em; text-transform: uppercase; }
        .modal-input { width: 100%; padding: 16px 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 16px; font-family: 'Inter', sans-serif; outline: none; margin-bottom: 20px; }
        .modal-input:focus { border-bottom-color: #fff; }
        .modal-input::placeholder { color: rgba(255, 255, 255, 0.3); }
        .modal-select { flex: 1; padding: 16px 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 16px; outline: none; cursor: pointer; }
        .modal-select option { background: #000; color: #fff; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 30px; }
        .modal-btn { flex: 1; padding: 16px; border: none; font-family: 'Bebas Neue', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; letter-spacing: 0.1em; text-transform: uppercase; }
        .modal-btn.primary { background: #fff; color: #000; }
        .modal-btn.primary:hover { transform: scale(1.02); }
        .modal-btn.secondary { background: transparent; color: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.2); }
        .modal-btn.secondary:hover { color: #fff; border-color: rgba(255, 255, 255, 0.4); }
        .modal-btn.danger { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.3); }

        .modal-manage { max-width: 400px; }
        .modal-subtitle { color: rgba(255, 255, 255, 0.4); font-size: 0.85rem; margin-bottom: 25px; margin-top: -20px; }
        .manage-categories-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .manage-category-item { display: flex; align-items: center; gap: 12px; padding: 18px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .manage-category-item.urgent-item { opacity: 0.3; pointer-events: none; }
        .manage-category-name { flex: 1; color: #fff; font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .manage-category-delete { background: transparent; border: 1px solid transparent; color: rgba(255, 255, 255, 0.3); width: 32px; height: 32px; font-size: 1.1rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .manage-category-delete:hover { color: #fff; border-color: rgba(255,255,255,0.3); }
        .add-category-btn { width: 100%; padding: 15px; background: transparent; border: 1px dashed rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.5); font-family: 'Bebas Neue', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; margin-bottom: 20px; letter-spacing: 0.1em; }
        .add-category-btn:hover { border-color: rgba(255, 255, 255, 0.4); color: #fff; }
        .start-over-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .start-over-link { background: transparent; border: none; color: rgba(255, 255, 255, 0.3); font-size: 0.85rem; cursor: pointer; padding: 8px 16px; transition: all 0.2s ease; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; }
        .start-over-link:hover { color: #fff; }

        .modal-confirm { max-width: 360px; text-align: center; }
        .confirm-icon { font-size: 3rem; margin-bottom: 15px; display: none; }
        .confirm-message { color: rgba(255, 255, 255, 0.6); font-size: 0.95rem; line-height: 1.6; margin-bottom: 10px; }

        .modal-welcome { max-width: 420px; text-align: center; }
        .welcome-icon { font-size: 1rem; margin-bottom: 10px; color: rgba(255,255,255,0.3); font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.2em; }
        .welcome-subtitle { color: rgba(255, 255, 255, 0.5); font-size: 0.95rem; margin-bottom: 30px; margin-top: -15px; }
        .welcome-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .welcome-option { display: flex; align-items: center; gap: 15px; padding: 20px; background: transparent; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: all 0.2s ease; text-align: left; }
        .welcome-option:hover { border-color: rgba(255, 255, 255, 0.3); transform: translateX(5px); }
        .welcome-option-icon { font-family: 'Bebas Neue', sans-serif; font-size: 0.8rem; flex-shrink: 0; color: rgba(255,255,255,0.5); letter-spacing: 0.1em; width: 40px; text-align: center; }
        .welcome-option-content { flex: 1; }
        .welcome-option-title { color: #fff; font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; margin-bottom: 4px; letter-spacing: 0.05em; text-transform: uppercase; }
        .welcome-option-desc { color: rgba(255, 255, 255, 0.4); font-size: 0.8rem; }
        .welcome-option-arrow { color: rgba(255, 255, 255, 0.3); font-size: 1.2rem; transition: transform 0.2s ease; }
        .welcome-option:hover .welcome-option-arrow { transform: translateX(5px); color: #fff; }

        .add-group-btn { margin-top: 20px; padding: 10px 0; background: transparent; border: none; color: rgba(255, 255, 255, 0.2); font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; text-transform: uppercase; }
        .add-group-btn:hover { color: #fff; }

        .add-steps-btn { margin-top: 8px; padding: 6px 12px; background: transparent; border: 1px dashed rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.3); font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease; opacity: 0; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; }
        .task-item:hover .add-steps-btn { opacity: 1; }
        .add-steps-btn:hover { border-color: rgba(255, 255, 255, 0.3); color: #fff; }

        .remove-step-btn { width: 28px; height: 28px; border: 1px solid transparent; background: transparent; color: rgba(255, 255, 255, 0.3); font-size: 1.1rem; cursor: pointer; transition: all 0.2s ease; opacity: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 8px; }
        .subtask-item:hover .remove-step-btn { opacity: 1; }
        .remove-step-btn:hover { color: #fff; border-color: rgba(255,255,255,0.3); }

        .edit-steps-btn { margin-top: 8px; padding: 4px 8px; background: transparent; border: none; color: rgba(255, 255, 255, 0.3); font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; width: auto; align-self: flex-start; letter-spacing: 2px; }
        .edit-steps-btn:hover { color: #fff; }

        .modal-steps { max-height: 80vh; display: flex; flex-direction: column; }
        .steps-list-container { max-height: 300px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .step-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .step-number-badge { width: 28px; height: 28px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.6); font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; flex-shrink: 0; }
        .step-input { flex: 1; padding: 12px 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 16px; outline: none; }
        .step-input:focus { border-bottom-color: #fff; }
        .step-input::placeholder { color: rgba(255, 255, 255, 0.3); }
        .step-remove-btn { width: 32px; height: 32px; border: 1px solid transparent; background: transparent; color: rgba(255, 255, 255, 0.3); font-size: 1.3rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .step-remove-btn:hover { color: #fff; border-color: rgba(255,255,255,0.3); }
        .add-step-modal-btn { padding: 15px; background: transparent; border: 1px dashed rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.5); font-family: 'Bebas Neue', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; margin-bottom: 20px; letter-spacing: 0.1em; }
        .add-step-modal-btn:hover { border-color: rgba(255, 255, 255, 0.4); color: #fff; }

        .modal-photo { max-width: 500px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-photo .modal-buttons { position: sticky; bottom: 0; background: linear-gradient(to top, #000 80%, transparent); padding-top: 15px; margin-top: auto; }
        .api-key-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .api-key-section label { display: block; color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; margin-bottom: 10px; }
        .api-key-input { width: 100%; padding: 12px 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 16px; outline: none; }
        .api-key-input:focus { border-bottom-color: #fff; }
        .api-key-input::placeholder { color: rgba(255, 255, 255, 0.3); }
        .api-key-saved { color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 8px; }
        .photo-upload-area { border: 1px dashed rgba(255, 255, 255, 0.2); padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-bottom: 20px; }
        .photo-upload-area:hover { border-color: rgba(255, 255, 255, 0.4); }
        .photo-upload-area.has-image { padding: 15px; }
        .photo-upload-icon { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; margin-bottom: 15px; color: rgba(255,255,255,0.3); letter-spacing: 0.1em; }
        .photo-upload-text { color: rgba(255, 255, 255, 0.6); font-size: 0.95rem; }
        .photo-upload-hint { color: rgba(255, 255, 255, 0.3); font-size: 0.8rem; margin-top: 10px; }
        .photo-previews-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center; padding: 10px; }
        .photo-preview-item { position: relative; width: 80px; height: 80px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); }
        .photo-preview-remove { position: absolute; top: -10px; right: -10px; width: 28px; height: 28px; background: #fff; border: 2px solid #000; color: #000; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s ease; }
        .photo-preview-remove:hover { transform: scale(1.15); }
        .add-more-photos-btn { width: 100%; padding: 12px; background: transparent; border: 1px dashed rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.5); font-size: 0.9rem; cursor: pointer; margin-bottom: 20px; transition: all 0.2s ease; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; }
        .add-more-photos-btn:hover { border-color: rgba(255, 255, 255, 0.4); color: #fff; }
        .processing-indicator { display: none; flex-direction: column; align-items: center; padding: 30px; }
        .processing-indicator.show { display: flex; }
        .spinner { width: 40px; height: 40px; border: 2px solid rgba(255, 255, 255, 0.1); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-text { color: rgba(255, 255, 255, 0.6); margin-top: 15px; font-size: 0.95rem; }
        .import-preview { display: none; max-height: 350px; overflow-y: auto; margin: 20px 0; }
        .import-preview.show { display: block; }
        .import-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .import-preview-title { color: rgba(255, 255, 255, 0.5); font-size: 0.9rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; }
        .import-edit-toggle { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.5); padding: 6px 14px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        .import-edit-toggle:hover { border-color: rgba(255, 255, 255, 0.4); color: #fff; }
        .import-edit-toggle.active { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.4); color: #fff; }
        .import-category { margin-bottom: 20px; padding: 15px; padding-left: 20px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
        .import-category-title { font-family: 'Bebas Neue', sans-serif; color: #fff; margin-bottom: 12px; font-size: 1.3rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .import-task-list { list-style: none; }
        .import-task-item { padding: 12px 0; color: #fff; font-size: 0.9rem; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .import-task-item:last-child { border-bottom: none; }
        .import-task-text { flex: 1 1 100%; min-width: 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; padding: 10px 0; outline: none; }
        .import-task-text:focus { border-bottom-color: #fff; }
        .import-task-text.editable { border-bottom-color: rgba(255, 255, 255, 0.2); }
        .import-task-category-select { flex: 1 1 auto; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.6); font-size: 16px; padding: 8px 0; cursor: pointer; display: none; min-width: 0; }
        .import-task-category-select.show { display: block; }
        .import-task-category-select option { background: #000; }
        .import-task-delete { background: transparent; border: 1px solid transparent; color: rgba(255, 255, 255, 0.3); font-size: 1.1rem; cursor: pointer; padding: 6px 10px; display: none; transition: all 0.2s ease; flex-shrink: 0; }
        .import-task-delete.show { display: flex; align-items: center; justify-content: center; }
        .import-task-delete:hover { color: #fff; border-color: rgba(255,255,255,0.3); }
        .import-error { color: #fff; background: rgba(255, 255, 255, 0.1); padding: 15px; margin: 15px 0; display: none; border-left: 2px solid #fff; }
        .import-error.show { display: block; }
        .import-success { color: #fff; text-align: center; padding: 30px; display: none; }
        .import-success.show { display: block; }
        .import-success-icon { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; margin-bottom: 15px; letter-spacing: 0.2em; }
        .import-mode-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .import-mode-label { color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; margin-bottom: 12px; display: block; }
        .import-mode-options { display: flex; gap: 10px; }
        .import-mode-btn { flex: 1; padding: 12px; background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        .import-mode-btn:hover { border-color: rgba(255, 255, 255, 0.4); color: #fff; }
        .import-mode-btn.active { background: rgba(255, 255, 255, 0.1); border-color: #fff; color: #fff; }
        .new-categories-section { margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.02); border-left: 1px solid rgba(255, 255, 255, 0.3); }
        .new-categories-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: #fff; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; letter-spacing: 0.1em; }
        .new-category-item { display: flex; align-items: center; gap: 10px; padding: 10px; margin-bottom: 8px; }
        .new-category-item:last-child { margin-bottom: 0; }
        .new-category-name-input { flex: 1; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 0.9rem; padding: 8px 0; min-width: 0; outline: none; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; text-transform: uppercase; }
        .new-category-name-input:focus { border-bottom-color: #fff; }
        .new-category-count { color: rgba(255, 255, 255, 0.4); font-size: 0.75rem; white-space: nowrap; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        .new-category-delete { width: 28px; height: 28px; border: 1px solid transparent; background: transparent; color: rgba(255, 255, 255, 0.3); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; }
        .new-category-delete:hover { color: #fff; border-color: rgba(255,255,255,0.3); }

        .modal-export { max-width: 500px; }
        .export-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .export-section:last-of-type { border-bottom: none; }
        .export-section-title { font-family: 'Bebas Neue', sans-serif; color: #fff; margin-bottom: 10px; font-size: 1.3rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .export-section-desc { color: rgba(255, 255, 255, 0.4); font-size: 0.85rem; margin-bottom: 15px; }
        .export-btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .export-action-btn { flex: 1; min-width: 100px; padding: 12px 15px; background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        .export-action-btn:hover { border-color: #fff; }
        .import-file-input { display: none; }
        .export-textarea { width: 100%; height: 120px; background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-family: monospace; font-size: 0.8rem; padding: 12px; resize: none; margin-top: 15px; outline: none; }
        .export-textarea:focus { border-color: rgba(255, 255, 255, 0.4); }
        .export-textarea::placeholder { color: rgba(255, 255, 255, 0.3); }
        .export-message { padding: 12px; margin-top: 15px; font-size: 0.85rem; display: none; border-left: 2px solid #fff; }
        .export-message.success { display: block; background: rgba(255, 255, 255, 0.05); color: #fff; }
        .export-message.error { display: block; background: rgba(255, 255, 255, 0.05); color: #fff; }
        .export-hint { font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); margin-top: 10px; padding: 10px; border-left: 1px solid rgba(255, 255, 255, 0.1); }

        @media (max-width: 768px) {
            header { padding: 12px 16px; }
            .carousel-container { top: 60px; }
            .category-card { width: 92%; padding: 25px; height: 88%; }
            .category-header { gap: 12px; margin-bottom: 30px; }
            .category-title { font-size: 3.5rem; }
            .task-text { font-size: 1.5rem; }
            .subcategory { margin-left: 15px; padding: 15px; padding-left: 20px; }
            .subcategory-title { font-size: 1.6rem; }
            .modal { padding: 30px 25px; width: 95%; }
            .modal h2 { font-size: 2rem; }
            .manage-btn-container { bottom: 20px; right: 15px; }
            .fab-add-task { width: 50px; height: 50px; font-size: 1.8rem; }
        }
        @media (max-width: 480px) {
            .category-title { font-size: 2.8rem; }
            .task-text { font-size: 1.3rem; }
            .category-count { display: none; }
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <header>
        <button class="header-action-btn" onclick="openPhotoImportModal()" title="Import from Photo">CAM</button>
        <button class="header-action-btn" onclick="openExportModal()" title="Export/Import Data">I/O</button>
    </header>
    <div class="carousel-container"><div class="carousel-track" id="carouselTrack"></div></div>
    <div class="carousel-indicator" id="carouselIndicator"></div>
    <div class="manage-btn-container">
        <button class="fab-add-task" id="fabAddTask" onclick="openAddTaskModalForCurrentCategory()" title="Add New Task"><span>+</span></button>
        <button class="manage-categories-btn" id="manageCategoriesBtn" onclick="openManageCategoriesModal()">SET</button>
    </div>

    <div class="modal-overlay" id="addTaskModal">
        <div class="modal">
            <h2>New Task</h2>
            <input type="text" class="modal-input" id="newTaskText" placeholder="What needs to be done?">
            <select class="modal-select" id="newTaskPriority" style="width: 100%;">
                <option value="">Priority (optional)</option>
                <option value="urgent">URGENT</option>
                <option value="high">HIGH</option>
                <option value="medium">MEDIUM</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAddModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewTask()">Add</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="manageCategoriesModal">
        <div class="modal modal-manage">
            <h2>Categories</h2>
            <p class="modal-subtitle">Add, remove, or reorder</p>
            <div class="manage-categories-list" id="manageCategoriesList"></div>
            <button class="add-category-btn" onclick="openAddCategoryModal()">+ NEW CATEGORY</button>
            <div class="start-over-section"><button class="start-over-link" onclick="confirmStartOver()">RESET ALL</button></div>
            <div class="modal-buttons"><button class="modal-btn primary" onclick="closeManageCategoriesModal()">Done</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="addCategoryModal">
        <div class="modal">
            <h2>New Category</h2>
            <input type="text" class="modal-input" id="newCategoryName" placeholder="Category name">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAddCategoryModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewCategory()">Add</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addGroupModal">
        <div class="modal">
            <h2>New Group</h2>
            <input type="text" class="modal-input" id="newGroupName" placeholder="Group name">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewGroup()">Add</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addStepsModal">
        <div class="modal modal-steps">
            <h2>Steps</h2>
            <p style="color: rgba(255,255,255,0.5); margin-bottom: 20px; font-size: 0.9rem;">Break down this task</p>
            <div class="steps-list-container" id="stepsListContainer"></div>
            <button class="add-step-modal-btn" id="addStepBtn" onclick="addStepInput()">+ ADD STEP</button>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeStepsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveStepsFromModal()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="photoImportModal">
        <div class="modal modal-photo">
            <h2>Photo Import</h2>
            <div class="api-key-section">
                <label>Claude API Key (stored locally)</label>
                <input type="password" class="api-key-input" id="claudeApiKey" placeholder="sk-ant-api03-...">
                <div class="api-key-saved" id="apiKeySaved" style="display: none;">KEY SAVED</div>
            </div>
            <div class="import-mode-section" id="importModeSection">
                <label class="import-mode-label">What should happen to existing tasks?</label>
                <div class="import-mode-options">
                    <button type="button" class="import-mode-btn active" id="importModeAdd" onclick="setImportMode('add')">ADD TO EXISTING</button>
                    <button type="button" class="import-mode-btn" id="importModeReplace" onclick="setImportMode('replace')">REPLACE ALL</button>
                </div>
            </div>
            <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                <div class="photo-upload-icon" id="photoUploadIcon">UPLOAD</div>
                <div class="photo-upload-text" id="photoUploadText">Click to select photos</div>
                <div class="photo-upload-hint">JPG, PNG</div>
                <div class="photo-previews-container" id="photoPreviewsContainer"></div>
            </div>
            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoSelect(event)">
            <button type="button" class="add-more-photos-btn" id="addMorePhotosBtn" onclick="document.getElementById('photoInput').click()" style="display: none;">+ MORE PHOTOS</button>
            <div class="processing-indicator" id="processingIndicator"><div class="spinner"></div><div class="processing-text" id="processingText">Reading...</div></div>
            <div class="import-error" id="importError"></div>
            <div class="import-preview" id="importPreview"></div>
            <div class="import-success" id="importSuccess"><div class="import-success-icon">DONE</div><p>Tasks imported</p></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closePhotoImportModal()">Cancel</button>
                <button class="modal-btn primary" id="processPhotoBtn" onclick="processPhoto()" style="display: none;">Process</button>
                <button class="modal-btn primary" id="confirmImportBtn" onclick="confirmPhotoImport()" style="display: none;">Import</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="exportModal">
        <div class="modal modal-export">
            <h2>Export / Import</h2>
            <div class="export-section">
                <div class="export-section-title">Export</div>
                <div class="export-section-desc">Download or copy your tasks</div>
                <div class="export-btn-row">
                    <button class="export-action-btn" onclick="downloadJSON()">JSON</button>
                    <button class="export-action-btn" onclick="downloadText()">TEXT</button>
                </div>
                <div class="export-btn-row" style="margin-top: 10px;">
                    <button class="export-action-btn" onclick="exportToAppleNotes()">CALENDAR</button>
                    <button class="export-action-btn" onclick="copyToClipboard()">COPY</button>
                </div>
                <div id="exportMessage" class="export-message"></div>
                <div class="export-hint">.ics files work with Apple/Google Calendar</div>
            </div>
            <div class="export-section">
                <div class="export-section-title">Import</div>
                <div class="export-section-desc">Restore from backup</div>
                <div class="export-btn-row">
                    <button class="export-action-btn" onclick="document.getElementById('importFileInput').click()">FROM FILE</button>
                    <input type="file" id="importFileInput" class="import-file-input" accept=".json" onchange="importFromFile(event)">
                </div>
                <textarea class="export-textarea" id="importTextarea" placeholder="Or paste JSON here..."></textarea>
                <div class="export-btn-row" style="margin-top: 10px;">
                    <button class="export-action-btn" onclick="importFromText()">IMPORT TEXT</button>
                </div>
                <div id="importMessage" class="export-message"></div>
            </div>
            <div class="modal-buttons"><button class="modal-btn secondary" onclick="closeExportModal()">Close</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal modal-confirm">
            <div class="confirm-icon" id="confirmIcon"></div>
            <h2 id="confirmTitle">Confirm</h2>
            <p class="confirm-message" id="confirmMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="modal-btn danger" id="confirmActionBtn" onclick="closeConfirmModal(true)">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="welcomeModal">
        <div class="modal modal-welcome">
            <div class="welcome-icon">MYLIST</div>
            <h2>Welcome</h2>
            <p class="welcome-subtitle">How would you like to start?</p>
            <div class="welcome-options">
                <div class="welcome-option" onclick="welcomePhotoImport()">
                    <div class="welcome-option-icon">01</div>
                    <div class="welcome-option-content">
                        <div class="welcome-option-title">Import from Photo</div>
                        <div class="welcome-option-desc">Snap a photo of your list</div>
                    </div>
                    <div class="welcome-option-arrow">→</div>
                </div>
                <div class="welcome-option" onclick="welcomeUseTemplates()">
                    <div class="welcome-option-icon">02</div>
                    <div class="welcome-option-content">
                        <div class="welcome-option-title">Use Templates</div>
                        <div class="welcome-option-desc">Start with sample categories</div>
                    </div>
                    <div class="welcome-option-arrow">→</div>
                </div>
                <div class="welcome-option" onclick="welcomeStartFresh()">
                    <div class="welcome-option-icon">03</div>
                    <div class="welcome-option-content">
                        <div class="welcome-option-title">Start Fresh</div>
                        <div class="welcome-option-desc">Create from scratch</div>
                    </div>
                    <div class="welcome-option-arrow">→</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        let categories = {};
        let categoryOrder = [];
        let currentCategoryIndex = 0;
        let confirmCallback = null;
        let currentEditingTaskId = null;
        let currentEditingCategoryId = null;
        let selectedPhotos = [];
        let parsedImportData = null;
        let isEditMode = false;
        let importMode = 'add';
        let isFirstTimeUser = false;

        const defaultData = {
            categories: {
                'urgent': { id: 'urgent', name: 'Urgent', tasks: [], isVirtual: true },
                'personal': { 
                    id: 'personal', 
                    name: 'Personal', 
                    tasks: [
                        { id: 'p1', text: 'Morning routine', completed: false, priority: null, steps: [
                            { text: 'Stretch for 10 minutes', completed: false },
                            { text: 'Review daily goals', completed: false }
                        ]},
                        { id: 'p2', text: 'Call mom', completed: false, priority: 'high', steps: [] },
                        { id: 'p3', text: 'Schedule dentist appointment', completed: false, priority: null, steps: [] }
                    ], 
                    groups: [
                        { id: 'pg1', name: 'Health', tasks: [
                            { id: 'ph1', text: 'Gym session', completed: false, priority: null, steps: [] },
                            { id: 'ph2', text: 'Meal prep for the week', completed: false, priority: null, steps: [] }
                        ]}
                    ] 
                },
                'work': { 
                    id: 'work', 
                    name: 'Work', 
                    tasks: [
                        { id: 'w1', text: 'Review project timeline', completed: false, priority: 'urgent', steps: [] },
                        { id: 'w2', text: 'Send weekly report', completed: false, priority: 'high', steps: [] },
                        { id: 'w3', text: 'Update documentation', completed: false, priority: 'medium', steps: [] }
                    ], 
                    groups: [] 
                },
                'shopping': { 
                    id: 'shopping', 
                    name: 'Shopping', 
                    tasks: [
                        { id: 's1', text: 'Groceries', completed: false, priority: null, steps: [
                            { text: 'Milk', completed: false },
                            { text: 'Bread', completed: false },
                            { text: 'Eggs', completed: false },
                            { text: 'Vegetables', completed: false }
                        ]},
                        { id: 's2', text: 'New running shoes', completed: false, priority: null, steps: [] }
                    ], 
                    groups: [] 
                }
            },
            categoryOrder: ['urgent', 'personal', 'work', 'shopping']
        };

        // Storage functions
        function saveToStorage() {
            const data = { categories, categoryOrder };
            localStorage.setItem('mylist-data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('mylist-data');
            if (saved) {
                const data = JSON.parse(saved);
                categories = data.categories;
                categoryOrder = data.categoryOrder;
                
                if (!categories['urgent']) {
                    categories['urgent'] = { id: 'urgent', name: 'Urgent', tasks: [], isVirtual: true };
                }
                if (!categoryOrder.includes('urgent')) {
                    categoryOrder.unshift('urgent');
                }
                
                return true;
            }
            return false;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getUrgentTasks() {
            const urgentTasks = [];
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                cat.tasks.forEach(task => {
                    if (task.priority === 'urgent' && !task.completed) {
                        urgentTasks.push({ ...task, sourceCategory: catId, sourceCategoryName: cat.name });
                    }
                });
                
                if (cat.groups) {
                    cat.groups.forEach(group => {
                        group.tasks.forEach(task => {
                            if (task.priority === 'urgent' && !task.completed) {
                                urgentTasks.push({ ...task, sourceCategory: catId, sourceCategoryName: cat.name, sourceGroup: group.id });
                            }
                        });
                    });
                }
            });
            return urgentTasks;
        }

        function renderCarousel() {
            const track = document.getElementById('carouselTrack');
            const indicator = document.getElementById('carouselIndicator');
            track.innerHTML = '';
            indicator.innerHTML = '';

            categoryOrder.forEach((catId, index) => {
                const cat = categories[catId];
                if (!cat) return;

                const card = document.createElement('div');
                card.className = 'category-card';
                card.dataset.index = index;

                if (cat.isVirtual) {
                    const urgentTasks = getUrgentTasks();
                    card.innerHTML = renderUrgentCard(cat, urgentTasks);
                } else {
                    card.innerHTML = renderCategoryCard(cat);
                }

                track.appendChild(card);

                const dot = document.createElement('button');
                dot.className = 'carousel-dot';
                dot.onclick = () => goToSlide(index);
                indicator.appendChild(dot);
            });

            updateCarouselPositions();
            setupSwipeListeners();
        }

        function renderUrgentCard(cat, urgentTasks) {
            const taskCount = urgentTasks.filter(t => !t.completed).length;
            
            let tasksHtml = '';
            if (urgentTasks.length === 0) {
                tasksHtml = '<p style="color: rgba(255,255,255,0.3); text-align: center; padding: 40px; font-family: Bebas Neue; letter-spacing: 0.1em;">NO URGENT TASKS</p>';
            } else {
                tasksHtml = '<ul class="task-list">';
                urgentTasks.forEach(task => {
                    tasksHtml += renderUrgentTaskItem(task);
                });
                tasksHtml += '</ul>';
            }

            return `
                <div class="category-header">
                    <span class="category-title">${cat.name}</span>
                    <span class="category-count">${taskCount}</span>
                </div>
                ${tasksHtml}
            `;
        }

        function renderUrgentTaskItem(task) {
            const priorityBadge = '<span class="priority-badge priority-urgent">URGENT</span>';
            const sourceBadge = `<span class="priority-badge priority-medium">${task.sourceCategoryName}</span>`;
            
            return `
                <li class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" data-source-category="${task.sourceCategory}" data-source-group="${task.sourceGroup || ''}">
                    <div class="task-swipe-container">
                        <div class="task-delete-bg"><span>DELETE</span></div>
                        <div class="task-swipe-content">
                            <div class="task-main">
                                <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleUrgentTask('${task.id}', '${task.sourceCategory}', '${task.sourceGroup || ''}')"></div>
                                <div class="task-content">
                                    <div class="task-text" contenteditable="true" onblur="updateUrgentTaskText(this, '${task.id}', '${task.sourceCategory}', '${task.sourceGroup || ''}')">${task.text}</div>
                                    <div class="task-meta">${priorityBadge}${sourceBadge}</div>
                                </div>
                            </div>
                            ${task.completed ? '<div class="swipe-hint">← Swipe to delete</div>' : ''}
                        </div>
                    </div>
                </li>
            `;
        }

        function renderCategoryCard(cat) {
            const taskCount = cat.tasks.filter(t => !t.completed).length + 
                (cat.groups || []).reduce((sum, g) => sum + g.tasks.filter(t => !t.completed).length, 0);

            let tasksHtml = '<ul class="task-list">';
            cat.tasks.forEach(task => {
                tasksHtml += renderTaskItem(task, cat.id);
            });
            tasksHtml += '</ul>';

            if (cat.groups && cat.groups.length > 0) {
                cat.groups.forEach(group => {
                    tasksHtml += `
                        <div class="subcategory" data-group-id="${group.id}">
                            <div class="subcategory-header">
                                <span class="subcategory-title" contenteditable="true" onblur="updateGroupName(this, '${cat.id}', '${group.id}')">${group.name}</span>
                                <button class="add-subtask-btn" onclick="openAddTaskModal('${cat.id}', '${group.id}')" title="Add Task">+</button>
                                <button class="delete-group-btn" onclick="confirmDeleteGroup('${cat.id}', '${group.id}')" title="Delete Group">×</button>
                            </div>
                            <ul class="task-list">
                                ${group.tasks.map(task => renderTaskItem(task, cat.id, group.id)).join('')}
                            </ul>
                        </div>
                    `;
                });
            }

            tasksHtml += `<button class="add-group-btn" onclick="openGroupModal('${cat.id}')">+ ADD GROUP</button>`;

            return `
                <div class="category-header">
                    <span class="category-title" contenteditable="true" onblur="updateCategoryName(this, '${cat.id}')">${cat.name}</span>
                    <span class="category-count">${taskCount}</span>
                    <button class="add-task-btn" onclick="openAddTaskModal('${cat.id}')" title="Add Task">+</button>
                </div>
                ${tasksHtml}
            `;
        }

        function renderTaskItem(task, categoryId, groupId = null) {
            let priorityBadge = '';
            if (task.priority === 'urgent') {
                priorityBadge = '<span class="priority-badge priority-urgent">URGENT</span>';
            } else if (task.priority === 'high') {
                priorityBadge = '<span class="priority-badge priority-high">HIGH</span>';
            } else if (task.priority === 'medium') {
                priorityBadge = '<span class="priority-badge priority-medium">MEDIUM</span>';
            }

            let stepsHtml = '';
            if (task.steps && task.steps.length > 0) {
                const completedSteps = task.steps.filter(s => s.completed).length;
                stepsHtml = `
                    <div class="subtask-toggle" onclick="toggleStepsVisibility(this)">
                        → ${completedSteps}/${task.steps.length} STEPS
                    </div>
                    <div class="subtask-list" style="display: none;">
                        ${task.steps.map((step, idx) => `
                            <div class="subtask-item">
                                <span class="subtask-number">${idx + 1}</span>
                                <span class="subtask-text" contenteditable="true" onblur="updateStepText(this, '${categoryId}', '${groupId || ''}', '${task.id}', ${idx})">${step.text}</span>
                                <button class="remove-step-btn" onclick="removeStep('${categoryId}', '${groupId || ''}', '${task.id}', ${idx})">×</button>
                            </div>
                        `).join('')}
                        <button class="edit-steps-btn" onclick="openStepsModal('${categoryId}', '${groupId || ''}', '${task.id}')">EDIT</button>
                    </div>
                `;
            }

            const groupAttr = groupId ? `data-group-id="${groupId}"` : '';

            return `
                <li class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" data-category-id="${categoryId}" ${groupAttr}>
                    <div class="task-swipe-container">
                        <div class="task-delete-bg"><span>DELETE</span></div>
                        <div class="task-swipe-content">
                            <div class="task-main">
                                <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${categoryId}', '${groupId || ''}', '${task.id}')"></div>
                                <div class="task-content">
                                    <div class="task-text" contenteditable="true" onblur="updateTaskText(this, '${categoryId}', '${groupId || ''}', '${task.id}')">${task.text}</div>
                                    <div class="task-meta">${priorityBadge}</div>
                                    ${stepsHtml}
                                    <button class="add-steps-btn" onclick="openStepsModal('${categoryId}', '${groupId || ''}', '${task.id}')">${task.steps && task.steps.length > 0 ? 'EDIT STEPS' : '+ STEPS'}</button>
                                </div>
                            </div>
                            ${task.completed ? '<div class="swipe-hint">← Swipe to delete</div>' : ''}
                        </div>
                    </div>
                </li>
            `;
        }

        function toggleStepsVisibility(el) {
            const list = el.nextElementSibling;
            const isVisible = list.style.display !== 'none';
            list.style.display = isVisible ? 'none' : 'block';
            el.innerHTML = el.innerHTML.replace(isVisible ? '↓' : '→', isVisible ? '→' : '↓');
        }

        function updateCarouselPositions() {
            const cards = document.querySelectorAll('.category-card');
            const dots = document.querySelectorAll('.carousel-dot');

            cards.forEach((card, index) => {
                card.classList.remove('active', 'prev', 'next', 'hidden');
                if (index === currentCategoryIndex) {
                    card.classList.add('active');
                } else if (index === currentCategoryIndex - 1) {
                    card.classList.add('prev');
                } else if (index === currentCategoryIndex + 1) {
                    card.classList.add('next');
                } else {
                    card.classList.add('hidden');
                }
            });

            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentCategoryIndex);
            });
        }

        function navigateCarousel(direction) {
            const newIndex = currentCategoryIndex + direction;
            if (newIndex >= 0 && newIndex < categoryOrder.length) {
                currentCategoryIndex = newIndex;
                updateCarouselPositions();
            }
        }

        function goToSlide(index) {
            currentCategoryIndex = index;
            updateCarouselPositions();
        }

        function setupSwipeListeners() {
            const track = document.getElementById('carouselTrack');
            let startX = 0;
            let isDragging = false;

            track.addEventListener('touchstart', (e) => {
                if (e.target.closest('.task-swipe-container')) return;
                startX = e.touches[0].clientX;
                isDragging = true;
            }, { passive: true });

            track.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                const endX = e.changedTouches[0].clientX;
                const diff = startX - endX;
                if (Math.abs(diff) > 50) {
                    navigateCarousel(diff > 0 ? 1 : -1);
                }
            });

            setupTaskSwipeListeners();
        }

        function setupTaskSwipeListeners() {
            document.querySelectorAll('.task-swipe-container').forEach(container => {
                const content = container.querySelector('.task-swipe-content');
                const deleteBg = container.querySelector('.task-delete-bg');
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                container.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                    content.classList.add('swiping');
                    content.classList.remove('snapping');
                }, { passive: true });

                container.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    const diff = startX - currentX;
                    if (diff > 0) {
                        const translateX = Math.min(diff, 150);
                        content.style.transform = `translateX(-${translateX}px)`;
                        deleteBg.classList.add('visible');
                        deleteBg.classList.toggle('ready', diff > 100);
                    }
                }, { passive: true });

                container.addEventListener('touchend', () => {
                    if (!isDragging) return;
                    isDragging = false;
                    content.classList.remove('swiping');
                    content.classList.add('snapping');
                    
                    const diff = startX - currentX;
                    if (diff > 100) {
                        const taskItem = container.closest('.task-item');
                        const taskId = taskItem.dataset.taskId;
                        const categoryId = taskItem.dataset.categoryId || taskItem.dataset.sourceCategory;
                        const groupId = taskItem.dataset.groupId || taskItem.dataset.sourceGroup || '';
                        
                        taskItem.classList.add('poofing');
                        setTimeout(() => deleteTask(categoryId, groupId, taskId), 300);
                    } else {
                        content.style.transform = '';
                        deleteBg.classList.remove('visible', 'ready');
                    }
                });
            });
        }

        function toggleTask(categoryId, groupId, taskId) {
            const cat = categories[categoryId];
            if (!cat) return;

            let task;
            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) task = group.tasks.find(t => t.id === taskId);
            } else {
                task = cat.tasks.find(t => t.id === taskId);
            }

            if (task) {
                task.completed = !task.completed;
                saveToStorage();
                renderCarousel();
            }
        }

        function toggleUrgentTask(taskId, sourceCategoryId, sourceGroupId) {
            toggleTask(sourceCategoryId, sourceGroupId, taskId);
        }

        function updateTaskText(el, categoryId, groupId, taskId) {
            const cat = categories[categoryId];
            if (!cat) return;

            let task;
            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) task = group.tasks.find(t => t.id === taskId);
            } else {
                task = cat.tasks.find(t => t.id === taskId);
            }

            if (task) {
                task.text = el.textContent.trim() || task.text;
                saveToStorage();
            }
        }

        function updateUrgentTaskText(el, taskId, sourceCategoryId, sourceGroupId) {
            updateTaskText(el, sourceCategoryId, sourceGroupId, taskId);
        }

        function deleteTask(categoryId, groupId, taskId) {
            const cat = categories[categoryId];
            if (!cat) return;

            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) group.tasks = group.tasks.filter(t => t.id !== taskId);
            } else {
                cat.tasks = cat.tasks.filter(t => t.id !== taskId);
            }

            saveToStorage();
            renderCarousel();
        }

        function updateCategoryName(el, categoryId) {
            const cat = categories[categoryId];
            if (cat) {
                cat.name = el.textContent.trim() || cat.name;
                saveToStorage();
            }
        }

        function updateGroupName(el, categoryId, groupId) {
            const cat = categories[categoryId];
            if (cat && cat.groups) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) {
                    group.name = el.textContent.trim() || group.name;
                    saveToStorage();
                }
            }
        }

        function updateStepText(el, categoryId, groupId, taskId, stepIndex) {
            const cat = categories[categoryId];
            if (!cat) return;

            let task;
            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) task = group.tasks.find(t => t.id === taskId);
            } else {
                task = cat.tasks.find(t => t.id === taskId);
            }

            if (task && task.steps && task.steps[stepIndex]) {
                task.steps[stepIndex].text = el.textContent.trim();
                saveToStorage();
            }
        }

        function removeStep(categoryId, groupId, taskId, stepIndex) {
            const cat = categories[categoryId];
            if (!cat) return;

            let task;
            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) task = group.tasks.find(t => t.id === taskId);
            } else {
                task = cat.tasks.find(t => t.id === taskId);
            }

            if (task && task.steps) {
                task.steps.splice(stepIndex, 1);
                saveToStorage();
                renderCarousel();
            }
        }

        // Modal functions
        function openAddTaskModal(categoryId, groupId = null) {
            currentEditingCategoryId = categoryId;
            currentEditingTaskId = groupId;
            document.getElementById('newTaskText').value = '';
            document.getElementById('newTaskPriority').value = '';
            document.getElementById('addTaskModal').classList.add('show');
            setTimeout(() => document.getElementById('newTaskText').focus(), 100);
        }

        function openAddTaskModalForCurrentCategory() {
            const currentCatId = categoryOrder[currentCategoryIndex];
            if (currentCatId === 'urgent') {
                if (categoryOrder.length > 1) openAddTaskModal(categoryOrder[1]);
            } else {
                openAddTaskModal(currentCatId);
            }
        }

        function closeAddModal() {
            document.getElementById('addTaskModal').classList.remove('show');
            currentEditingCategoryId = null;
            currentEditingTaskId = null;
        }

        function addNewTask() {
            const text = document.getElementById('newTaskText').value.trim();
            const priority = document.getElementById('newTaskPriority').value;
            if (!text || !currentEditingCategoryId) return;

            const cat = categories[currentEditingCategoryId];
            if (!cat) return;

            const newTask = { id: generateId(), text, completed: false, priority: priority || null, steps: [] };

            if (currentEditingTaskId) {
                const group = cat.groups.find(g => g.id === currentEditingTaskId);
                if (group) group.tasks.push(newTask);
            } else {
                cat.tasks.push(newTask);
            }

            saveToStorage();
            renderCarousel();
            closeAddModal();
        }

        function openGroupModal(categoryId) {
            currentEditingCategoryId = categoryId;
            document.getElementById('newGroupName').value = '';
            document.getElementById('addGroupModal').classList.add('show');
            setTimeout(() => document.getElementById('newGroupName').focus(), 100);
        }

        function closeGroupModal() {
            document.getElementById('addGroupModal').classList.remove('show');
            currentEditingCategoryId = null;
        }

        function addNewGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name || !currentEditingCategoryId) return;

            const cat = categories[currentEditingCategoryId];
            if (!cat) return;
            if (!cat.groups) cat.groups = [];

            cat.groups.push({ id: generateId(), name, tasks: [] });
            saveToStorage();
            renderCarousel();
            closeGroupModal();
        }

        function confirmDeleteGroup(categoryId, groupId) {
            showConfirmModal('Delete Group?', 'This will delete the group and all its tasks.', () => {
                const cat = categories[categoryId];
                if (cat && cat.groups) {
                    cat.groups = cat.groups.filter(g => g.id !== groupId);
                    saveToStorage();
                    renderCarousel();
                }
            });
        }

        function openStepsModal(categoryId, groupId, taskId) {
            currentEditingCategoryId = categoryId;
            currentEditingTaskId = taskId;
            
            const cat = categories[categoryId];
            let task;
            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) task = group.tasks.find(t => t.id === taskId);
            } else {
                task = cat.tasks.find(t => t.id === taskId);
            }

            if (!task) return;

            const container = document.getElementById('stepsListContainer');
            container.innerHTML = '';
            container.dataset.groupId = groupId || '';

            if (task.steps && task.steps.length > 0) {
                task.steps.forEach((step, idx) => addStepInputRow(idx + 1, step.text));
            } else {
                addStepInputRow(1, '');
            }

            document.getElementById('addStepsModal').classList.add('show');
        }

        function closeStepsModal() {
            document.getElementById('addStepsModal').classList.remove('show');
            currentEditingCategoryId = null;
            currentEditingTaskId = null;
        }

        function addStepInputRow(num, text = '') {
            const container = document.getElementById('stepsListContainer');
            const row = document.createElement('div');
            row.className = 'step-input-row';
            row.innerHTML = `
                <span class="step-number-badge">${num}</span>
                <input type="text" class="step-input" value="${text}" placeholder="Step ${num}...">
                <button type="button" class="step-remove-btn" onclick="removeStepRow(this)">×</button>
            `;
            container.appendChild(row);
        }

        function addStepInput() {
            const container = document.getElementById('stepsListContainer');
            addStepInputRow(container.children.length + 1, '');
            container.lastElementChild.querySelector('.step-input').focus();
        }

        function removeStepRow(btn) {
            btn.closest('.step-input-row').remove();
            renumberSteps();
        }

        function renumberSteps() {
            document.querySelectorAll('#stepsListContainer .step-input-row').forEach((row, idx) => {
                row.querySelector('.step-number-badge').textContent = idx + 1;
                row.querySelector('.step-input').placeholder = `Step ${idx + 1}...`;
            });
        }

        function saveStepsFromModal() {
            const container = document.getElementById('stepsListContainer');
            const groupId = container.dataset.groupId;
            const steps = [];

            container.querySelectorAll('.step-input').forEach(input => {
                const text = input.value.trim();
                if (text) steps.push({ text, completed: false });
            });

            const cat = categories[currentEditingCategoryId];
            let task;
            if (groupId) {
                const group = cat.groups.find(g => g.id === groupId);
                if (group) task = group.tasks.find(t => t.id === currentEditingTaskId);
            } else {
                task = cat.tasks.find(t => t.id === currentEditingTaskId);
            }

            if (task) {
                task.steps = steps;
                saveToStorage();
                renderCarousel();
            }
            closeStepsModal();
        }

        function openManageCategoriesModal() {
            renderManageCategoriesList();
            document.getElementById('manageCategoriesModal').classList.add('show');
        }

        function closeManageCategoriesModal() {
            document.getElementById('manageCategoriesModal').classList.remove('show');
        }

        function renderManageCategoriesList() {
            const list = document.getElementById('manageCategoriesList');
            list.innerHTML = '';

            categoryOrder.forEach(catId => {
                const cat = categories[catId];
                if (!cat) return;

                const item = document.createElement('div');
                item.className = 'manage-category-item' + (cat.isVirtual ? ' urgent-item' : '');
                item.innerHTML = `
                    <span class="manage-category-name">${cat.name}</span>
                    ${!cat.isVirtual ? `<button class="manage-category-delete" onclick="confirmDeleteCategory('${cat.id}')">×</button>` : ''}
                `;
                list.appendChild(item);
            });
        }

        function confirmDeleteCategory(categoryId) {
            const cat = categories[categoryId];
            showConfirmModal('Delete Category?', `This will permanently delete "${cat.name}" and all its tasks.`, () => {
                delete categories[categoryId];
                categoryOrder = categoryOrder.filter(id => id !== categoryId);
                if (currentCategoryIndex >= categoryOrder.length) {
                    currentCategoryIndex = Math.max(0, categoryOrder.length - 1);
                }
                saveToStorage();
                renderCarousel();
                renderManageCategoriesList();
            });
        }

        function openAddCategoryModal() {
            document.getElementById('newCategoryName').value = '';
            document.getElementById('addCategoryModal').classList.add('show');
            setTimeout(() => document.getElementById('newCategoryName').focus(), 100);
        }

        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('show');
        }

        function addNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) return;

            const id = generateId();
            categories[id] = { id, name, tasks: [], groups: [] };
            categoryOrder.push(id);

            saveToStorage();
            renderCarousel();
            renderManageCategoriesList();
            closeAddCategoryModal();
        }

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal(confirmed) {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmed && confirmCallback) confirmCallback();
            confirmCallback = null;
        }

        function confirmStartOver() {
            showConfirmModal('Start Over?', 'This will delete ALL your data.', () => {
                localStorage.removeItem('mylist-data');
                categories = JSON.parse(JSON.stringify(defaultData.categories));
                categoryOrder = [...defaultData.categoryOrder];
                currentCategoryIndex = 0;
                saveToStorage();
                renderCarousel();
                closeManageCategoriesModal();
            });
        }

        function showWelcomeModal() {
            document.getElementById('welcomeModal').classList.add('show');
        }

        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.remove('show');
            isFirstTimeUser = false;
        }

        function welcomePhotoImport() {
            closeWelcomeModal();
            openPhotoImportModal();
        }

        function welcomeUseTemplates() {
            categories = JSON.parse(JSON.stringify(defaultData.categories));
            categoryOrder = [...defaultData.categoryOrder];
            saveToStorage();
            renderCarousel();
            closeWelcomeModal();
        }

        function welcomeStartFresh() {
            categories = { 'urgent': { id: 'urgent', name: 'Urgent', tasks: [], isVirtual: true } };
            categoryOrder = ['urgent'];
            saveToStorage();
            renderCarousel();
            closeWelcomeModal();
            openAddCategoryModal();
        }

        // Export functions
        function openExportModal() {
            document.getElementById('exportMessage').className = 'export-message';
            document.getElementById('importMessage').className = 'export-message';
            document.getElementById('importTextarea').value = '';
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify({ categories, categoryOrder }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `mylist-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showExportMessage('Downloaded', 'success');
        }

        function downloadText() {
            let text = 'MYLIST\n' + '='.repeat(40) + '\n\n';
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                text += `${cat.name.toUpperCase()}\n` + '-'.repeat(30) + '\n';
                cat.tasks.forEach(task => {
                    text += `  ${task.completed ? '✓' : '○'} ${task.text}${task.priority ? ` [${task.priority}]` : ''}\n`;
                    if (task.steps) task.steps.forEach((s, i) => text += `      ${i+1}. ${s.text}\n`);
                });
                if (cat.groups) cat.groups.forEach(g => {
                    text += `\n  ${g.name}\n`;
                    g.tasks.forEach(t => text += `    ${t.completed ? '✓' : '○'} ${t.text}\n`);
                });
                text += '\n';
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([text], { type: 'text/plain' }));
            a.download = `mylist-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            showExportMessage('Downloaded', 'success');
        }

        function exportToAppleNotes() {
            let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MyList//EN\n';
            const dateStr = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                const allTasks = [...cat.tasks, ...(cat.groups || []).flatMap(g => g.tasks)];
                allTasks.filter(t => !t.completed).forEach(task => {
                    ics += `BEGIN:VTODO\nUID:${generateId()}@mylist\nDTSTAMP:${dateStr}\nSUMMARY:${task.text}\nCATEGORIES:${cat.name}\n`;
                    if (task.priority === 'urgent') ics += 'PRIORITY:1\n';
                    else if (task.priority === 'high') ics += 'PRIORITY:3\n';
                    ics += 'END:VTODO\n';
                });
            });
            ics += 'END:VCALENDAR';
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([ics], { type: 'text/calendar' }));
            a.download = `mylist-${new Date().toISOString().split('T')[0]}.ics`;
            a.click();
            showExportMessage('Downloaded', 'success');
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(JSON.stringify({ categories, categoryOrder }, null, 2))
                .then(() => showExportMessage('Copied', 'success'))
                .catch(() => showExportMessage('Failed', 'error'));
        }

        function showExportMessage(msg, type) {
            const el = document.getElementById('exportMessage');
            el.textContent = msg;
            el.className = 'export-message ' + type;
        }

        function showImportMessage(msg, type) {
            const el = document.getElementById('importMessage');
            el.textContent = msg;
            el.className = 'export-message ' + type;
        }

        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.categories && data.categoryOrder) {
                        categories = data.categories;
                        categoryOrder = data.categoryOrder;
                        if (!categories['urgent']) categories['urgent'] = { id: 'urgent', name: 'Urgent', tasks: [], isVirtual: true };
                        if (!categoryOrder.includes('urgent')) categoryOrder.unshift('urgent');
                        saveToStorage();
                        renderCarousel();
                        showImportMessage('Imported', 'success');
                    } else {
                        showImportMessage('Invalid format', 'error');
                    }
                } catch { showImportMessage('Parse error', 'error'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function importFromText() {
            const text = document.getElementById('importTextarea').value.trim();
            if (!text) { showImportMessage('Paste JSON', 'error'); return; }
            try {
                const data = JSON.parse(text);
                if (data.categories && data.categoryOrder) {
                    categories = data.categories;
                    categoryOrder = data.categoryOrder;
                    if (!categories['urgent']) categories['urgent'] = { id: 'urgent', name: 'Urgent', tasks: [], isVirtual: true };
                    if (!categoryOrder.includes('urgent')) categoryOrder.unshift('urgent');
                    saveToStorage();
                    renderCarousel();
                    showImportMessage('Imported', 'success');
                    document.getElementById('importTextarea').value = '';
                } else { showImportMessage('Invalid format', 'error'); }
            } catch { showImportMessage('Parse error', 'error'); }
        }

        // Photo import
        function openPhotoImportModal() {
            const savedKey = localStorage.getItem('claude-api-key');
            if (savedKey) {
                document.getElementById('claudeApiKey').value = savedKey;
                document.getElementById('apiKeySaved').style.display = 'block';
            }
            resetPhotoImportModal();
            document.getElementById('photoImportModal').classList.add('show');
        }

        function closePhotoImportModal() {
            document.getElementById('photoImportModal').classList.remove('show');
            resetPhotoImportModal();
        }

        function resetPhotoImportModal() {
            selectedPhotos = [];
            parsedImportData = null;
            isEditMode = false;
            document.getElementById('photoUploadArea').classList.remove('has-image');
            document.getElementById('photoUploadIcon').style.display = 'block';
            document.getElementById('photoUploadText').textContent = 'Click to select photos';
            document.getElementById('photoPreviewsContainer').innerHTML = '';
            document.getElementById('addMorePhotosBtn').style.display = 'none';
            document.getElementById('processingIndicator').classList.remove('show');
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('importPreview').innerHTML = '';
            document.getElementById('importError').classList.remove('show');
            document.getElementById('importSuccess').classList.remove('show');
            document.getElementById('processPhotoBtn').style.display = 'none';
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('importModeSection').style.display = 'block';
        }

        function setImportMode(mode) {
            importMode = mode;
            document.getElementById('importModeAdd').classList.toggle('active', mode === 'add');
            document.getElementById('importModeReplace').classList.toggle('active', mode === 'replace');
        }

        function handlePhotoSelect(event) {
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedPhotos.push({ file, dataUrl: e.target.result });
                    updatePhotoPreview();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        }

        function updatePhotoPreview() {
            const container = document.getElementById('photoPreviewsContainer');
            container.innerHTML = '';
            if (selectedPhotos.length > 0) {
                document.getElementById('photoUploadArea').classList.add('has-image');
                document.getElementById('photoUploadIcon').style.display = 'none';
                document.getElementById('photoUploadText').textContent = `${selectedPhotos.length} PHOTO${selectedPhotos.length > 1 ? 'S' : ''}`;
                document.getElementById('addMorePhotosBtn').style.display = 'block';
                document.getElementById('processPhotoBtn').style.display = 'block';
                selectedPhotos.forEach((photo, i) => {
                    const item = document.createElement('div');
                    item.className = 'photo-preview-item';
                    item.innerHTML = `<img src="${photo.dataUrl}"><button class="photo-preview-remove" onclick="removePhoto(${i})">×</button>`;
                    container.appendChild(item);
                });
            } else {
                document.getElementById('photoUploadArea').classList.remove('has-image');
                document.getElementById('photoUploadIcon').style.display = 'block';
                document.getElementById('photoUploadText').textContent = 'Click to select photos';
                document.getElementById('addMorePhotosBtn').style.display = 'none';
                document.getElementById('processPhotoBtn').style.display = 'none';
            }
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }

        async function processPhoto() {
            const apiKey = document.getElementById('claudeApiKey').value.trim();
            if (!apiKey) { showImportError('Enter API key'); return; }
            if (selectedPhotos.length === 0) { showImportError('Select photos'); return; }

            localStorage.setItem('claude-api-key', apiKey);
            document.getElementById('apiKeySaved').style.display = 'block';
            document.getElementById('processingIndicator').classList.add('show');
            document.getElementById('processPhotoBtn').style.display = 'none';
            document.getElementById('importError').classList.remove('show');

            try {
                const imageContents = selectedPhotos.map(p => ({
                    type: 'image',
                    source: { type: 'base64', media_type: p.file.type, data: p.dataUrl.split(',')[1] }
                }));

                const existingCategories = categoryOrder.filter(id => id !== 'urgent').map(id => categories[id]?.name).filter(Boolean);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4096,
                        messages: [{
                            role: 'user',
                            content: [...imageContents, {
                                type: 'text',
                                text: `Extract tasks from this image. Existing categories: ${existingCategories.join(', ') || 'None'}. Return ONLY JSON: {"categories":[{"name":"Name","isExisting":true/false,"tasks":[{"text":"Task","priority":"urgent/high/medium/null"}]}]}`
                            }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Parse error');

                parsedImportData = JSON.parse(jsonMatch[0]);
                document.getElementById('processingIndicator').classList.remove('show');
                document.getElementById('importModeSection').style.display = 'none';
                renderImportPreview();
            } catch (error) {
                document.getElementById('processingIndicator').classList.remove('show');
                document.getElementById('processPhotoBtn').style.display = 'block';
                showImportError(error.message);
            }
        }

        function showImportError(msg) {
            const el = document.getElementById('importError');
            el.textContent = msg;
            el.classList.add('show');
        }

        function renderImportPreview() {
            const preview = document.getElementById('importPreview');
            let html = `<div class="import-preview-header"><span class="import-preview-title">TASKS TO IMPORT</span><button type="button" class="import-edit-toggle ${isEditMode ? 'active' : ''}" onclick="toggleEditMode()">EDIT</button></div>`;

            const newCats = parsedImportData.categories.filter(c => !c.isExisting);
            if (newCats.length > 0) {
                html += '<div class="new-categories-section"><div class="new-categories-header">NEW CATEGORIES</div>';
                newCats.forEach((cat, idx) => {
                    html += `<div class="new-category-item"><input type="text" class="new-category-name-input" value="${cat.name}" onchange="updateNewCategoryName(${idx}, this.value)"><span class="new-category-count">${cat.tasks.length} TASKS</span><button type="button" class="new-category-delete" onclick="removeNewCategory(${idx})">×</button></div>`;
                });
                html += '</div>';
            }

            parsedImportData.categories.forEach((cat, catIdx) => {
                html += `<div class="import-category"><div class="import-category-title">${cat.name}</div><ul class="import-task-list">`;
                cat.tasks.forEach((task, taskIdx) => {
                    html += `<li class="import-task-item"><input type="text" class="import-task-text ${isEditMode ? 'editable' : ''}" value="${task.text}" ${isEditMode ? '' : 'readonly'} onchange="updateImportTask(${catIdx}, ${taskIdx}, this.value)"><button type="button" class="import-task-delete ${isEditMode ? 'show' : ''}" onclick="deleteImportTask(${catIdx}, ${taskIdx})">×</button></li>`;
                });
                html += '</ul></div>';
            });

            preview.innerHTML = html;
            preview.classList.add('show');
            document.getElementById('confirmImportBtn').style.display = 'block';
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            renderImportPreview();
        }

        function updateNewCategoryName(index, name) {
            const newCats = parsedImportData.categories.filter(c => !c.isExisting);
            if (newCats[index]) newCats[index].name = name;
        }

        function removeNewCategory(index) {
            const newCats = parsedImportData.categories.filter(c => !c.isExisting);
            parsedImportData.categories = parsedImportData.categories.filter(c => c !== newCats[index]);
            renderImportPreview();
        }

        function updateImportTask(catIdx, taskIdx, text) {
            if (parsedImportData.categories[catIdx]?.tasks[taskIdx]) {
                parsedImportData.categories[catIdx].tasks[taskIdx].text = text;
            }
        }

        function deleteImportTask(catIdx, taskIdx) {
            if (parsedImportData.categories[catIdx]?.tasks) {
                parsedImportData.categories[catIdx].tasks.splice(taskIdx, 1);
                renderImportPreview();
            }
        }

        function confirmPhotoImport() {
            if (!parsedImportData) return;

            if (importMode === 'replace') {
                Object.keys(categories).forEach(id => { if (id !== 'urgent') delete categories[id]; });
                categoryOrder = categoryOrder.filter(id => id === 'urgent');
            }

            parsedImportData.categories.forEach(importCat => {
                if (importCat.isExisting) {
                    const existingId = categoryOrder.find(id => categories[id]?.name === importCat.name);
                    if (existingId) {
                        importCat.tasks.forEach(task => {
                            categories[existingId].tasks.push({ id: generateId(), text: task.text, completed: false, priority: task.priority || null, steps: [] });
                        });
                    }
                } else {
                    const newId = generateId();
                    categories[newId] = {
                        id: newId,
                        name: importCat.name,
                        tasks: importCat.tasks.map(t => ({ id: generateId(), text: t.text, completed: false, priority: t.priority || null, steps: [] })),
                        groups: []
                    };
                    categoryOrder.push(newId);
                }
            });

            saveToStorage();
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('importSuccess').classList.add('show');
            setTimeout(() => { closePhotoImportModal(); renderCarousel(); }, 1500);
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') navigateCarousel(-1);
            else if (e.key === 'ArrowRight') navigateCarousel(1);
            else if (e.key === 'Escape') {
                if (document.getElementById('welcomeModal').classList.contains('show') && !isFirstTimeUser) closeWelcomeModal();
                else if (document.getElementById('confirmModal').classList.contains('show')) closeConfirmModal(false);
                else if (document.getElementById('addCategoryModal').classList.contains('show')) closeAddCategoryModal();
                else if (document.getElementById('manageCategoriesModal').classList.contains('show')) closeManageCategoriesModal();
                else if (document.getElementById('addTaskModal').classList.contains('show')) closeAddModal();
                else if (document.getElementById('addGroupModal').classList.contains('show')) closeGroupModal();
                else if (document.getElementById('addStepsModal').classList.contains('show')) closeStepsModal();
                else if (document.getElementById('photoImportModal').classList.contains('show')) closePhotoImportModal();
                else if (document.getElementById('exportModal').classList.contains('show')) closeExportModal();
            }
        });

        document.getElementById('newTaskText').addEventListener('keydown', (e) => { if (e.key === 'Enter') addNewTask(); });
        document.getElementById('newGroupName').addEventListener('keydown', (e) => { if (e.key === 'Enter') addNewGroup(); });
        document.getElementById('newCategoryName').addEventListener('keydown', (e) => { if (e.key === 'Enter') addNewCategory(); });

        document.getElementById('addTaskModal').addEventListener('click', (e) => { if (e.target.id === 'addTaskModal') closeAddModal(); });
        document.getElementById('addGroupModal').addEventListener('click', (e) => { if (e.target.id === 'addGroupModal') closeGroupModal(); });
        document.getElementById('addStepsModal').addEventListener('click', (e) => { if (e.target.id === 'addStepsModal') closeStepsModal(); });
        document.getElementById('photoImportModal').addEventListener('click', (e) => { if (e.target.id === 'photoImportModal') closePhotoImportModal(); });
        document.getElementById('exportModal').addEventListener('click', (e) => { if (e.target.id === 'exportModal') closeExportModal(); });
        document.getElementById('manageCategoriesModal').addEventListener('click', (e) => { if (e.target.id === 'manageCategoriesModal') closeManageCategoriesModal(); });
        document.getElementById('addCategoryModal').addEventListener('click', (e) => { if (e.target.id === 'addCategoryModal') closeAddCategoryModal(); });
        document.getElementById('confirmModal').addEventListener('click', (e) => { if (e.target.id === 'confirmModal') closeConfirmModal(false); });
        document.getElementById('welcomeModal').addEventListener('click', (e) => { if (e.target.id === 'welcomeModal' && !isFirstTimeUser) closeWelcomeModal(); });

        // Initialize
        function init() {
            const hasData = loadFromStorage();
            if (!hasData) {
                isFirstTimeUser = true;
                showWelcomeModal();
                categories = JSON.parse(JSON.stringify(defaultData.categories));
                categoryOrder = [...defaultData.categoryOrder];
            }
            renderCarousel();
        }

        init();
    </script>
</body>
</html>
