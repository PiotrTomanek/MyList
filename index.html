<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyList ✨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Global button reset for touch devices */
        button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:focus {
            outline: none;
        }
        
        /* Prevent sticky hover on touch devices */
        @media (hover: none) {
            button:hover {
                background: inherit;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #0a0e27;
            color: #ffffff;
            min-height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-text-size-adjust: 100%;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        }

        /* Ripple effect - subtle and elegant */
        .ripple {
            position: absolute;
            border: 1px solid rgba(255, 182, 193, 0.25);
            border-radius: 50%;
            pointer-events: none;
            animation: ripple-expand 8s ease-out forwards;
        }

        @keyframes ripple-expand {
            0% {
                width: 0;
                height: 0;
                opacity: 0.6;
                border-width: 3px;
            }
            50% {
                opacity: 0.3;
                border-width: 2px;
            }
            100% {
                width: 600px;
                height: 600px;
                opacity: 0;
                border-width: 1px;
            }
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
            padding: 15px 30px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #FFB6C1, #FFDAB9, #D8BFD8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-left .tagline {
            font-size: 0.85rem;
            color: #D8BFD8;
            opacity: 0.8;
        }

        /* Header Action Buttons */
        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.15), rgba(216, 191, 216, 0.15));
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-action-btn:hover {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.25), rgba(216, 191, 216, 0.25));
            border-color: #FFB6C1;
            transform: scale(1.05);
        }

        .header-action-btn .action-icon {
            font-size: 1.3rem;
        }

        /* Photo Import Modal */
        .modal-photo {
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .modal-photo .modal-buttons {
            position: sticky;
            bottom: 0;
            background: linear-gradient(to top, rgba(26, 31, 58, 1) 80%, rgba(26, 31, 58, 0));
            padding-top: 15px;
            margin-top: auto;
        }

        .api-key-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .api-key-section label {
            display: block;
            color: #D8BFD8;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .api-key-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 16px; /* Prevents iOS zoom on focus */
        }

        .api-key-input::placeholder {
            color: rgba(216, 191, 216, 0.5);
        }

        .api-key-saved {
            color: #90EE90;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .photo-upload-area {
            border: 2px dashed rgba(255, 182, 193, 0.4);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .photo-upload-area:hover {
            border-color: #FFB6C1;
            background: rgba(255, 182, 193, 0.05);
        }

        .photo-upload-area.has-image {
            padding: 10px;
        }

        .photo-upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .photo-upload-text {
            color: #D8BFD8;
            font-size: 0.95rem;
        }

        .photo-upload-hint {
            color: rgba(216, 191, 216, 0.6);
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .photo-previews-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
            padding: 10px;
        }
        
        .photo-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid rgba(255, 182, 193, 0.3);
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .photo-preview-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 28px;
            height: 28px;
            background: #FF6B6B;
            border: 2px solid rgba(10, 14, 39, 0.95);
            border-radius: 50%;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.5);
            transition: all 0.2s ease;
        }
        
        .photo-preview-remove:hover {
            transform: scale(1.15);
            background: #FF5252;
        }
        
        .photo-preview-remove:active {
            transform: scale(0.95);
        }
        
        .add-more-photos-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255, 182, 193, 0.1);
            border: 1px dashed rgba(255, 182, 193, 0.4);
            border-radius: 8px;
            color: #FFB6C1;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        .add-more-photos-btn:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            display: none;
        }

        .photo-preview.show {
            display: block;
        }

        .processing-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .processing-indicator.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 182, 193, 0.2);
            border-top-color: #FFB6C1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            color: #D8BFD8;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        /* Import Preview */
        .import-preview {
            display: none;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .import-preview.show {
            display: block;
        }
        
        .import-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
        }
        
        .import-preview-title {
            color: #D8BFD8;
            font-size: 0.9rem;
        }
        
        .import-edit-toggle {
            background: transparent;
            border: 1px solid rgba(255, 182, 193, 0.4);
            color: #FFB6C1;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .import-edit-toggle:hover {
            background: rgba(255, 182, 193, 0.1);
        }
        
        .import-edit-toggle.active {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
        }

        .import-category {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 182, 193, 0.08);
            border-radius: 10px;
            border-left: 3px solid #FFB6C1;
        }

        .import-category-title {
            font-weight: 600;
            color: #FFB6C1;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .import-task-list {
            list-style: none;
        }

        .import-task-item {
            padding: 10px 0;
            color: #fff;
            font-size: 0.9rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.1);
        }
        
        .import-task-item:last-child {
            border-bottom: none;
        }

        .import-task-text {
            flex: 1 1 100%;
            min-width: 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 182, 193, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 16px; /* Prevents iOS zoom on focus */
            padding: 10px 12px;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .import-task-text:focus {
            border-color: #FFB6C1;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .import-task-text.editable {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 182, 193, 0.4);
        }
        
        .import-task-text.editable:focus {
            border-color: #FFB6C1;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .import-task-category-select {
            flex: 1 1 auto;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 6px;
            color: #D8BFD8;
            font-size: 16px; /* Prevents iOS zoom */
            padding: 8px 10px;
            cursor: pointer;
            display: none;
            min-width: 0;
            max-width: none;
        }
        
        .import-task-category-select.show {
            display: block;
        }
        
        .import-task-delete {
            background: rgba(255, 107, 107, 0.15);
            border: none;
            color: #FF6B6B;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            display: none;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .import-task-delete.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .import-task-delete:hover, .import-task-delete:active {
            background: rgba(255, 107, 107, 0.3);
            color: #FF6B6B;
        }

        /* Export/Import Data Modal */
        .modal-export {
            max-width: 500px;
        }
        
        .export-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }
        
        .export-section-title {
            color: #FFB6C1;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .export-section-desc {
            color: #D8BFD8;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }
        
        .export-btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px 15px;
            background: rgba(255, 182, 193, 0.1);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .export-action-btn:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
        }
        
        .import-file-input {
            display: none;
        }
        
        .export-textarea {
            width: 100%;
            height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #fff;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 10px;
            resize: none;
            margin-top: 10px;
        }
        
        .export-textarea::placeholder {
            color: rgba(216, 191, 216, 0.5);
        }
        
        .export-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            display: none;
        }
        
        .export-message.success {
            display: block;
            background: rgba(144, 238, 144, 0.1);
            color: #90EE90;
        }
        
        .export-message.error {
            display: block;
            background: rgba(255, 107, 107, 0.1);
            color: #FF6B6B;
        }
        
        .export-hint {
            font-size: 0.75rem;
            color: rgba(216, 191, 216, 0.7);
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 6px;
            border-left: 3px solid rgba(255, 182, 193, 0.3);
        }
        
        .apple-notes-btn {
            background: rgba(255, 149, 0, 0.15) !important;
            border-color: rgba(255, 149, 0, 0.4) !important;
        }
        
        .apple-notes-btn:hover {
            background: rgba(255, 149, 0, 0.25) !important;
            border-color: rgba(255, 149, 0, 0.6) !important;
        }

        .import-error {
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .import-error.show {
            display: block;
        }

        .import-success {
            color: #90EE90;
            text-align: center;
            padding: 20px;
            display: none;
        }

        .import-success.show {
            display: block;
        }

        .import-success-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Carousel Container */
        .carousel-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 80px;
            perspective: 2000px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-track {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Card States */
        .category-card {
            position: absolute;
            width: 80%;
            max-width: 900px;
            height: 85%;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            padding: 40px;
            backdrop-filter: blur(10px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Scrollbar styling */
        .category-card::-webkit-scrollbar {
            width: 8px;
        }

        .category-card::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .category-card::-webkit-scrollbar-thumb {
            background: rgba(255, 182, 193, 0.3);
            border-radius: 10px;
        }

        .category-card::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 182, 193, 0.5);
        }

        /* Active Card */
        .category-card.active {
            z-index: 10;
            opacity: 1;
            transform: translateX(0) translateZ(0) scale(1) rotateY(0deg);
            pointer-events: auto;
            filter: blur(0);
        }
        
        /* Swipe hint animation - plays once on first load */
        .category-card.active.swipe-hint {
            animation: swipe-hint-anim 1.5s ease-in-out 1s 1;
        }
        
        @keyframes swipe-hint-anim {
            0%, 100% {
                transform: translateX(0) translateZ(0) scale(1) rotateY(0deg);
            }
            25% {
                transform: translateX(-15px) translateZ(0) scale(1) rotateY(2deg);
            }
            50% {
                transform: translateX(15px) translateZ(0) scale(1) rotateY(-2deg);
            }
            75% {
                transform: translateX(-8px) translateZ(0) scale(1) rotateY(1deg);
            }
        }

        /* Previous Card */
        .category-card.prev {
            z-index: 5;
            opacity: 0.3;
            transform: translateX(-45%) translateZ(-400px) scale(0.7) rotateY(15deg);
            pointer-events: none;
            filter: blur(3px);
        }

        /* Next Card */
        .category-card.next {
            z-index: 5;
            opacity: 0.3;
            transform: translateX(45%) translateZ(-400px) scale(0.7) rotateY(-15deg);
            pointer-events: none;
            filter: blur(3px);
        }

        /* Hidden Cards */
        .category-card.hidden {
            opacity: 0;
            transform: translateX(0) translateZ(-600px) scale(0.5);
            pointer-events: none;
            filter: blur(5px);
        }

        /* Overview Mode (Zoomed Out) - iPhone App Grid Style */
        /* View transition overlay */
        .view-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255, 182, 193, 0.15) 0%, transparent 70%);
            pointer-events: none;
            opacity: 0;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        
        .view-transition-overlay.active {
            animation: view-flash 0.6s ease-out forwards;
        }
        
        @keyframes view-flash {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(2);
            }
        }

        /* Card Header */
        .category-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 182, 193, 0.3);
        }

        .category-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }

        .category-title {
            font-size: 2rem;
            color: #FFDAB9;
            font-weight: 600;
            flex-grow: 1;
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
        }

        .category-title:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .category-title:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .category-count {
            background: rgba(255, 182, 193, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #FFB6C1;
        }

        /* Add Task Button */
        .add-task-btn {
            width: 36px;
            height: 36px;
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.1);
            color: #FFB6C1;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            line-height: 1;
            padding-bottom: 2px;
        }

        .add-task-btn:hover {
            background: rgba(255, 182, 193, 0.3);
            border-color: #FFB6C1;
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.4);
        }

        .category-summary {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 12px;
            font-size: 1.1rem;
            color: #D8BFD8;
            line-height: 1.8;
        }

        /* Task List */
        .task-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .task-item {
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item:hover {
            padding-left: 12px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 10px;
        }

        /* Swipe container */
        .task-swipe-container {
            position: relative;
            touch-action: pan-y pinch-zoom;
            overflow: hidden;
        }

        .task-swipe-content {
            position: relative;
            background: transparent;
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }

        .task-swipe-content.swiping {
            transition: none;
        }
        
        .task-swipe-content.snapping {
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Delete background revealed on swipe */
        .task-delete-bg {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, transparent 30%, rgba(255, 107, 157, 0.15) 70%, rgba(255, 107, 157, 0.35) 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 25px;
            color: #FF6B9D;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 10px;
        }

        .task-delete-bg.visible {
            opacity: 1;
        }
        
        .task-delete-bg.ready {
            background: linear-gradient(90deg, transparent 20%, rgba(255, 107, 157, 0.25) 60%, rgba(255, 107, 157, 0.5) 100%);
        }

        /* Poof Animation - Very subtle fade */
        @keyframes poof {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-30px);
                opacity: 0;
            }
        }

        @keyframes poof-particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        .task-item.poofing {
            animation: poof 0.3s ease-out forwards;
            pointer-events: none;
        }

        .poof-particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            animation: poof-particle 0.4s ease-out forwards;
        }

        /* Swipe hint for completed tasks */
        .swipe-hint {
            font-size: 0.75rem;
            color: rgba(255, 182, 193, 0.5);
            margin-top: 6px;
            font-style: italic;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-item.completed:hover .swipe-hint {
            opacity: 1;
        }
        
        /* Show swipe hint on mobile always for completed tasks */
        @media (max-width: 768px) {
            .task-item.completed .swipe-hint {
                opacity: 0.7;
            }
        }

        .task-main {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            min-width: 22px;
            border: 2px solid #FFB6C1;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
            margin-top: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .task-checkbox:hover {
            background: rgba(255, 182, 193, 0.2);
            transform: scale(1.1);
        }

        .task-checkbox.checked {
            background: rgba(255, 182, 193, 0.6);
        }
        
        .task-checkbox.checked::after {
            content: '✓';
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #ffffff;
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
        }

        .task-text:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .task-text:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .task-meta {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-urgent {
            background: rgba(255, 107, 157, 0.3);
            color: #FF6B9D;
            border: 1px solid #FF6B9D;
        }

        .priority-high {
            background: rgba(255, 107, 157, 0.2);
            color: #FF6B9D;
            border: 1px solid #FF6B9D;
        }

        .priority-medium {
            background: rgba(255, 218, 185, 0.2);
            color: #FFDAB9;
            border: 1px solid #FFDAB9;
        }

        .time-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: rgba(216, 191, 216, 0.2);
            color: #D8BFD8;
            border: 1px solid #D8BFD8;
        }

        .subtask-toggle {
            margin-top: 12px;
            color: #D8BFD8;
            font-size: 0.9rem;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            user-select: none;
            padding: 6px 10px;
            border-radius: 6px;
            display: inline-block;
            background: rgba(255, 182, 193, 0.05);
        }

        .subtask-toggle:hover {
            opacity: 1;
            color: #FFB6C1;
            background: rgba(255, 182, 193, 0.15);
        }
        
        .subtask-toggle:active {
            transform: scale(0.98);
        }

        .subtask-list {
            margin-top: 15px;
            margin-left: 35px;
            padding-left: 20px;
            border-left: 3px solid rgba(255, 182, 193, 0.3);
        }

        .subtask-item {
            padding: 10px 0;
            font-size: 1rem;
            color: #D8BFD8;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .subtask-number {
            min-width: 28px;
            height: 28px;
            background: rgba(255, 182, 193, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #FFB6C1;
            flex-shrink: 0;
            font-weight: 600;
        }

        .subtask-text {
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
            flex-grow: 1;
        }

        .subtask-text:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .subtask-text:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .subcategory {
            margin-left: 30px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 182, 193, 0.05);
            border-left: 4px solid rgba(255, 182, 193, 0.4);
            border-radius: 10px;
        }

        .subcategory-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .subcategory-title {
            font-size: 1.2rem;
            color: #FFE4C4;
            font-weight: 600;
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
        }

        .subcategory-title:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .subcategory-title:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .add-subtask-btn {
            width: 28px;
            height: 28px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.1);
            color: #FFB6C1;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            line-height: 1;
        }

        .add-subtask-btn:hover {
            background: rgba(255, 182, 193, 0.3);
            border-color: #FFB6C1;
            transform: scale(1.15) rotate(90deg);
        }
        
        .delete-group-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: rgba(255, 107, 107, 0.5);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
            opacity: 0;
        }
        
        .subcategory:hover .delete-group-btn {
            opacity: 1;
        }
        
        .delete-group-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
            transform: scale(1.1);
        }

        /* Indicator Dots */
        .carousel-indicator {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .carousel-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.3);
            border: 2px solid rgba(255, 182, 193, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: #FFB6C1;
            transform: scale(1.4);
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.6);
        }

        .carousel-dot:hover {
            background: rgba(255, 182, 193, 0.6);
            transform: scale(1.2);
        }

        /* Zoom Controls */
        /* Bottom Right FAB Container */
        .manage-btn-container {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .fab-add-task {
            width: 48px;
            height: 48px;
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.2), rgba(216, 191, 216, 0.2));
            backdrop-filter: blur(10px);
            color: #FFB6C1;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3);
        }
        
        .fab-add-task:hover {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.35), rgba(216, 191, 216, 0.35));
            border-color: #FFB6C1;
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4);
        }
        
        .fab-add-task:active {
            transform: scale(0.95);
        }

        .manage-categories-btn {
            width: 48px;
            height: 48px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 50%;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            color: #FFB6C1;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .manage-categories-btn:hover {
            background: rgba(255, 182, 193, 0.15);
            border-color: #FFB6C1;
            transform: scale(1.1);
        }
        
        .manage-categories-btn:active {
            transform: scale(0.95);
        }
        
        /* Manage Categories Modal */
        .modal-manage {
            max-width: 400px;
        }
        
        .modal-subtitle {
            color: #D8BFD8;
            font-size: 0.8rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .manage-categories-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .manage-category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255, 182, 193, 0.05);
            border: 1px solid rgba(255, 182, 193, 0.15);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .manage-category-item.urgent-item {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .manage-category-icon {
            font-size: 1.2rem;
        }
        
        .manage-category-name {
            flex: 1;
            color: #fff;
            font-size: 0.85rem;
        }
        
        .manage-category-delete {
            background: transparent;
            border: none;
            color: rgba(255, 107, 107, 0.6);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .manage-category-delete:hover {
            background: rgba(255, 107, 107, 0.1);
            color: #FF6B6B;
        }
        
        .add-category-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 182, 193, 0.1);
            border: 1px dashed rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #FFB6C1;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        
        .add-category-btn:hover {
            background: rgba(255, 182, 193, 0.15);
            border-color: #FFB6C1;
        }

        /* Save indicator - hidden but functional */
        .save-indicator {
            display: none;
        }

        /* Add Task Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            animation: modal-pop 0.3s ease-out;
        }

        @keyframes modal-pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal h2 {
            color: #FFDAB9;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 16px; /* Prevents iOS zoom on focus */
            outline: none;
            margin-bottom: 15px;
        }

        .modal-input:focus {
            border-color: #FFB6C1;
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.2);
        }

        .modal-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .modal-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-select {
            flex: 1;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 16px; /* Prevents iOS zoom */
            outline: none;
            cursor: pointer;
        }

        .modal-select option {
            background: #1a1f3a;
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .modal-btn.primary {
            background: rgba(255, 182, 193, 0.3);
            color: #FFB6C1;
        }

        .modal-btn.primary:hover {
            background: rgba(255, 182, 193, 0.5);
            transform: scale(1.02);
        }

        .modal-btn.secondary {
            background: transparent;
            color: #D8BFD8;
        }

        .modal-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .modal-btn.danger {
            background: rgba(255, 107, 107, 0.3);
            color: #FF6B6B;
            border-color: rgba(255, 107, 107, 0.5);
        }
        
        .modal-btn.danger:hover {
            background: rgba(255, 107, 107, 0.5);
            transform: scale(1.02);
        }
        
        /* Confirm Modal Specific Styles */
        .modal-confirm {
            max-width: 360px;
            text-align: center;
        }
        
        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .confirm-message {
            color: #D8BFD8;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        /* Welcome Modal Styles */
        .modal-welcome {
            max-width: 420px;
            text-align: center;
        }
        
        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        
        .welcome-subtitle {
            color: #D8BFD8;
            font-size: 0.95rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .welcome-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .welcome-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: rgba(255, 182, 193, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.2);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .welcome-option:hover {
            background: rgba(255, 182, 193, 0.12);
            border-color: rgba(255, 182, 193, 0.4);
            transform: translateX(5px);
        }
        
        .welcome-option-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .welcome-option-content {
            flex: 1;
        }
        
        .welcome-option-title {
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .welcome-option-desc {
            color: #D8BFD8;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .welcome-option-arrow {
            color: rgba(255, 182, 193, 0.5);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .welcome-option:hover .welcome-option-arrow {
            transform: translateX(5px);
            color: #FFB6C1;
        }
        
        /* Start Over Link */
        .start-over-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 182, 193, 0.15);
        }
        
        .start-over-link {
            background: transparent;
            border: none;
            color: rgba(255, 107, 107, 0.7);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .start-over-link:hover {
            background: rgba(255, 107, 107, 0.1);
            color: #FF6B6B;
        }
        
        /* Photo Import Mode Selection */
        .import-mode-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }
        
        .import-mode-label {
            color: #D8BFD8;
            font-size: 0.85rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .import-mode-options {
            display: flex;
            gap: 10px;
        }
        
        .import-mode-btn {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.2);
            border-radius: 8px;
            color: #D8BFD8;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .import-mode-btn:hover {
            background: rgba(255, 182, 193, 0.1);
            border-color: rgba(255, 182, 193, 0.4);
        }
        
        .import-mode-btn.active {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Steps Modal Specific Styles */
        .modal-steps {
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .steps-list-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        
        .step-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            animation: stepFadeIn 0.2s ease-out;
        }
        
        @keyframes stepFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-number-badge {
            width: 28px;
            height: 28px;
            background: rgba(255, 182, 193, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFB6C1;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .step-input {
            flex: 1;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 16px; /* Prevents iOS zoom on focus */
            outline: none;
            transition: all 0.3s ease;
        }
        
        .step-input:focus {
            border-color: #FFB6C1;
            background: rgba(255, 182, 193, 0.1);
        }
        
        .step-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        .step-remove-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 107, 157, 0.15);
            color: #FF6B9D;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .step-remove-btn:hover {
            background: rgba(255, 107, 157, 0.3);
            transform: scale(1.1);
        }
        
        .add-step-modal-btn {
            padding: 12px;
            background: transparent;
            border: 2px dashed rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #D8BFD8;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .add-step-modal-btn:hover {
            background: rgba(255, 182, 193, 0.1);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Icon Picker */
        .icon-picker-section {
            margin-bottom: 15px;
            position: relative;
        }
        
        .icon-picker-label {
            display: block;
            color: #D8BFD8;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .icon-picker-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .icon-picker-btn:hover {
            border-color: #FFB6C1;
            background: rgba(255, 182, 193, 0.1);
        }
        
        #selectedIconDisplay {
            font-size: 1.8rem;
        }
        
        .icon-picker-arrow {
            color: #D8BFD8;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .icon-picker-btn.open .icon-picker-arrow {
            transform: rotate(180deg);
        }
        
        .icon-picker-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            padding: 12px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            animation: dropdown-appear 0.2s ease-out;
        }
        
        .icon-picker-dropdown.show {
            display: block;
        }
        
        @keyframes dropdown-appear {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .icon-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            background: rgba(255, 182, 193, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-option:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: rgba(255, 182, 193, 0.4);
            transform: scale(1.1);
        }
        
        .icon-option.selected {
            background: rgba(255, 182, 193, 0.3);
            border-color: #FFB6C1;
        }
        
        /* Add Group Button */
        .add-group-btn {
            margin-top: 12px;
            padding: 6px 0;
            background: transparent;
            border: none;
            color: rgba(216, 191, 216, 0.4);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            width: auto;
        }
        
        .add-group-btn:hover {
            color: #FFB6C1;
        }
        
        .add-group-btn .plus-icon {
            font-size: 0.9rem;
            font-weight: 300;
        }
        
        /* Add Steps Button */
        .add-steps-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: transparent;
            border: 1px dashed rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #D8BFD8;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .task-item:hover .add-steps-btn {
            opacity: 1;
        }
        
        .add-steps-btn:hover {
            background: rgba(255, 182, 193, 0.1);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Remove Step Button */
        .remove-step-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: rgba(255, 107, 157, 0.5);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        .subtask-item:hover .remove-step-btn {
            opacity: 1;
        }
        
        .remove-step-btn:hover {
            background: rgba(255, 107, 157, 0.2);
            color: #FF6B9D;
            transform: scale(1.1);
        }
        
        /* Edit Steps Button */
        .edit-steps-btn {
            margin-top: 8px;
            padding: 4px 8px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: rgba(216, 191, 216, 0.5);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            align-self: flex-start;
            letter-spacing: 2px;
        }
        
        .edit-steps-btn:hover {
            background: rgba(255, 182, 193, 0.1);
            color: #FFB6C1;
        }
        
        /* Make subtask item a flex row */
        .subtask-item {
            display: flex;
            align-items: center;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            header {
                padding: 10px 16px;
            }
            
            .header-left h1 {
                font-size: 1.25rem;
            }
            
            .header-left .tagline {
                font-size: 0.65rem;
            }
            
            .header-actions {
                gap: 6px;
            }
            
            .header-action-btn {
                width: 36px;
                height: 36px;
            }
            
            .header-action-btn .action-icon {
                font-size: 1rem;
            }
            
            .modal-photo {
                width: 95%;
                max-width: none;
                padding: 18px;
            }
            
            .carousel-container {
                top: 60px;
            }
            
            .category-card {
                width: 92%;
                max-width: 400px;
                padding: 16px;
                max-height: calc(100vh - 130px);
                border-radius: 10px;
            }
            
            .category-header {
                padding-bottom: 10px;
                margin-bottom: 12px;
            }
            
            .category-icon {
                font-size: 1.4rem;
            }
            
            .category-title {
                font-size: 1.05rem;
            }
            
            .category-count {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            
            .task-item {
                padding: 10px 0;
            }
            
            .task-text {
                font-size: 0.85rem;
                line-height: 1.35;
            }
            
            .task-checkbox {
                width: 18px;
                height: 18px;
                min-width: 18px;
            }
            
            .priority-badge {
                font-size: 0.55rem;
                padding: 2px 5px;
            }
            
            .subcategory-header {
                padding: 8px;
                margin-top: 12px;
            }
            
            .subcategory-icon {
                font-size: 1rem;
            }
            
            .subcategory-name {
                font-size: 0.8rem;
            }
            
            .subtask-toggle {
                font-size: 0.75rem;
                padding: 4px 10px;
            }
            
            .subtask-item {
                font-size: 0.8rem;
            }
            
            .manage-btn-container {
                bottom: 15px;
                right: 12px;
                gap: 10px;
            }
            
            .fab-add-task {
                width: 44px;
                height: 44px;
                font-size: 1.4rem;
            }
            
            .manage-categories-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .carousel-indicator {
                bottom: 15px;
            }
            
            .carousel-dot {
                width: 8px;
                height: 8px;
            }
            
            .add-task-btn {
                width: 30px;
                height: 30px;
                font-size: 1.2rem;
            }
            
            .add-group-btn {
                font-size: 0.7rem;
                padding: 4px 0;
            }
            
            /* Modal adjustments for mobile */
            .modal {
                width: 92%;
                max-width: 340px;
                padding: 20px;
            }
            
            .modal h2 {
                font-size: 1.15rem;
            }
            
            .modal-input {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            /* Make buttons always visible on touch devices */
            .add-steps-btn {
                opacity: 0.7;
                font-size: 0.75rem;
                padding: 6px 10px;
            }
            
            .remove-step-btn {
                opacity: 0.6;
            }
            
            /* Larger touch targets */
            .remove-step-btn {
                width: 26px;
                height: 26px;
                font-size: 1.1rem;
            }
            
            .step-remove-btn {
                width: 32px;
                height: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="background" id="background"></div>
    
    <div class="view-transition-overlay" id="viewTransitionOverlay"></div>

    <div class="save-indicator" id="saveIndicator">✓ Saved</div>

    <header>
        <div class="header-left">
            <h1>MyList</h1>
            <div class="tagline">Organize your life with ease ✨</div>
        </div>
        <div class="header-actions">
            <button class="header-action-btn export-btn" onclick="openExportModal()" title="Export/Import Data">
                <span class="action-icon">📤</span>
            </button>
            <button class="header-action-btn import-btn" onclick="openPhotoModal()" title="Import from Photo">
                <span class="action-icon">📷</span>
            </button>
        </div>
    </header>

    <div class="carousel-container">
        <div class="carousel-track" id="carouselTrack"></div>
    </div>

    <div class="carousel-indicator" id="carouselIndicator"></div>

    <div class="manage-btn-container">
        <button class="fab-add-task" id="fabAddTask" onclick="openAddTaskModalForCurrentCategory()" title="Add New Task">
            <span>+</span>
        </button>
        <button class="manage-categories-btn" id="manageCategoriesBtn" onclick="openManageCategoriesModal()">
            <span>⚙️</span>
        </button>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal">
            <h2>✨ Add New Task</h2>
            <input type="text" class="modal-input" id="newTaskText" placeholder="What needs to be done?">
            <select class="modal-select" id="newTaskPriority" style="width: 100%;">
                <option value="">Priority (optional)</option>
                <option value="urgent">🔥 Urgent</option>
                <option value="high">⚡ High</option>
                <option value="medium">📌 Medium</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAddModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewTask()">Add Task</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div class="modal-overlay" id="manageCategoriesModal">
        <div class="modal modal-manage">
            <h2>⚙️ Manage Categories</h2>
            <p class="modal-subtitle">Add, remove, or reorder your categories</p>
            
            <div class="manage-categories-list" id="manageCategoriesList"></div>
            
            <button class="add-category-btn" onclick="openAddCategoryModal()">+ Add New Category</button>
            
            <div class="start-over-section">
                <button class="start-over-link" onclick="confirmStartOver()">🔄 Start Over</button>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeManageCategoriesModal()">Done</button>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div class="modal-overlay" id="addCategoryModal">
        <div class="modal">
            <h2>✨ Add New Category</h2>
            <input type="text" class="modal-input" id="newCategoryName" placeholder="Category name (e.g., Learning)">
            <div class="icon-picker-section">
                <label class="icon-picker-label">Choose an icon:</label>
                <button class="icon-picker-btn" id="categoryIconPickerBtn" onclick="toggleCategoryIconPicker()">
                    <span id="selectedCategoryIconDisplay">📚</span>
                    <span class="icon-picker-arrow">▼</span>
                </button>
                <div class="icon-picker-dropdown" id="categoryIconPickerDropdown">
                    <div class="icon-picker-grid" id="categoryIconPickerGrid"></div>
                </div>
            </div>
            <input type="hidden" id="newCategoryIcon" value="📚">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAddCategoryModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewCategory()">Add Category</button>
            </div>
        </div>
    </div>
    
    <!-- Add Group Modal -->
    <div class="modal-overlay" id="addGroupModal">
        <div class="modal">
            <h2>📁 Add New Group</h2>
            <input type="text" class="modal-input" id="newGroupName" placeholder="Group name (e.g., Investments)">
            <div class="icon-picker-section">
                <label class="icon-picker-label">Choose an icon:</label>
                <button class="icon-picker-btn" id="iconPickerBtn" onclick="toggleIconPicker()">
                    <span id="selectedIconDisplay">📌</span>
                    <span class="icon-picker-arrow">▼</span>
                </button>
                <div class="icon-picker-dropdown" id="iconPickerDropdown">
                    <div class="icon-picker-grid" id="iconPickerGrid"></div>
                </div>
            </div>
            <input type="hidden" id="newGroupIcon" value="📌">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewGroup()">Add Group</button>
            </div>
        </div>
    </div>
    
    <!-- Add Steps Modal -->
    <div class="modal-overlay" id="addStepsModal">
        <div class="modal modal-steps">
            <h2>📝 Manage Steps</h2>
            <p style="color: #D8BFD8; margin-bottom: 15px; font-size: 0.9rem;">Add steps to break down this task</p>
            <div class="steps-list-container" id="stepsListContainer">
                <!-- Steps will be dynamically added here -->
            </div>
            <button class="add-step-modal-btn" id="addStepBtn" onclick="addStepInput()">+ Add Step</button>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeStepsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveStepsFromModal()">Save Steps</button>
            </div>
        </div>
    </div>

    <!-- Photo Import Modal -->
    <div class="modal-overlay" id="photoImportModal">
        <div class="modal modal-photo">
            <h2>📷 Import from Photo</h2>
            
            <!-- API Key Section -->
            <div class="api-key-section">
                <label>Claude API Key (stored locally in your browser)</label>
                <input type="password" class="api-key-input" id="claudeApiKey" placeholder="sk-ant-api03-...">
                <div class="api-key-saved" id="apiKeySaved" style="display: none;">✓ API key saved</div>
            </div>
            
            <!-- Import Mode Selection -->
            <div class="import-mode-section" id="importModeSection">
                <label class="import-mode-label">What should happen to existing tasks?</label>
                <div class="import-mode-options">
                    <button type="button" class="import-mode-btn active" id="importModeAdd" onclick="setImportMode('add')">
                        ➕ Add to existing
                    </button>
                    <button type="button" class="import-mode-btn" id="importModeReplace" onclick="setImportMode('replace')">
                        🔄 Replace all
                    </button>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                <div class="photo-upload-icon" id="photoUploadIcon">📝</div>
                <div class="photo-upload-text" id="photoUploadText">Click to upload photos of your handwritten notes</div>
                <div class="photo-upload-hint">Supports multiple JPG, PNG • Works best with clear handwriting</div>
                <div class="photo-previews-container" id="photoPreviewsContainer"></div>
            </div>
            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoSelect(event)">
            
            <!-- Add More Photos Button -->
            <button type="button" class="add-more-photos-btn" id="addMorePhotosBtn" onclick="document.getElementById('photoInput').click()" style="display: none;">
                ➕ Add More Photos
            </button>
            
            <!-- Processing Indicator -->
            <div class="processing-indicator" id="processingIndicator">
                <div class="spinner"></div>
                <div class="processing-text" id="processingText">Reading your notes with Claude AI...</div>
            </div>
            
            <!-- Error Message -->
            <div class="import-error" id="importError"></div>
            
            <!-- Import Preview -->
            <div class="import-preview" id="importPreview"></div>
            
            <!-- Success Message -->
            <div class="import-success" id="importSuccess">
                <div class="import-success-icon">✨</div>
                <div>Tasks imported successfully!</div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="modal-btn secondary" onclick="closePhotoModal()">Cancel</button>
                <button type="button" class="modal-btn primary" id="processPhotoBtn" onclick="processPhoto()" style="display: none;">Process Photos</button>
                <button type="button" class="modal-btn secondary" id="editImportBtn" onclick="toggleEditMode()" style="display: none;">✏️ Edit</button>
                <button type="button" class="modal-btn primary" id="confirmImportBtn" onclick="confirmImport()" style="display: none;">✓ Import Tasks</button>
            </div>
        </div>
    </div>
    
    <!-- Export/Import Data Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal modal-export">
            <h2>📤 Export & Import Data</h2>
            
            <!-- Export Section -->
            <div class="export-section">
                <div class="export-section-title">📥 Export Your Data</div>
                <div class="export-section-desc">Download your tasks as a file to backup or share</div>
                <div class="export-btn-row">
                    <button class="export-action-btn" onclick="exportAsJSON()">
                        <span>📄</span> JSON File
                    </button>
                    <button class="export-action-btn" onclick="exportAsText()">
                        <span>📝</span> Text File
                    </button>
                    <button class="export-action-btn" onclick="copyToClipboard()">
                        <span>📋</span> Copy
                    </button>
                </div>
                <div class="export-btn-row" style="margin-top: 10px;">
                    <button class="export-action-btn apple-notes-btn" onclick="exportToAppleNotes()">
                        <span>🍎</span> Apple Notes (.ics)
                    </button>
                </div>
                <div class="export-hint">💡 Import the .ics file into Calendar, then tasks appear as notes in iCloud</div>
                <div class="export-message" id="exportMessage"></div>
            </div>
            
            <!-- Import Section -->
            <div class="export-section">
                <div class="export-section-title">📤 Import Data</div>
                <div class="export-section-desc">Load tasks from a JSON file or paste data</div>
                <div class="export-btn-row">
                    <button class="export-action-btn" onclick="document.getElementById('importFileInput').click()">
                        <span>📁</span> Load File
                    </button>
                </div>
                <input type="file" id="importFileInput" class="import-file-input" accept=".json" onchange="importFromFile(event)">
                <textarea class="export-textarea" id="importTextarea" placeholder="Or paste JSON data here..."></textarea>
                <div class="export-btn-row" style="margin-top: 10px;">
                    <button class="export-action-btn" onclick="importFromText()">
                        <span>📥</span> Import from Text
                    </button>
                </div>
                <div class="export-message" id="importMessage"></div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeExportModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal modal-confirm">
            <div class="confirm-icon" id="confirmIcon">⚠️</div>
            <h2 id="confirmTitle">Confirm Action</h2>
            <p class="confirm-message" id="confirmMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="modal-btn danger" id="confirmActionBtn" onclick="closeConfirmModal(true)">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Welcome Modal -->
    <div class="modal-overlay" id="welcomeModal">
        <div class="modal modal-welcome">
            <div class="welcome-icon">✨</div>
            <h2>Welcome to MyList</h2>
            <p class="welcome-subtitle">How would you like to get started?</p>
            
            <div class="welcome-options">
                <div class="welcome-option" onclick="welcomePhotoImport()">
                    <div class="welcome-option-icon">📸</div>
                    <div class="welcome-option-content">
                        <div class="welcome-option-title">Import from Photo</div>
                        <div class="welcome-option-desc">Snap a photo of your handwritten list</div>
                    </div>
                    <div class="welcome-option-arrow">→</div>
                </div>
                
                <div class="welcome-option" onclick="welcomeUseTemplates()">
                    <div class="welcome-option-icon">📋</div>
                    <div class="welcome-option-content">
                        <div class="welcome-option-title">Start with Templates</div>
                        <div class="welcome-option-desc">Use sample categories as a starting point</div>
                    </div>
                    <div class="welcome-option-arrow">→</div>
                </div>
                
                <div class="welcome-option" onclick="welcomeStartFresh()">
                    <div class="welcome-option-icon">🌟</div>
                    <div class="welcome-option-content">
                        <div class="welcome-option-title">Start Fresh</div>
                        <div class="welcome-option-desc">Create your own categories from scratch</div>
                    </div>
                    <div class="welcome-option-arrow">→</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Default Data
        const defaultData = {
            categories: {
                urgent: {
                    id: 'urgent',
                    name: '⚡ Urgent & Important',
                    icon: '🔥',
                    isVirtual: true,
                    tasks: []
                },
                work: {
                    id: 'work',
                    name: 'Work & Projects',
                    icon: '💼',
                    tasks: [
                        { id: 1, text: 'Complete quarterly report', priority: 'urgent', completed: false },
                        { id: 2, text: 'Schedule team sync meeting', priority: 'high', completed: false },
                        { id: 3, text: 'Review project proposals', priority: 'medium', completed: false }
                    ],
                    subcategories: [
                        {
                            id: 'design',
                            icon: '🎨',
                            name: 'Design Tasks',
                            tasks: [
                                { id: 4, text: 'Update portfolio website', priority: 'medium', completed: false },
                                { id: 5, text: 'Create presentation slides', completed: false }
                            ]
                        }
                    ]
                },
                home: {
                    id: 'home',
                    name: 'Home & Living',
                    icon: '🏠',
                    tasks: [
                        { id: 10, text: 'Grocery shopping', priority: 'high', completed: false },
                        { id: 11, text: 'Clean kitchen', completed: false },
                        { id: 12, text: 'Fix leaky faucet', completed: false }
                    ]
                },
                health: {
                    id: 'health',
                    name: 'Health & Wellness',
                    icon: '💪',
                    tasks: [
                        { id: 20, text: 'Morning workout', priority: 'high', completed: false },
                        { id: 21, text: 'Meal prep for the week', completed: false },
                        { id: 22, text: 'Schedule annual checkup', priority: 'medium', completed: false },
                        { 
                            id: 23, 
                            text: 'Start meditation practice', 
                            completed: false,
                            subtasks: [
                                'Download meditation app',
                                'Set daily reminder for 7am',
                                'Complete 7-day beginner course',
                                'Establish 10-min daily habit'
                            ]
                        }
                    ]
                },
                personal: {
                    id: 'personal',
                    name: 'Personal Growth',
                    icon: '🌱',
                    tasks: [
                        { id: 30, text: 'Read 20 pages daily', completed: false },
                        { id: 31, text: 'Learn new language - practice', priority: 'medium', completed: false },
                        { id: 32, text: 'Journal reflection', completed: false }
                    ]
                },
                social: {
                    id: 'social',
                    name: 'Social & Relationships',
                    icon: '👥',
                    tasks: [
                        { id: 35, text: 'Call mom', priority: 'high', completed: false },
                        { id: 36, text: 'Plan weekend dinner with friends', completed: false }
                    ]
                },
                finance: {
                    id: 'finance',
                    name: 'Finance & Planning',
                    icon: '💰',
                    tasks: [
                        { id: 37, text: 'Review monthly budget', priority: 'urgent', completed: false },
                        { id: 38, text: 'Pay utility bills', priority: 'high', completed: false }
                    ],
                    subcategories: [
                        {
                            id: 'investments',
                            icon: '📈',
                            name: 'Investments',
                            tasks: [
                                { id: 39, text: 'Research investment options', completed: false }
                            ]
                        }
                    ]
                }
            },
            categoryOrder: ['urgent', 'work', 'home', 'health', 'personal', 'social', 'finance']
        };

        // State
        let categories = defaultData.categories;
        let categoryOrder = defaultData.categoryOrder;
        let currentIndex = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let addingToCategory = null;
        let addingToSubcategory = null;
        let nextTaskId = 100;
        let importMode = 'add'; // 'add' or 'replace'
        let isFirstTimeUser = false;

        // Swipe state for tasks
        let swipeState = {};

        // Storage
        function saveToStorage() {
            const data = {
                categories,
                categoryOrder,
                currentIndex,
                nextTaskId,
                hasSeenWelcome: true
            };
            localStorage.setItem('myListData', JSON.stringify(data));
            showSaveIndicator();
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('myListData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    categories = data.categories || categories;
                    categoryOrder = data.categoryOrder || categoryOrder;
                    currentIndex = data.currentIndex || 0;
                    nextTaskId = data.nextTaskId || 100;
                    isFirstTimeUser = !data.hasSeenWelcome;
                } catch (e) {
                    isFirstTimeUser = true;
                }
            } else {
                isFirstTimeUser = true;
            }
        }
        
        // Welcome Modal Functions
        function showWelcomeModal() {
            document.getElementById('welcomeModal').classList.add('show');
        }
        
        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.remove('show');
        }
        
        function welcomePhotoImport() {
            closeWelcomeModal();
            // Set to replace mode for fresh start
            setImportMode('replace');
            openPhotoModal();
        }
        
        function welcomeUseTemplates() {
            closeWelcomeModal();
            // Keep default data
            saveToStorage();
            renderCarousel();
        }
        
        function welcomeStartFresh() {
            closeWelcomeModal();
            // Clear everything except urgent category
            categories = {
                urgent: {
                    id: 'urgent',
                    name: '⚡ Urgent & Important',
                    icon: '🔥',
                    isVirtual: true,
                    tasks: []
                }
            };
            categoryOrder = ['urgent'];
            nextTaskId = 1;
            saveToStorage();
            renderCarousel();
            // Open add category modal to help them get started
            setTimeout(() => {
                openAddCategoryModal();
            }, 300);
        }
        
        async function confirmStartOver() {
            closeManageCategoriesModal();
            
            const confirmed = await showConfirmModal(
                'Start Over?',
                'This will open the welcome screen where you can choose how to set up your list. Your current data will be preserved until you make a choice.',
                '🔄',
                'Continue'
            );
            
            if (confirmed) {
                showWelcomeModal();
            }
        }
        
        // Import Mode Functions
        function setImportMode(mode) {
            importMode = mode;
            document.getElementById('importModeAdd').classList.toggle('active', mode === 'add');
            document.getElementById('importModeReplace').classList.toggle('active', mode === 'replace');
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // Add Task Modal
        function openAddModal(categoryId, subcatId = null) {
            addingToCategory = categoryId;
            addingToSubcategory = subcatId;
            document.getElementById('addTaskModal').classList.add('show');
            document.getElementById('newTaskText').value = '';
            document.getElementById('newTaskPriority').value = '';
            setTimeout(() => document.getElementById('newTaskText').focus(), 100);
        }

        function closeAddModal() {
            document.getElementById('addTaskModal').classList.remove('show');
            addingToCategory = null;
            addingToSubcategory = null;
        }
        
        // Open add task modal for the currently visible category (from FAB)
        function openAddTaskModalForCurrentCategory() {
            const currentCategoryId = categoryOrder[currentIndex];
            if (currentCategoryId) {
                openAddModal(currentCategoryId);
            }
        }

        function addNewTask() {
            const text = document.getElementById('newTaskText').value.trim();
            if (!text) return;

            const priority = document.getElementById('newTaskPriority').value;

            const newTask = {
                id: nextTaskId++,
                text: text,
                completed: false
            };

            if (priority) newTask.priority = priority;

            if (addingToSubcategory) {
                const subcat = categories[addingToCategory].subcategories.find(s => s.id === addingToSubcategory);
                if (subcat) subcat.tasks.push(newTask);
            } else {
                if (!categories[addingToCategory].tasks) {
                    categories[addingToCategory].tasks = [];
                }
                categories[addingToCategory].tasks.push(newTask);
            }

            closeAddModal();
            renderCarousel(true);
            saveToStorage();
        }
        
        // Group Modal Functions
        let addingGroupToCategory = null;
        
        // Available icons for the picker
        const availableIcons = [
            '📈', '📊', '💹', '📉', '💰', '💵', '💳', '🏦',
            '📁', '📂', '📋', '📝', '✏️', '📌', '📎', '🔖',
            '🎯', '🎨', '🎭', '🎪', '🎬', '🎤', '🎧', '🎵',
            '💼', '🏢', '🏠', '🏡', '🏗️', '🔧', '🔨', '⚙️',
            '💡', '🔬', '🔭', '📡', '💻', '🖥️', '📱', '⌨️',
            '✈️', '🚗', '🚀', '🛒', '🎁', '📦', '📮', '✉️',
            '❤️', '⭐', '🌟', '✨', '🔥', '⚡', '💎', '🏆',
            '🌱', '🌿', '🍀', '🌸', '🌺', '🌻', '🌴', '🌲',
            '🍎', '🍕', '🍔', '☕', '🍷', '🎂', '🍪', '🥗',
            '💪', '🏃', '🧘', '🏋️', '⚽', '🏀', '🎾', '🏊',
            '📚', '📖', '🎓', '🧠', '💭', '🗣️', '👥', '👨‍👩‍👧‍👦',
            '🐶', '🐱', '🐦', '🦋', '🐠', '🦁', '🐻', '🦊'
        ];
        
        function openGroupModal(categoryId) {
            addingGroupToCategory = categoryId;
            document.getElementById('addGroupModal').classList.add('show');
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupIcon').value = '📌';
            document.getElementById('selectedIconDisplay').textContent = '📌';
            document.getElementById('iconPickerDropdown').classList.remove('show');
            document.getElementById('iconPickerBtn').classList.remove('open');
            
            // Populate the icon grid
            const grid = document.getElementById('iconPickerGrid');
            grid.innerHTML = '';
            availableIcons.forEach(icon => {
                const option = document.createElement('div');
                option.className = 'icon-option' + (icon === '📌' ? ' selected' : '');
                option.textContent = icon;
                option.onclick = () => selectIcon(icon);
                grid.appendChild(option);
            });
            
            setTimeout(() => document.getElementById('newGroupName').focus(), 100);
        }
        
        function toggleIconPicker() {
            const dropdown = document.getElementById('iconPickerDropdown');
            const btn = document.getElementById('iconPickerBtn');
            dropdown.classList.toggle('show');
            btn.classList.toggle('open');
        }
        
        function selectIcon(icon) {
            document.getElementById('newGroupIcon').value = icon;
            document.getElementById('selectedIconDisplay').textContent = icon;
            
            // Update selected state in grid
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.classList.toggle('selected', opt.textContent === icon);
            });
            
            // Close dropdown
            document.getElementById('iconPickerDropdown').classList.remove('show');
            document.getElementById('iconPickerBtn').classList.remove('open');
        }
        
        function closeGroupModal() {
            document.getElementById('addGroupModal').classList.remove('show');
            document.getElementById('iconPickerDropdown').classList.remove('show');
            document.getElementById('iconPickerBtn').classList.remove('open');
            addingGroupToCategory = null;
        }
        
        function addNewGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const icon = document.getElementById('newGroupIcon').value || '📌';
            
            if (!name) return;
            
            const newSubcat = {
                id: 'subcat_' + Date.now(),
                icon: icon,
                name: name,
                tasks: []
            };
            
            if (!categories[addingGroupToCategory].subcategories) {
                categories[addingGroupToCategory].subcategories = [];
            }
            categories[addingGroupToCategory].subcategories.push(newSubcat);
            
            closeGroupModal();
            renderCarousel(true);
            saveToStorage();
        }
        
        // Custom Confirm Modal
        let confirmCallback = null;
        
        function showConfirmModal(title, message, icon = '⚠️', actionText = 'Delete') {
            return new Promise((resolve) => {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmIcon').textContent = icon;
                document.getElementById('confirmActionBtn').textContent = actionText;
                document.getElementById('confirmModal').classList.add('show');
                confirmCallback = resolve;
            });
        }
        
        function closeConfirmModal(confirmed) {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmCallback) {
                confirmCallback(confirmed);
                confirmCallback = null;
            }
        }
        
        async function deleteGroup(categoryId, subcatId) {
            const category = categories[categoryId];
            if (!category || !category.subcategories) return;
            
            const subcat = category.subcategories.find(s => s.id === subcatId);
            if (!subcat) return;
            
            const taskCount = subcat.tasks?.length || 0;
            let message = taskCount > 0 
                ? `This will also delete ${taskCount} task${taskCount > 1 ? 's' : ''} in this group.`
                : 'This group is empty.';
            
            const confirmed = await showConfirmModal(
                `Delete "${subcat.name}"?`,
                message,
                '🗑️',
                'Delete Group'
            );
            
            if (!confirmed) return;
            
            // Remove the subcategory
            category.subcategories = category.subcategories.filter(s => s.id !== subcatId);
            
            renderCarousel(true);
            saveToStorage();
        }
        
        // Steps Modal Functions
        let addingStepsToTask = null;
        let addingStepsCategoryId = null;
        let addingStepsSubcatId = null;
        
        function openStepsModal(taskId, categoryId, subcatId) {
            addingStepsToTask = taskId;
            addingStepsCategoryId = categoryId;
            addingStepsSubcatId = subcatId;
            
            // Get existing steps if any
            const task = findTask(taskId, categoryId, subcatId);
            const existingSteps = task?.subtasks || [];
            
            // Build the steps list
            const container = document.getElementById('stepsListContainer');
            container.innerHTML = '';
            
            if (existingSteps.length > 0) {
                existingSteps.forEach((step, index) => {
                    addStepInputRow(step);
                });
            } else {
                // Start with one empty step
                addStepInputRow('');
            }
            
            document.getElementById('addStepsModal').classList.add('show');
            
            // Focus the first input
            setTimeout(() => {
                const firstInput = container.querySelector('.step-input');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        function addStepInputRow(value = '') {
            const container = document.getElementById('stepsListContainer');
            const stepCount = container.querySelectorAll('.step-input-row').length + 1;
            
            const row = document.createElement('div');
            row.className = 'step-input-row';
            row.innerHTML = `
                <div class="step-number-badge">${stepCount}</div>
                <input type="text" class="step-input" placeholder="Enter step ${stepCount}..." value="${value.replace(/"/g, '&quot;')}">
                <button class="step-remove-btn" onclick="removeStepInput(this)" title="Remove step">×</button>
            `;
            container.appendChild(row);
            
            // Add Enter key handler to the new input
            const input = row.querySelector('.step-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addStepInput();
                }
            });
            
            // Focus the new input if it's empty
            if (!value) {
                setTimeout(() => input.focus(), 50);
            }
            
            updateStepNumbers();
        }
        
        function addStepInput() {
            addStepInputRow('');
            // Scroll to bottom of container
            const container = document.getElementById('stepsListContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        function removeStepInput(btn) {
            const row = btn.closest('.step-input-row');
            const container = document.getElementById('stepsListContainer');
            
            // Don't remove if it's the only step
            if (container.querySelectorAll('.step-input-row').length <= 1) {
                // Just clear the input instead
                row.querySelector('.step-input').value = '';
                row.querySelector('.step-input').focus();
                return;
            }
            
            row.style.animation = 'stepFadeIn 0.2s ease-out reverse';
            setTimeout(() => {
                row.remove();
                updateStepNumbers();
            }, 150);
        }
        
        function updateStepNumbers() {
            const container = document.getElementById('stepsListContainer');
            const rows = container.querySelectorAll('.step-input-row');
            rows.forEach((row, index) => {
                row.querySelector('.step-number-badge').textContent = index + 1;
                row.querySelector('.step-input').placeholder = `Enter step ${index + 1}...`;
            });
        }
        
        function closeStepsModal() {
            document.getElementById('addStepsModal').classList.remove('show');
            addingStepsToTask = null;
            addingStepsCategoryId = null;
            addingStepsSubcatId = null;
        }
        
        // Track which task just had steps added (to show them expanded)
        let justAddedStepsToTask = null;
        
        function saveStepsFromModal() {
            const container = document.getElementById('stepsListContainer');
            const inputs = container.querySelectorAll('.step-input');
            
            const steps = [];
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    steps.push(value);
                }
            });
            
            const task = findTask(addingStepsToTask, addingStepsCategoryId, addingStepsSubcatId);
            if (task) {
                if (steps.length > 0) {
                    task.subtasks = steps;
                    // Remember this task so we can show its steps expanded
                    justAddedStepsToTask = addingStepsToTask;
                } else {
                    delete task.subtasks;
                    justAddedStepsToTask = null;
                }
            }
            
            closeStepsModal();
            renderCarousel(true);
            saveToStorage();
            
            // Clear the flag after a short delay (after render completes)
            setTimeout(() => {
                justAddedStepsToTask = null;
            }, 100);
        }
        
        // Remove a single step from a task (from the main view)
        function removeStep(taskId, stepIndex, categoryId, subcatId) {
            const task = findTask(taskId, categoryId, subcatId);
            if (task && task.subtasks) {
                task.subtasks.splice(stepIndex, 1);
                if (task.subtasks.length === 0) {
                    delete task.subtasks;
                }
                renderCarousel(true);
                saveToStorage();
            }
        }
        
        // Open steps modal for adding more (from inline button)
        function addSingleStep(taskId, categoryId, subcatId) {
            openStepsModal(taskId, categoryId, subcatId);
        }

        // Poof Animation - Subtle fade with soft particles
        function createPoofEffect(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            // Create very subtle particles - few and soft
            const colors = ['rgba(255,182,193,0.4)', 'rgba(255,218,185,0.35)', 'rgba(216,191,216,0.35)'];
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'poof-particle';
                const angle = (i / 5) * Math.PI * 2 + Math.random() * 0.5;
                const distance = 20 + Math.random() * 15;
                particle.style.cssText = `
                    left: ${centerX}px;
                    top: ${centerY}px;
                    background: ${colors[i % colors.length]};
                    --tx: ${Math.cos(angle) * distance}px;
                    --ty: ${Math.sin(angle) * distance}px;
                `;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 400);
            }
        }

        function deleteTaskWithPoof(taskItem, categoryId, subcatId, taskId) {
            // Trigger subtle poof effect
            createPoofEffect(taskItem);
            taskItem.classList.add('poofing');

            setTimeout(() => {
                // Actually delete the task
                if (subcatId) {
                    const subcat = categories[categoryId].subcategories.find(s => s.id === subcatId);
                    if (subcat) {
                        subcat.tasks = subcat.tasks.filter(t => t.id !== taskId);
                    }
                } else {
                    categories[categoryId].tasks = categories[categoryId].tasks.filter(t => t.id !== taskId);
                }
                renderCarousel();
                saveToStorage();
            }, 300);
        }

        // Helpers
        function populateUrgentCategory() {
            const urgentTasks = [];
            
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                if (cat.tasks) {
                    cat.tasks.forEach(task => {
                        if (task.priority === 'urgent' || task.priority === 'high') {
                            urgentTasks.push({
                                ...task,
                                sourceCategory: cat.name,
                                sourceCategoryId: cat.id,
                                sourceCategoryIcon: cat.icon,
                                sourceSubcatId: null
                            });
                        }
                    });
                }
                
                if (cat.subcategories) {
                    cat.subcategories.forEach(subcat => {
                        subcat.tasks.forEach(task => {
                            if (task.priority === 'urgent' || task.priority === 'high') {
                                urgentTasks.push({
                                    ...task,
                                    sourceCategory: `${cat.name} → ${subcat.name}`,
                                    sourceCategoryId: cat.id,
                                    sourceCategoryIcon: cat.icon,
                                    sourceSubcatId: subcat.id
                                });
                            }
                        });
                    });
                }
            });
            
            urgentTasks.sort((a, b) => {
                if (a.priority === 'urgent' && b.priority === 'high') return -1;
                if (a.priority === 'high' && b.priority === 'urgent') return 1;
                return 0;
            });
            
            categories.urgent.tasks = urgentTasks;
        }

        function countVisibleTasks(category) {
            if (category.id === 'urgent') {
                populateUrgentCategory();
                return category.tasks.length;
            }
            
            let count = 0;
            if (category.tasks) count += category.tasks.length;
            if (category.subcategories) {
                category.subcategories.forEach(sub => {
                    count += sub.tasks.length;
                });
            }
            return count;
        }

        function findTask(taskId, categoryId, subcatId) {
            const category = categories[categoryId];
            if (!category) return null;
            // Handle both null and empty string as "no subcategory"
            if (subcatId && subcatId !== '') {
                const subcat = category.subcategories?.find(s => s.id === subcatId);
                return subcat?.tasks.find(t => t.id === taskId);
            }
            return category.tasks?.find(t => t.id === taskId);
        }

        // Render
        function renderCarousel(preserveScroll = false) {
            populateUrgentCategory();
            
            const track = document.getElementById('carouselTrack');
            const indicator = document.getElementById('carouselIndicator');
            
            // Save scroll positions of all cards before re-rendering
            const scrollPositions = {};
            if (preserveScroll) {
                document.querySelectorAll('.category-card').forEach(card => {
                    scrollPositions[card.dataset.categoryId] = card.scrollTop;
                });
            }
            
            track.innerHTML = '';
            indicator.innerHTML = '';

            categoryOrder.forEach((catId, index) => {
                const cat = categories[catId];
                if (!cat) return;

                const card = createCategoryCard(cat);
                updateCardPosition(card, index);
                
                track.appendChild(card);
                
                // Restore scroll position if we saved it
                if (preserveScroll && scrollPositions[catId] !== undefined) {
                    card.scrollTop = scrollPositions[catId];
                }

                const dot = document.createElement('div');
                dot.className = 'carousel-dot';
                if (index === currentIndex) dot.classList.add('active');
                dot.onclick = () => goToSlide(index);
                indicator.appendChild(dot);
            });

            attachEventListeners();
        }

        function createCategoryCard(category) {
            const card = document.createElement('div');
            card.className = 'category-card';
            card.dataset.categoryId = category.id;

            const taskCount = countVisibleTasks(category);
            const showAddBtn = !category.isVirtual;

            let html = `
                <div class="category-header">
                    <span class="category-icon">${category.icon}</span>
                    <span class="category-title" contenteditable="${!category.isVirtual}" data-category-id="${category.id}">${category.name}</span>
                    <span class="category-count">${taskCount} tasks</span>
                    ${showAddBtn ? `<button class="add-task-btn" data-category-id="${category.id}" title="Add task">+</button>` : ''}
                </div>
            `;

            if (category.summary) {
                html += `<div class="category-summary">${category.summary}</div>`;
            }

            if (category.tasks && category.tasks.length > 0) {
                html += '<ul class="task-list">';
                category.tasks.forEach(task => {
                    html += renderTask(task, category.id, null);
                });
                html += '</ul>';
            }

            if (category.subcategories && !category.isVirtual) {
                category.subcategories.forEach(subcat => {
                    html += renderSubcategory(subcat, category.id);
                });
            }
            
            // Add "Add Group" button for non-virtual categories
            if (!category.isVirtual) {
                html += `<button class="add-group-btn" data-category-id="${category.id}"><span class="plus-icon">+</span> group</button>`;
            }

            card.innerHTML = html;
            return card;
        }

        function renderSubcategory(subcat, parentCatId) {
            let html = `<div class="subcategory">
                <div class="subcategory-header">
                    <div class="subcategory-title" contenteditable="true" data-subcat-id="${subcat.id}" data-parent-id="${parentCatId}">${subcat.icon} ${subcat.name}</div>
                    <button class="add-subtask-btn" data-category-id="${parentCatId}" data-subcat-id="${subcat.id}" title="Add task">+</button>
                    <button class="delete-group-btn" data-category-id="${parentCatId}" data-subcat-id="${subcat.id}" title="Delete group">×</button>
                </div>
                <ul class="task-list">`;
            
            subcat.tasks.forEach(task => {
                html += renderTask(task, parentCatId, subcat.id);
            });
            
            html += '</ul></div>';
            return html;
        }

        function renderTask(task, categoryId, subcatId) {
            const completedClass = task.completed ? 'completed' : '';
            const checkedClass = task.completed ? 'checked' : '';
            const priorityBadge = task.priority ? `<span class="priority-badge priority-${task.priority}">${task.priority.toUpperCase()}</span>` : '';
            const sourceBadge = task.sourceCategory ? `<span class="time-badge">${task.sourceCategoryIcon} ${task.sourceCategory}</span>` : '';
            
            const actualCategoryId = task.sourceCategoryId || categoryId;
            const actualSubcatId = task.sourceSubcatId || subcatId || '';
            
            let subtasksHtml = '';
            if (task.subtasks && task.subtasks.length > 0) {
                // Show steps expanded if they were just added, otherwise collapsed
                const isExpanded = justAddedStepsToTask === task.id;
                const displayStyle = isExpanded ? 'block' : 'none';
                const toggleText = isExpanded ? '↓' : '→';
                
                // Create unique ID using task ID + category + subcategory to avoid duplicates
                const uniqueId = `${task.id}-${actualCategoryId}-${actualSubcatId || 'main'}`;
                
                subtasksHtml = `
                    <div class="subtask-toggle" data-task-id="${task.id}" data-unique-id="${uniqueId}">
                        ${toggleText} ${task.subtasks.length} steps
                    </div>
                    <div class="subtask-list" id="subtasks-${uniqueId}" style="display: ${displayStyle};">
                        ${task.subtasks.map((st, i) => `
                            <div class="subtask-item">
                                <div class="subtask-number">${i + 1}</div>
                                <div class="subtask-text" contenteditable="true" data-task-id="${task.id}" data-subtask-index="${i}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">${st}</div>
                                <button class="remove-step-btn" data-task-id="${task.id}" data-subtask-index="${i}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}" title="Remove step">×</button>
                            </div>
                        `).join('')}
                        <button class="edit-steps-btn" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}" title="Edit steps">•••</button>
                    </div>
                `;
            }
            
            // Show "Add Steps" button only for non-virtual category tasks without steps
            const isVirtualTask = task.sourceCategory ? true : false;
            const addStepsBtn = (!task.subtasks || task.subtasks.length === 0) && !isVirtualTask && !task.completed
                ? `<button class="add-steps-btn" data-task-id="${task.id}" data-category-id="${categoryId}" data-subcat-id="${subcatId || ''}">+ Add steps</button>`
                : '';

            const swipeHint = task.completed ? '<div class="swipe-hint">← Swipe to delete</div>' : '';

            return `
                <li class="task-item ${completedClass}" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">
                    <div class="task-swipe-container">
                        <div class="task-delete-bg">🗑️ Delete</div>
                        <div class="task-swipe-content">
                            <div class="task-main">
                                <div class="task-checkbox ${checkedClass}" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}"></div>
                                <div class="task-content">
                                    <span class="task-text" contenteditable="true" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">${task.text}</span>
                                    <div class="task-meta">
                                        ${priorityBadge}
                                        ${sourceBadge}
                                    </div>
                                    ${addStepsBtn}
                                    ${swipeHint}
                                </div>
                            </div>
                            ${subtasksHtml}
                        </div>
                    </div>
                </li>
            `;
        }

        function updateCardPosition(card, index) {
            const total = categoryOrder.length;
            const diff = (index - currentIndex + total) % total;
            
            card.classList.remove('active', 'prev', 'next', 'hidden');
            
            if (diff === 0) {
                card.classList.add('active');
            } else if (diff === 1 || diff === -(total - 1)) {
                card.classList.add('next');
            } else if (diff === total - 1 || diff === -1) {
                card.classList.add('prev');
            } else {
                card.classList.add('hidden');
            }
        }

        function goToSlide(index) {
            currentIndex = index;
            const cards = document.querySelectorAll('.category-card');
            cards.forEach((card, i) => updateCardPosition(card, i));
            
            document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            saveToStorage();
        }

        function nextSlide() {
            currentIndex = (currentIndex + 1) % categoryOrder.length;
            goToSlide(currentIndex);
        }

        function prevSlide() {
            currentIndex = (currentIndex - 1 + categoryOrder.length) % categoryOrder.length;
            goToSlide(currentIndex);
        }

        // ==========================================
        // CATEGORY MANAGEMENT
        // ==========================================
        
        function openManageCategoriesModal() {
            renderManageCategoriesList();
            document.getElementById('manageCategoriesModal').classList.add('show');
        }
        
        function closeManageCategoriesModal() {
            document.getElementById('manageCategoriesModal').classList.remove('show');
        }
        
        function renderManageCategoriesList() {
            const listEl = document.getElementById('manageCategoriesList');
            let html = '';
            
            categoryOrder.forEach(catId => {
                const cat = categories[catId];
                if (!cat) return;
                
                const isUrgent = catId === 'urgent';
                const itemClass = isUrgent ? 'manage-category-item urgent-item' : 'manage-category-item';
                
                html += `
                    <div class="${itemClass}" data-category-id="${catId}">
                        <span class="manage-category-icon">${cat.icon}</span>
                        <span class="manage-category-name">${cat.name}</span>
                        ${isUrgent ? '<span style="font-size: 0.7rem; color: #D8BFD8;">System</span>' : 
                        `<button class="manage-category-delete" onclick="deleteCategory('${catId}')" title="Delete category">×</button>`}
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        function openAddCategoryModal() {
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '📚';
            document.getElementById('selectedCategoryIconDisplay').textContent = '📚';
            document.getElementById('addCategoryModal').classList.add('show');
            setTimeout(() => document.getElementById('newCategoryName').focus(), 100);
        }
        
        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('show');
            document.getElementById('categoryIconPickerDropdown').classList.remove('show');
        }
        
        function toggleCategoryIconPicker() {
            document.getElementById('categoryIconPickerDropdown').classList.toggle('show');
            
            // Populate icons if not already done
            const grid = document.getElementById('categoryIconPickerGrid');
            if (grid.children.length === 0) {
                availableIcons.forEach(icon => {
                    const iconEl = document.createElement('div');
                    iconEl.className = 'icon-option';
                    iconEl.textContent = icon;
                    iconEl.onclick = () => selectCategoryIcon(icon);
                    grid.appendChild(iconEl);
                });
            }
        }
        
        function selectCategoryIcon(icon) {
            document.getElementById('newCategoryIcon').value = icon;
            document.getElementById('selectedCategoryIconDisplay').textContent = icon;
            document.getElementById('categoryIconPickerDropdown').classList.remove('show');
        }
        
        function addNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value;
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }
            
            // Generate unique ID
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20) + '_' + Date.now().toString(36);
            
            // Create new category
            categories[id] = {
                id: id,
                name: name,
                icon: icon,
                tasks: [],
                subcategories: []
            };
            
            // Add to order (before last position)
            categoryOrder.push(id);
            
            saveToStorage();
            renderCarousel();
            renderManageCategoriesList();
            closeAddCategoryModal();
            
            // Navigate to new category
            const newIndex = categoryOrder.indexOf(id);
            if (newIndex !== -1) {
                currentIndex = newIndex;
                updateCarousel();
            }
        }
        
        function deleteCategory(catId) {
            const cat = categories[catId];
            if (!cat) return;
            
            const taskCount = (cat.tasks?.length || 0) + 
                (cat.subcategories?.reduce((sum, sub) => sum + (sub.tasks?.length || 0), 0) || 0);
            
            let message = `Delete "${cat.name}"?`;
            if (taskCount > 0) {
                message += `\n\nThis will also delete ${taskCount} task${taskCount > 1 ? 's' : ''}.`;
            }
            
            if (!confirm(message)) return;
            
            // Remove from categories and order
            delete categories[catId];
            categoryOrder = categoryOrder.filter(id => id !== catId);
            
            // Adjust current index if needed
            if (currentIndex >= categoryOrder.length) {
                currentIndex = Math.max(0, categoryOrder.length - 1);
            }
            
            saveToStorage();
            renderCarousel();
            renderManageCategoriesList();
        }

        // Event Listeners
        function attachEventListeners() {
            // Add task buttons
            document.querySelectorAll('.add-task-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openAddModal(this.dataset.categoryId);
                };
            });

            document.querySelectorAll('.add-subtask-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openAddModal(this.dataset.categoryId, this.dataset.subcatId);
                };
            });
            
            // Delete group buttons
            document.querySelectorAll('.delete-group-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    deleteGroup(this.dataset.categoryId, this.dataset.subcatId);
                };
            });
            
            // Add group buttons
            document.querySelectorAll('.add-group-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openGroupModal(this.dataset.categoryId);
                };
            });
            
            // Add steps buttons
            document.querySelectorAll('.add-steps-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openStepsModal(
                        parseInt(this.dataset.taskId),
                        this.dataset.categoryId,
                        this.dataset.subcatId || null
                    );
                };
            });
            
            // Remove step buttons
            document.querySelectorAll('.remove-step-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    removeStep(
                        parseInt(this.dataset.taskId),
                        parseInt(this.dataset.subtaskIndex),
                        this.dataset.categoryId,
                        this.dataset.subcatId || null
                    );
                };
            });
            
            // Edit steps buttons (opens the modal with existing steps)
            document.querySelectorAll('.edit-steps-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openStepsModal(
                        parseInt(this.dataset.taskId),
                        this.dataset.categoryId,
                        this.dataset.subcatId || null
                    );
                };
            });

            // Checkboxes
            document.querySelectorAll('.task-checkbox').forEach(box => {
                box.onclick = function(e) {
                    e.stopPropagation();
                    const categoryId = this.dataset.categoryId;
                    const subcatId = this.dataset.subcatId;
                    const task = findTask(parseInt(this.dataset.taskId), categoryId, subcatId);
                    if (task) {
                        task.completed = !task.completed;
                        renderCarousel(true);
                        saveToStorage();
                    }
                };
            });

            // Swipe to delete for completed tasks - improved for mobile
            document.querySelectorAll('.task-item.completed .task-swipe-container').forEach(container => {
                const taskItem = container.closest('.task-item');
                const swipeContent = container.querySelector('.task-swipe-content');
                const deleteBg = container.querySelector('.task-delete-bg');
                const taskId = parseInt(taskItem.dataset.taskId);
                const categoryId = taskItem.dataset.categoryId;
                const subcatId = taskItem.dataset.subcatId;

                let startX = 0;
                let startY = 0;
                let currentX = 0;
                let isSwiping = false;
                let isHorizontalSwipe = null; // null = undetermined, true = horizontal, false = vertical
                let startTime = 0;
                const SWIPE_THRESHOLD = 80; // pixels needed to trigger delete
                const DIRECTION_LOCK_THRESHOLD = 10; // pixels before locking direction
                const MAX_SWIPE = 120; // max swipe distance

                const handleStart = (e) => {
                    const touch = e.touches ? e.touches[0] : e;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    currentX = startX;
                    isSwiping = true;
                    isHorizontalSwipe = null;
                    startTime = Date.now();
                    swipeContent.classList.add('swiping');
                    swipeContent.classList.remove('snapping');
                };

                const handleMove = (e) => {
                    if (!isSwiping) return;
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = startX - touch.clientX;
                    const deltaY = startY - touch.clientY;
                    
                    // Determine swipe direction if not yet locked
                    if (isHorizontalSwipe === null && (Math.abs(deltaX) > DIRECTION_LOCK_THRESHOLD || Math.abs(deltaY) > DIRECTION_LOCK_THRESHOLD)) {
                        isHorizontalSwipe = Math.abs(deltaX) > Math.abs(deltaY) * 1.2;
                        
                        // If vertical scroll, cancel swipe
                        if (!isHorizontalSwipe) {
                            isSwiping = false;
                            swipeContent.classList.remove('swiping');
                            swipeContent.style.transform = 'translateX(0)';
                            deleteBg.classList.remove('visible', 'ready');
                            return;
                        }
                    }
                    
                    // Only process horizontal swipes
                    if (isHorizontalSwipe) {
                        currentX = touch.clientX;
                        const diff = startX - currentX;
                        
                        if (diff > 0) {
                            // Apply slight resistance as swipe increases
                            const resistance = 1 - (diff / (MAX_SWIPE * 3));
                            const translateX = Math.min(diff * Math.max(resistance, 0.5), MAX_SWIPE);
                            swipeContent.style.transform = `translateX(-${translateX}px)`;
                            
                            // Show delete background
                            deleteBg.classList.toggle('visible', diff > 20);
                            deleteBg.classList.toggle('ready', diff > SWIPE_THRESHOLD);
                        } else {
                            // Don't allow swiping right
                            swipeContent.style.transform = 'translateX(0)';
                        }
                    }
                };

                const handleEnd = () => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    swipeContent.classList.remove('swiping');
                    
                    const diff = startX - currentX;
                    const velocity = diff / (Date.now() - startTime);
                    
                    // Delete if swiped far enough OR swiped fast enough
                    if (diff > SWIPE_THRESHOLD || (diff > 50 && velocity > 0.5)) {
                        // Smooth slide out then delete
                        swipeContent.classList.add('snapping');
                        swipeContent.style.transform = `translateX(-${MAX_SWIPE + 50}px)`;
                        setTimeout(() => {
                            deleteTaskWithPoof(taskItem, categoryId, subcatId, taskId);
                        }, 150);
                    } else {
                        // Snap back smoothly
                        swipeContent.classList.add('snapping');
                        swipeContent.style.transform = 'translateX(0)';
                        deleteBg.classList.remove('visible', 'ready');
                    }
                };

                // Touch events
                container.addEventListener('touchstart', handleStart, { passive: true });
                container.addEventListener('touchmove', handleMove, { passive: false });
                container.addEventListener('touchend', handleEnd);
                container.addEventListener('touchcancel', handleEnd);

                // Mouse events for desktop testing
                container.addEventListener('mousedown', handleStart);
                container.addEventListener('mousemove', (e) => {
                    if (isSwiping) handleMove(e);
                });
                container.addEventListener('mouseup', handleEnd);
                container.addEventListener('mouseleave', handleEnd);
            });

            // Subtask toggles
            document.querySelectorAll('.subtask-toggle').forEach(toggle => {
                toggle.onclick = function(e) {
                    e.stopPropagation();
                    const uniqueId = this.dataset.uniqueId;
                    // Try to find by ID first, then fall back to next sibling
                    let subtasks = document.getElementById(`subtasks-${uniqueId}`);
                    if (!subtasks) {
                        // Fallback: find the next sibling element with class subtask-list
                        subtasks = this.nextElementSibling;
                        if (!subtasks || !subtasks.classList.contains('subtask-list')) {
                            console.warn('Could not find subtask list for toggle:', uniqueId);
                            return;
                        }
                    }
                    
                    const isHidden = subtasks.style.display === 'none' || !subtasks.style.display;
                    subtasks.style.display = isHidden ? 'block' : 'none';
                    
                    // Update arrow direction
                    const text = this.textContent;
                    if (isHidden) {
                        this.textContent = text.replace('→', '↓');
                    } else {
                        this.textContent = text.replace('↓', '→');
                    }
                };
            });

            // Editable fields
            document.querySelectorAll('.category-title').forEach(title => {
                title.onblur = function() {
                    const catId = this.dataset.categoryId;
                    if (categories[catId] && !categories[catId].isVirtual) {
                        categories[catId].name = this.textContent.trim();
                        saveToStorage();
                    }
                };
            });

            document.querySelectorAll('.task-text').forEach(text => {
                text.onblur = function() {
                    const task = findTask(parseInt(this.dataset.taskId), this.dataset.categoryId, this.dataset.subcatId);
                    if (task) {
                        task.text = this.textContent.trim();
                        saveToStorage();
                    }
                };
            });

            document.querySelectorAll('.subcategory-title').forEach(title => {
                title.onblur = function() {
                    const cat = categories[this.dataset.parentId];
                    const subcat = cat?.subcategories?.find(s => s.id === this.dataset.subcatId);
                    if (subcat) {
                        const newText = this.textContent.trim();
                        const match = newText.match(/^(.) (.+)$/);
                        if (match) {
                            subcat.icon = match[1];
                            subcat.name = match[2];
                        } else {
                            subcat.name = newText;
                        }
                        saveToStorage();
                    }
                };
            });

            document.querySelectorAll('.subtask-text').forEach(text => {
                text.onblur = function() {
                    const categoryId = this.dataset.categoryId || this.closest('.category-card').dataset.categoryId;
                    const subcatId = this.dataset.subcatId || this.closest('.subcategory')?.querySelector('.subcategory-title')?.dataset?.subcatId || '';
                    const task = findTask(parseInt(this.dataset.taskId), categoryId, subcatId);
                    if (task && task.subtasks) {
                        task.subtasks[parseInt(this.dataset.subtaskIndex)] = this.textContent.trim();
                        saveToStorage();
                    }
                };
            });
        }

        // Modal keyboard support
        document.getElementById('newTaskText').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewTask();
            } else if (e.key === 'Escape') {
                closeAddModal();
            }
        });
        
        document.getElementById('newGroupName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewGroup();
            } else if (e.key === 'Escape') {
                closeGroupModal();
            }
        });
        
        document.getElementById('newCategoryName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewCategory();
            } else if (e.key === 'Escape') {
                closeAddCategoryModal();
            }
        });
        
        // Escape key to close steps modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('addStepsModal').classList.contains('show')) {
                closeStepsModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('addTaskModal').addEventListener('click', (e) => {
            if (e.target.id === 'addTaskModal') {
                closeAddModal();
            }
        });
        
        document.getElementById('addGroupModal').addEventListener('click', (e) => {
            if (e.target.id === 'addGroupModal') {
                closeGroupModal();
            }
            // Close icon picker if clicking outside of it
            if (!e.target.closest('.icon-picker-section')) {
                document.getElementById('iconPickerDropdown').classList.remove('show');
                document.getElementById('iconPickerBtn').classList.remove('open');
            }
        });
        
        document.getElementById('addStepsModal').addEventListener('click', (e) => {
            if (e.target.id === 'addStepsModal') {
                closeStepsModal();
            }
        });

        // Touch/swipe for carousel - improved for mobile
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('.task-swipe-container')) return;
            if (e.target.closest('.modal')) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (e.target.closest('.task-swipe-container')) return;
            if (e.target.closest('.modal')) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const touchDuration = Date.now() - touchStartTime;

            // Require horizontal swipe, not too slow, and significant distance
            if (Math.abs(deltaX) > Math.abs(deltaY) * 1.5 && Math.abs(deltaX) > 40 && touchDuration < 500) {
                if (deltaX > 0) prevSlide();
                else nextSlide();
            }
        });

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.target.closest('[contenteditable]')) return;
            if (e.target.closest('.modal')) return;

            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevSlide();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextSlide();
            }
        });

        // Particles
        // Ambient Ripple effect only (no floating particles)
        function createRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            document.getElementById('background').appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 8000);
        }

        function createAmbientRipple() {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            createRipple(x, y);
        }

        // Simple animation loop for ripples
        function animate() {
            // Create ambient ripples occasionally
            if (Math.random() < 0.002) {
                createAmbientRipple();
            }
            requestAnimationFrame(animate);
        }

        // Initialize
        loadFromStorage();
        renderCarousel();
        animate();
        
        // Show welcome modal for first-time users
        if (isFirstTimeUser) {
            setTimeout(() => {
                showWelcomeModal();
            }, 500);
        }
        
        // Show swipe hint on first visit (only once)
        if (!localStorage.getItem('mylist_swipe_hint_shown')) {
            setTimeout(() => {
                const activeCard = document.querySelector('.category-card.active');
                if (activeCard) {
                    activeCard.classList.add('swipe-hint');
                    setTimeout(() => {
                        activeCard.classList.remove('swipe-hint');
                        localStorage.setItem('mylist_swipe_hint_shown', 'true');
                    }, 3000);
                }
            }, 500);
        }
        
        setTimeout(() => createAmbientRipple(), 500);
        setTimeout(() => createAmbientRipple(), 1500);
        setTimeout(() => createAmbientRipple(), 2500);
        
        // Load saved API key
        const savedApiKey = localStorage.getItem('claude_api_key');
        if (savedApiKey) {
            document.getElementById('claudeApiKey').value = savedApiKey;
        }

        // ==========================================
        // PHOTO IMPORT FUNCTIONALITY
        // ==========================================
        
        let selectedPhotos = []; // Array of {base64, mediaType, file}
        let parsedImportData = null;
        
        function openPhotoModal() {
            document.getElementById('photoImportModal').classList.add('show');
            resetPhotoModal();
            
            // Show saved indicator if key exists
            const savedKey = localStorage.getItem('claude_api_key');
            if (savedKey) {
                document.getElementById('claudeApiKey').value = savedKey;
                document.getElementById('apiKeySaved').style.display = 'block';
            }
        }
        
        function closePhotoModal() {
            document.getElementById('photoImportModal').classList.remove('show');
            resetPhotoModal();
        }
        
        function resetPhotoModal() {
            selectedPhotos = [];
            parsedImportData = null;
            editModeEnabled = false;
            
            // Reset photo previews
            document.getElementById('photoPreviewsContainer').innerHTML = '';
            document.getElementById('photoUploadArea').classList.remove('has-image');
            document.getElementById('photoUploadIcon').style.display = 'block';
            document.getElementById('photoUploadText').style.display = 'block';
            document.querySelector('.photo-upload-hint').style.display = 'block';
            document.getElementById('addMorePhotosBtn').style.display = 'none';
            
            document.getElementById('processingIndicator').classList.remove('show');
            document.getElementById('importError').classList.remove('show');
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('importSuccess').classList.remove('show');
            
            document.getElementById('processPhotoBtn').style.display = 'none';
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('editImportBtn').style.display = 'none';
            document.getElementById('editImportBtn').textContent = '✏️ Edit';
            document.getElementById('editImportBtn').classList.remove('active');
            document.getElementById('photoInput').value = '';
        }
        
        function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            
            files.forEach(file => {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    showImportError('Please select image files only.');
                    return;
                }
                
                // Check file size (max 10MB each)
                if (file.size > 10 * 1024 * 1024) {
                    showImportError('Images must be under 10MB each.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    const mediaType = file.type;
                    
                    selectedPhotos.push({
                        base64: base64,
                        mediaType: mediaType,
                        name: file.name
                    });
                    
                    updatePhotoPreview();
                };
                reader.readAsDataURL(file);
            });
            
            // Clear input so same file can be selected again
            event.target.value = '';
        }
        
        function updatePhotoPreview() {
            const container = document.getElementById('photoPreviewsContainer');
            container.innerHTML = '';
            
            selectedPhotos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-preview-item';
                item.innerHTML = `
                    <img src="${photo.base64}" alt="Photo ${index + 1}">
                    <button type="button" class="photo-preview-remove" onclick="removePhoto(${index})">×</button>
                `;
                container.appendChild(item);
            });
            
            if (selectedPhotos.length > 0) {
                document.getElementById('photoUploadArea').classList.add('has-image');
                document.getElementById('photoUploadIcon').style.display = 'none';
                document.getElementById('photoUploadText').textContent = `${selectedPhotos.length} photo${selectedPhotos.length > 1 ? 's' : ''} selected`;
                document.getElementById('photoUploadText').style.display = 'block';
                document.querySelector('.photo-upload-hint').style.display = 'none';
                document.getElementById('addMorePhotosBtn').style.display = 'block';
                document.getElementById('processPhotoBtn').style.display = 'inline-block';
                document.getElementById('processPhotoBtn').textContent = `Process ${selectedPhotos.length} Photo${selectedPhotos.length > 1 ? 's' : ''}`;
                document.getElementById('importError').classList.remove('show');
            } else {
                document.getElementById('photoUploadArea').classList.remove('has-image');
                document.getElementById('photoUploadIcon').style.display = 'block';
                document.getElementById('photoUploadText').textContent = 'Click to upload photos of your handwritten notes';
                document.getElementById('photoUploadText').style.display = 'block';
                document.querySelector('.photo-upload-hint').style.display = 'block';
                document.getElementById('addMorePhotosBtn').style.display = 'none';
                document.getElementById('processPhotoBtn').style.display = 'none';
            }
        }
        
        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }
        
        function showImportError(message) {
            const errorEl = document.getElementById('importError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        async function processPhoto() {
            const apiKey = document.getElementById('claudeApiKey').value.trim();
            
            if (!apiKey) {
                showImportError('Please enter your Claude API key.');
                return;
            }
            
            if (selectedPhotos.length === 0) {
                showImportError('Please select at least one photo.');
                return;
            }
            
            // Save API key
            localStorage.setItem('claude_api_key', apiKey);
            document.getElementById('apiKeySaved').style.display = 'block';
            
            // Show processing
            document.getElementById('processingIndicator').classList.add('show');
            document.getElementById('processingText').textContent = `Processing ${selectedPhotos.length} photo${selectedPhotos.length > 1 ? 's' : ''}...`;
            document.getElementById('processPhotoBtn').style.display = 'none';
            document.getElementById('addMorePhotosBtn').style.display = 'none';
            document.getElementById('importError').classList.remove('show');
            
            // Build category context for Claude
            const categoryContext = buildCategoryContext();
            
            try {
                // Build content array with all images
                const contentArray = [];
                
                selectedPhotos.forEach((photo, index) => {
                    const base64Data = photo.base64.split(',')[1];
                    contentArray.push({
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: photo.mediaType,
                            data: base64Data
                        }
                    });
                });
                
                // Add the text prompt
                contentArray.push({
                    type: 'text',
                    text: `You are a task extraction assistant. Look at ${selectedPhotos.length > 1 ? 'these handwritten notes' : 'this handwritten note'} and extract all tasks/items from ${selectedPhotos.length > 1 ? 'them' : 'it'}.

Here are the existing categories and groups in the user's task app:
${categoryContext}

IMPORTANT RULES FOR CATEGORY ASSIGNMENT:
1. STRONGLY PREFER existing categories - only create a new category if a task absolutely cannot fit any existing category
2. Be creative in fitting tasks to existing categories. For example:
   - Home repair tasks can go in a general "Home" or "Personal" category
   - Work-related tasks should go in "Work" or similar existing category
   - Shopping items can go in "Personal", "Home", or any lifestyle category
3. Group similar tasks together - if you see multiple related items, put them in the same existing category
4. Only suggest ONE new category maximum, and only if there are 3+ tasks that truly don't fit anywhere else

Please analyze the handwritten notes and:
1. Extract each task/item you can read from ALL images
2. Assign each task to the most appropriate EXISTING category or subcategory/group
3. If multiple tasks truly don't fit any existing category (3+ tasks), you may suggest ONE new category
4. Include priority (urgent, high, medium) if the handwriting suggests urgency (underlines, stars, exclamation marks)

Respond ONLY with valid JSON in this exact format (no other text):
{
  "tasks": [
    {
      "text": "task description",
      "categoryId": "existing_category_id",
      "subcategoryId": null,
      "priority": null
    }
  ]
}

Existing categoryIds you MUST use when possible: ${Object.keys(categories).filter(c => c !== 'urgent').join(', ')}

Only if creating a new category (rare), add: "categoryName": "Name", "categoryIcon": "emoji"
subcategoryId should be an existing subcategory/group id if applicable, or null
priority should be "urgent", "high", "medium", or null`
                });
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4096,
                        messages: [{
                            role: 'user',
                            content: contentArray
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const content = data.content[0].text;
                
                // Parse the JSON response
                try {
                    // Extract JSON from response (in case there's any extra text)
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('No valid JSON found in response');
                    }
                    
                    parsedImportData = JSON.parse(jsonMatch[0]);
                    
                    if (!parsedImportData.tasks || parsedImportData.tasks.length === 0) {
                        throw new Error('No tasks found in the image(s)');
                    }
                    
                    // Show preview
                    showImportPreview(parsedImportData.tasks);
                    
                } catch (parseError) {
                    throw new Error('Could not parse tasks from image(s). Try clearer photos.');
                }
                
            } catch (error) {
                console.error('Photo processing error:', error);
                showImportError(error.message || 'Failed to process photo(s). Please try again.');
                document.getElementById('processPhotoBtn').style.display = 'inline-block';
                document.getElementById('addMorePhotosBtn').style.display = 'block';
            } finally {
                document.getElementById('processingIndicator').classList.remove('show');
            }
        }
        
        function buildCategoryContext() {
            let context = '';
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                context += `\nCategory: "${cat.name}" (id: ${catId})`;
                
                if (cat.subcategories && cat.subcategories.length > 0) {
                    cat.subcategories.forEach(sub => {
                        context += `\n  - Group: "${sub.name}" (id: ${sub.id})`;
                    });
                }
            });
            return context;
        }
        
        let editModeEnabled = false;
        
        function showImportPreview(tasks) {
            const previewEl = document.getElementById('importPreview');
            editModeEnabled = true; // Start in edit mode
            
            // Build category options for dropdown - include new categories from import
            let allCategoryOptions = '';
            
            // Add existing categories
            categoryOrder.filter(c => c !== 'urgent').forEach(catId => {
                const cat = categories[catId];
                allCategoryOptions += `<option value="${catId}">${cat.name}</option>`;
                if (cat.subcategories) {
                    cat.subcategories.forEach(sub => {
                        allCategoryOptions += `<option value="${catId}/${sub.id}">  → ${sub.name}</option>`;
                    });
                }
            });
            
            // Add any new categories from import
            const newCats = new Set();
            tasks.forEach(task => {
                if (task.categoryId && !categories[task.categoryId] && !newCats.has(task.categoryId)) {
                    newCats.add(task.categoryId);
                    const catName = task.categoryName || task.categoryId.replace(/_/g, ' ');
                    allCategoryOptions += `<option value="${task.categoryId}">[NEW] ${catName}</option>`;
                }
            });
            
            // Build HTML with always-editable fields
            let html = `
                <div class="import-preview-header">
                    <div class="import-preview-title">Found ${tasks.length} task${tasks.length > 1 ? 's' : ''} - tap to edit</div>
                </div>
                <div class="import-tasks-container">
            `;
            
            tasks.forEach((task, index) => {
                const catId = task.categoryId || 'work';
                const cat = categories[catId];
                const catName = cat ? cat.name : (task.categoryName || catId.replace(/_/g, ' '));
                let displayCat = catName;
                let currentValue = catId;
                
                if (task.subcategoryId) {
                    if (cat?.subcategories) {
                        const sub = cat.subcategories.find(s => s.id === task.subcategoryId);
                        if (sub) {
                            displayCat = `${catName} → ${sub.name}`;
                            currentValue = `${catId}/${task.subcategoryId}`;
                        }
                    } else if (task.subcategoryName) {
                        displayCat = `${catName} → ${task.subcategoryName}`;
                        currentValue = `${catId}/${task.subcategoryId}`;
                    }
                }
                
                // Mark new categories
                const isNewCategory = !categories[catId];
                const categoryLabel = isNewCategory ? `[NEW] ${displayCat}` : displayCat;
                
                html += `
                    <div class="import-task-item" data-index="${index}">
                        <input type="text" class="import-task-text editable" value="${task.text.replace(/"/g, '&quot;')}" data-index="${index}">
                        <select class="import-task-category-select show" data-index="${index}">
                            ${allCategoryOptions.replace(`value="${currentValue}"`, `value="${currentValue}" selected`)}
                        </select>
                        ${task.priority ? `<span class="priority-badge priority-${task.priority}">${task.priority.charAt(0).toUpperCase()}</span>` : ''}
                        <button type="button" class="import-task-delete show" data-index="${index}" onclick="deleteImportTask(${index})">×</button>
                    </div>
                `;
            });
            
            html += '</div>';
            
            previewEl.innerHTML = html;
            previewEl.classList.add('show');
            document.getElementById('confirmImportBtn').style.display = 'inline-block';
            document.getElementById('editImportBtn').style.display = 'none'; // Hide edit button since always in edit mode
        }
        
        function toggleEditMode() {
            editModeEnabled = !editModeEnabled;
            const editBtn = document.getElementById('editImportBtn');
            
            if (editModeEnabled) {
                editBtn.textContent = '✓ Done Editing';
                editBtn.classList.add('active');
            } else {
                editBtn.textContent = '✏️ Edit';
                editBtn.classList.remove('active');
                // Save edits back to parsedImportData
                saveEditsToImportData();
            }
            
            // Toggle visibility of edit controls
            document.querySelectorAll('.import-task-text').forEach(el => {
                el.classList.toggle('editable', editModeEnabled);
                el.readOnly = !editModeEnabled;
            });
            document.querySelectorAll('.import-task-category-select').forEach(el => {
                el.classList.toggle('show', editModeEnabled);
            });
            document.querySelectorAll('.import-task-cat-display').forEach(el => {
                el.style.display = editModeEnabled ? 'none' : 'block';
            });
            document.querySelectorAll('.import-task-delete').forEach(el => {
                el.classList.toggle('show', editModeEnabled);
            });
        }
        
        function saveEditsToImportData() {
            if (!parsedImportData || !parsedImportData.tasks) return;
            
            document.querySelectorAll('.import-task-text').forEach(input => {
                const index = parseInt(input.dataset.index);
                if (parsedImportData.tasks[index]) {
                    parsedImportData.tasks[index].text = input.value.trim();
                }
            });
            
            document.querySelectorAll('.import-task-category-select').forEach(select => {
                const index = parseInt(select.dataset.index);
                if (parsedImportData.tasks[index]) {
                    const value = select.value;
                    if (value.includes('/')) {
                        const [catId, subId] = value.split('/');
                        parsedImportData.tasks[index].categoryId = catId;
                        parsedImportData.tasks[index].subcategoryId = subId;
                    } else {
                        parsedImportData.tasks[index].categoryId = value;
                        parsedImportData.tasks[index].subcategoryId = null;
                    }
                }
            });
        }
        
        function deleteImportTask(index) {
            if (!parsedImportData || !parsedImportData.tasks) return;
            
            // Save current edits first
            saveEditsToImportData();
            
            parsedImportData.tasks.splice(index, 1);
            
            if (parsedImportData.tasks.length === 0) {
                document.getElementById('importPreview').classList.remove('show');
                document.getElementById('confirmImportBtn').style.display = 'none';
                document.getElementById('editImportBtn').style.display = 'none';
                document.getElementById('addMorePhotosBtn').style.display = 'block';
                showImportError('All tasks removed. Upload more photos to try again.');
            } else {
                showImportPreview(parsedImportData.tasks);
            }
        }
        
        function confirmImport() {
            // Save any pending edits first
            if (editModeEnabled) {
                saveEditsToImportData();
            }
            
            if (!parsedImportData || !parsedImportData.tasks) return;
            
            // Collect which categories are actually being used by the final task list
            const usedCategories = new Set();
            parsedImportData.tasks.forEach(task => {
                if (task.categoryId && task.categoryId !== 'urgent') {
                    usedCategories.add(task.categoryId);
                }
            });
            
            // If replace mode, clear everything first
            if (importMode === 'replace') {
                // Keep only urgent category structure
                categories = {
                    urgent: {
                        id: 'urgent',
                        name: '⚡ Urgent & Important',
                        icon: '🔥',
                        isVirtual: true,
                        tasks: []
                    }
                };
                categoryOrder = ['urgent'];
                
                // Create ONLY the categories that are actually used
                parsedImportData.tasks.forEach(task => {
                    const catId = task.categoryId || 'imported';
                    if (!categories[catId] && catId !== 'urgent' && usedCategories.has(catId)) {
                        // Create the category if it doesn't exist and is actually used
                        const catName = task.categoryName || catId.charAt(0).toUpperCase() + catId.slice(1).replace(/_/g, ' ');
                        const catIcon = task.categoryIcon || '📌';
                        categories[catId] = {
                            id: catId,
                            name: catName,
                            icon: catIcon,
                            tasks: [],
                            subcategories: []
                        };
                        categoryOrder.push(catId);
                    }
                });
            }
            
            parsedImportData.tasks.forEach(task => {
                const catId = task.categoryId || 'work';
                let cat = categories[catId];
                
                // If category doesn't exist (in add mode), create it ONLY if it's being used
                if (!cat && usedCategories.has(catId)) {
                    const catName = task.categoryName || catId.charAt(0).toUpperCase() + catId.slice(1).replace(/_/g, ' ');
                    const catIcon = task.categoryIcon || '📌';
                    categories[catId] = {
                        id: catId,
                        name: catName,
                        icon: catIcon,
                        tasks: [],
                        subcategories: []
                    };
                    categoryOrder.push(catId);
                    cat = categories[catId];
                }
                
                // Skip if category still doesn't exist (shouldn't happen, but safety check)
                if (!cat) return;
                
                const newTask = {
                    id: nextTaskId++,
                    text: task.text,
                    completed: false
                };
                
                if (task.priority) {
                    newTask.priority = task.priority;
                }
                
                if (task.subcategoryId) {
                    let sub = cat.subcategories?.find(s => s.id === task.subcategoryId);
                    // Create subcategory if it doesn't exist
                    if (!sub) {
                        if (!cat.subcategories) cat.subcategories = [];
                        sub = {
                            id: task.subcategoryId,
                            name: task.subcategoryName || task.subcategoryId.replace(/_/g, ' '),
                            icon: task.subcategoryIcon || '📁',
                            tasks: []
                        };
                        cat.subcategories.push(sub);
                    }
                    sub.tasks.push(newTask);
                } else {
                    if (!cat.tasks) cat.tasks = [];
                    cat.tasks.push(newTask);
                }
            });
            
            // Show success
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('editImportBtn').style.display = 'none';
            document.getElementById('importSuccess').classList.add('show');
            
            // Save and re-render
            saveToStorage();
            renderCarousel();
            
            // Reset import mode to default
            setImportMode('add');
            
            // Close modal after delay
            setTimeout(() => {
                closePhotoModal();
            }, 1500);
        }
        
        // Close photo modal on overlay click
        document.getElementById('photoImportModal').addEventListener('click', (e) => {
            if (e.target.id === 'photoImportModal') {
                closePhotoModal();
            }
        });
        
        // Escape to close photo modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('photoImportModal').classList.contains('show')) {
                closePhotoModal();
            }
        });
        
        // ==========================================
        // EXPORT/IMPORT DATA FUNCTIONALITY
        // ==========================================
        
        function openExportModal() {
            document.getElementById('exportModal').classList.add('show');
            document.getElementById('importTextarea').value = '';
            document.getElementById('exportMessage').className = 'export-message';
            document.getElementById('exportMessage').textContent = '';
            document.getElementById('importMessage').className = 'export-message';
            document.getElementById('importMessage').textContent = '';
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }
        
        function getExportData() {
            return {
                version: '1.0',
                exportDate: new Date().toISOString(),
                categories: categories,
                categoryOrder: categoryOrder,
                nextTaskId: nextTaskId
            };
        }
        
        function exportAsJSON() {
            const data = getExportData();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `mylist-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showExportMessage('success', '✓ JSON file downloaded!');
        }
        
        function exportAsText() {
            let text = `MyList Export - ${new Date().toLocaleDateString()}\n`;
            text += '='.repeat(40) + '\n\n';
            
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                text += `${cat.icon} ${cat.name}\n`;
                text += '-'.repeat(30) + '\n';
                
                if (cat.tasks && cat.tasks.length > 0) {
                    cat.tasks.forEach(task => {
                        const status = task.completed ? '✓' : '○';
                        const priority = task.priority ? ` [${task.priority.toUpperCase()}]` : '';
                        text += `  ${status} ${task.text}${priority}\n`;
                        if (task.subtasks) {
                            task.subtasks.forEach((st, i) => {
                                text += `      ${i + 1}. ${st}\n`;
                            });
                        }
                    });
                }
                
                if (cat.subcategories) {
                    cat.subcategories.forEach(sub => {
                        text += `\n  ${sub.icon} ${sub.name}\n`;
                        sub.tasks.forEach(task => {
                            const status = task.completed ? '✓' : '○';
                            const priority = task.priority ? ` [${task.priority.toUpperCase()}]` : '';
                            text += `    ${status} ${task.text}${priority}\n`;
                            if (task.subtasks) {
                                task.subtasks.forEach((st, i) => {
                                    text += `        ${i + 1}. ${st}\n`;
                                });
                            }
                        });
                    });
                }
                
                text += '\n';
            });
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `mylist-export-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showExportMessage('success', '✓ Text file downloaded!');
        }
        
        function exportToAppleNotes() {
            // Generate ICS (iCalendar) format that Apple Calendar can import
            // Tasks become calendar events/notes that sync via iCloud
            const now = new Date();
            const dateStr = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MyList//Task Export//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
            
            let eventCount = 0;
            
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                // Helper to create VTODO (task) entries
                const addTask = (task, categoryName, subcatName = '') => {
                    eventCount++;
                    const uid = `mylist-${task.id}-${Date.now()}@mylist.app`;
                    const location = subcatName ? `${cat.icon} ${categoryName} > ${subcatName}` : `${cat.icon} ${categoryName}`;
                    const priority = task.priority === 'urgent' ? 1 : task.priority === 'high' ? 3 : task.priority === 'medium' ? 5 : 9;
                    const status = task.completed ? 'COMPLETED' : 'NEEDS-ACTION';
                    
                    let description = task.text;
                    if (task.subtasks && task.subtasks.length > 0) {
                        description += '\\n\\nSteps:\\n' + task.subtasks.map((st, i) => `${i + 1}. ${st}`).join('\\n');
                    }
                    if (task.priority) {
                        description += `\\n\\nPriority: ${task.priority.toUpperCase()}`;
                    }
                    
                    // Escape special characters for ICS
                    const escapeICS = (str) => str.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
                    
                    ics += `BEGIN:VTODO
UID:${uid}
DTSTAMP:${dateStr}
CREATED:${dateStr}
SUMMARY:${escapeICS(task.text)}
DESCRIPTION:${escapeICS(description)}
CATEGORIES:${escapeICS(categoryName)}
PRIORITY:${priority}
STATUS:${status}
END:VTODO
`;
                };
                
                // Add main category tasks
                if (cat.tasks) {
                    cat.tasks.forEach(task => addTask(task, cat.name));
                }
                
                // Add subcategory tasks
                if (cat.subcategories) {
                    cat.subcategories.forEach(sub => {
                        sub.tasks.forEach(task => addTask(task, cat.name, sub.name));
                    });
                }
            });
            
            ics += 'END:VCALENDAR';
            
            if (eventCount === 0) {
                showExportMessage('error', 'No tasks to export!');
                return;
            }
            
            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `mylist-tasks-${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showExportMessage('success', `✓ Exported ${eventCount} tasks to .ics file!`);
        }
        
        function copyToClipboard() {
            const data = getExportData();
            const json = JSON.stringify(data, null, 2);
            
            navigator.clipboard.writeText(json).then(() => {
                showExportMessage('success', '✓ Copied to clipboard!');
            }).catch(err => {
                showExportMessage('error', 'Failed to copy. Try downloading instead.');
            });
        }
        
        function showExportMessage(type, message) {
            const el = document.getElementById('exportMessage');
            el.className = `export-message ${type}`;
            el.textContent = message;
            setTimeout(() => {
                el.className = 'export-message';
            }, 3000);
        }
        
        function showImportMessage(type, message) {
            const el = document.getElementById('importMessage');
            el.className = `export-message ${type}`;
            el.textContent = message;
        }
        
        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    importData(data);
                } catch (err) {
                    showImportMessage('error', 'Invalid JSON file. Please check the file format.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function importFromText() {
            const text = document.getElementById('importTextarea').value.trim();
            if (!text) {
                showImportMessage('error', 'Please paste JSON data first.');
                return;
            }
            
            try {
                const data = JSON.parse(text);
                importData(data);
            } catch (err) {
                showImportMessage('error', 'Invalid JSON format. Please check your data.');
            }
        }
        
        function importData(data) {
            if (!data.categories) {
                showImportMessage('error', 'Invalid data format. Missing categories.');
                return;
            }
            
            // Confirm before overwriting
            if (!confirm('This will replace all your current tasks. Continue?')) {
                return;
            }
            
            categories = data.categories;
            categoryOrder = data.categoryOrder || categoryOrder;
            nextTaskId = data.nextTaskId || 100;
            
            saveToStorage();
            renderCarousel();
            
            showImportMessage('success', '✓ Data imported successfully!');
            document.getElementById('importTextarea').value = '';
            
            setTimeout(() => {
                closeExportModal();
            }, 1500);
        }
        
        // Close export modal on overlay click
        document.getElementById('exportModal').addEventListener('click', (e) => {
            if (e.target.id === 'exportModal') {
                closeExportModal();
            }
        });
        
        // Escape to close export modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('exportModal').classList.contains('show')) {
                closeExportModal();
            }
        });
        
        // Close manage categories modal on overlay click
        document.getElementById('manageCategoriesModal').addEventListener('click', (e) => {
            if (e.target.id === 'manageCategoriesModal') {
                closeManageCategoriesModal();
            }
        });
        
        // Close add category modal on overlay click
        document.getElementById('addCategoryModal').addEventListener('click', (e) => {
            if (e.target.id === 'addCategoryModal') {
                closeAddCategoryModal();
            }
        });
        
        // Escape to close manage modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('welcomeModal').classList.contains('show')) {
                    // Don't close welcome modal with Escape for first-time users
                    if (!isFirstTimeUser) closeWelcomeModal();
                } else if (document.getElementById('confirmModal').classList.contains('show')) {
                    closeConfirmModal(false);
                } else if (document.getElementById('addCategoryModal').classList.contains('show')) {
                    closeAddCategoryModal();
                } else if (document.getElementById('manageCategoriesModal').classList.contains('show')) {
                    closeManageCategoriesModal();
                }
            }
        });
        
        // Close confirm modal on overlay click
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                closeConfirmModal(false);
            }
        });
        
        // Close welcome modal on overlay click (but not for first-time users)
        document.getElementById('welcomeModal').addEventListener('click', (e) => {
            if (e.target.id === 'welcomeModal' && !isFirstTimeUser) {
                closeWelcomeModal();
            }
        });
    </script>
</body>
</html>
