<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyList ‚ú®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #ffffff;
            min-height: 100vh;
            overflow: hidden;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        }

        .wisp {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 50%;
            pointer-events: none;
            animation: ripple-expand 6s ease-out forwards;
        }

        @keyframes ripple-expand {
            0% {
                width: 0;
                height: 0;
                opacity: 0.6;
                border-width: 3px;
            }
            50% {
                opacity: 0.3;
                border-width: 2px;
            }
            100% {
                width: 600px;
                height: 600px;
                opacity: 0;
                border-width: 1px;
            }
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
            padding: 15px 30px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #FFB6C1, #FFDAB9, #D8BFD8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-left .tagline {
            font-size: 0.85rem;
            color: #D8BFD8;
            opacity: 0.8;
        }

        /* Photo Import Button */
        .photo-import-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.2), rgba(216, 191, 216, 0.2));
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 12px;
            color: #FFB6C1;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-import-btn:hover {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.3), rgba(216, 191, 216, 0.3));
            border-color: #FFB6C1;
            transform: scale(1.05);
        }

        .photo-import-btn .camera-icon {
            font-size: 1.2rem;
        }

        /* Photo Import Modal */
        .modal-photo {
            max-width: 500px;
        }

        .api-key-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .api-key-section label {
            display: block;
            color: #D8BFD8;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .api-key-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
        }

        .api-key-input::placeholder {
            color: rgba(216, 191, 216, 0.5);
        }

        .api-key-saved {
            color: #90EE90;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .photo-upload-area {
            border: 2px dashed rgba(255, 182, 193, 0.4);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .photo-upload-area:hover {
            border-color: #FFB6C1;
            background: rgba(255, 182, 193, 0.05);
        }

        .photo-upload-area.has-image {
            padding: 10px;
        }

        .photo-upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .photo-upload-text {
            color: #D8BFD8;
            font-size: 0.95rem;
        }

        .photo-upload-hint {
            color: rgba(216, 191, 216, 0.6);
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            display: none;
        }

        .photo-preview.show {
            display: block;
        }

        .processing-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .processing-indicator.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 182, 193, 0.2);
            border-top-color: #FFB6C1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            color: #D8BFD8;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        /* Import Preview */
        .import-preview {
            display: none;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .import-preview.show {
            display: block;
        }

        .import-category {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 182, 193, 0.08);
            border-radius: 10px;
            border-left: 3px solid #FFB6C1;
        }

        .import-category-title {
            font-weight: 600;
            color: #FFB6C1;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .import-task-list {
            list-style: none;
        }

        .import-task-item {
            padding: 6px 0;
            color: #fff;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-task-item::before {
            content: '‚Üí';
            color: #D8BFD8;
        }

        .import-error {
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .import-error.show {
            display: block;
        }

        .import-success {
            color: #90EE90;
            text-align: center;
            padding: 20px;
            display: none;
        }

        .import-success.show {
            display: block;
        }

        .import-success-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Carousel Container */
        .carousel-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 120px;
            perspective: 2000px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-track {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Card States */
        .category-card {
            position: absolute;
            width: 80%;
            max-width: 900px;
            height: 85%;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Scrollbar styling */
        .category-card::-webkit-scrollbar {
            width: 8px;
        }

        .category-card::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .category-card::-webkit-scrollbar-thumb {
            background: rgba(255, 182, 193, 0.3);
            border-radius: 10px;
        }

        .category-card::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 182, 193, 0.5);
        }

        /* Active Card */
        .category-card.active {
            z-index: 10;
            opacity: 1;
            transform: translateX(0) translateZ(0) scale(1) rotateY(0deg);
            pointer-events: auto;
            filter: blur(0);
        }
        
        /* Swipe hint animation - plays once on first load */
        .category-card.active.swipe-hint {
            animation: swipe-hint-anim 1.5s ease-in-out 1s 1;
        }
        
        @keyframes swipe-hint-anim {
            0%, 100% {
                transform: translateX(0) translateZ(0) scale(1) rotateY(0deg);
            }
            25% {
                transform: translateX(-15px) translateZ(0) scale(1) rotateY(2deg);
            }
            50% {
                transform: translateX(15px) translateZ(0) scale(1) rotateY(-2deg);
            }
            75% {
                transform: translateX(-8px) translateZ(0) scale(1) rotateY(1deg);
            }
        }

        /* Previous Card */
        .category-card.prev {
            z-index: 5;
            opacity: 0.3;
            transform: translateX(-45%) translateZ(-400px) scale(0.7) rotateY(15deg);
            pointer-events: none;
            filter: blur(3px);
        }

        /* Next Card */
        .category-card.next {
            z-index: 5;
            opacity: 0.3;
            transform: translateX(45%) translateZ(-400px) scale(0.7) rotateY(-15deg);
            pointer-events: none;
            filter: blur(3px);
        }

        /* Hidden Cards */
        .category-card.hidden {
            opacity: 0;
            transform: translateX(0) translateZ(-600px) scale(0.5);
            pointer-events: none;
            filter: blur(5px);
        }

        /* Overview Mode (Zoomed Out) - iPhone App Grid Style */
        body.overview-mode .carousel-container {
            perspective: none;
            animation: zoom-out-container 0.6s ease-out forwards;
        }

        body:not(.overview-mode) .carousel-container {
            animation: zoom-in-container 0.6s ease-out forwards;
        }

        @keyframes zoom-out-container {
            0% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes zoom-in-container {
            0% {
                opacity: 0.5;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        body.overview-mode .category-card {
            position: relative;
            width: auto;
            min-width: 85px;
            max-width: 140px;
            height: auto;
            min-height: 100px;
            margin: 0;
            padding: 12px 8px 10px;
            opacity: 1 !important;
            transform: none !important;
            filter: none !important;
            pointer-events: auto !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            animation: card-appear 0.4s ease-out backwards;
            background: rgba(255, 182, 193, 0.08);
            border: 1px solid rgba(255, 182, 193, 0.15);
            border-radius: 20px;
        }

        body.overview-mode .category-card:nth-child(1) { animation-delay: 0.02s; }
        body.overview-mode .category-card:nth-child(2) { animation-delay: 0.04s; }
        body.overview-mode .category-card:nth-child(3) { animation-delay: 0.06s; }
        body.overview-mode .category-card:nth-child(4) { animation-delay: 0.08s; }
        body.overview-mode .category-card:nth-child(5) { animation-delay: 0.10s; }
        body.overview-mode .category-card:nth-child(6) { animation-delay: 0.12s; }
        body.overview-mode .category-card:nth-child(7) { animation-delay: 0.14s; }

        @keyframes card-appear {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        body.overview-mode .category-card:hover {
            transform: scale(1.08) !important;
            background: rgba(255, 182, 193, 0.15);
            border-color: rgba(255, 182, 193, 0.4);
        }
        
        body.overview-mode .category-card:active {
            transform: scale(0.95) !important;
        }

        body.overview-mode .carousel-track {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 15px;
            overflow-y: auto;
            padding: 40px 20px;
            min-height: calc(100vh - 80px);
        }
        
        /* Hide content in overview mode, show only icon */
        body.overview-mode .category-header {
            flex-direction: column;
            border: none;
            margin: 0;
            padding: 0;
            gap: 8px;
            width: 100%;
        }
        
        body.overview-mode .category-icon {
            font-size: 2.2rem;
            margin-bottom: 2px;
        }
        
        body.overview-mode .category-title {
            font-size: 0.7rem;
            text-align: center;
            line-height: 1.3;
            color: #D8BFD8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            padding: 0 2px;
        }
        
        body.overview-mode .category-count,
        body.overview-mode .add-task-btn,
        body.overview-mode .category-summary,
        body.overview-mode .task-list,
        body.overview-mode .subcategory,
        body.overview-mode .add-group-btn {
            display: none !important;
        }
        
        /* View transition overlay */
        .view-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255, 182, 193, 0.15) 0%, transparent 70%);
            pointer-events: none;
            opacity: 0;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        
        .view-transition-overlay.active {
            animation: view-flash 0.6s ease-out forwards;
        }
        
        @keyframes view-flash {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(2);
            }
        }

        /* Card Header */
        .category-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 182, 193, 0.3);
        }

        .category-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }

        .category-title {
            font-size: 2rem;
            color: #FFDAB9;
            font-weight: 600;
            flex-grow: 1;
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
        }

        .category-title:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .category-title:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .category-count {
            background: rgba(255, 182, 193, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #FFB6C1;
        }

        /* Add Task Button */
        .add-task-btn {
            width: 36px;
            height: 36px;
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.1);
            color: #FFB6C1;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            line-height: 1;
            padding-bottom: 2px;
        }

        .add-task-btn:hover {
            background: rgba(255, 182, 193, 0.3);
            border-color: #FFB6C1;
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.4);
        }

        .category-summary {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 12px;
            font-size: 1.1rem;
            color: #D8BFD8;
            line-height: 1.8;
        }

        /* Task List */
        .task-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .task-item {
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item:hover {
            padding-left: 12px;
            background: rgba(255, 182, 193, 0.05);
            border-radius: 10px;
        }

        /* Swipe container */
        .task-swipe-container {
            position: relative;
            touch-action: pan-y pinch-zoom;
            overflow: hidden;
        }

        .task-swipe-content {
            position: relative;
            background: transparent;
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }

        .task-swipe-content.swiping {
            transition: none;
        }
        
        .task-swipe-content.snapping {
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Delete background revealed on swipe */
        .task-delete-bg {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, transparent 30%, rgba(255, 107, 157, 0.15) 70%, rgba(255, 107, 157, 0.35) 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 25px;
            color: #FF6B9D;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 10px;
        }

        .task-delete-bg.visible {
            opacity: 1;
        }
        
        .task-delete-bg.ready {
            background: linear-gradient(90deg, transparent 20%, rgba(255, 107, 157, 0.25) 60%, rgba(255, 107, 157, 0.5) 100%);
        }

        /* Poof Animation - Very subtle fade */
        @keyframes poof {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-30px);
                opacity: 0;
            }
        }

        @keyframes poof-particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        .task-item.poofing {
            animation: poof 0.3s ease-out forwards;
            pointer-events: none;
        }

        .poof-particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            animation: poof-particle 0.4s ease-out forwards;
        }

        /* Swipe hint for completed tasks */
        .swipe-hint {
            font-size: 0.75rem;
            color: rgba(255, 182, 193, 0.5);
            margin-top: 6px;
            font-style: italic;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-item.completed:hover .swipe-hint {
            opacity: 1;
        }
        
        /* Show swipe hint on mobile always for completed tasks */
        @media (max-width: 768px) {
            .task-item.completed .swipe-hint {
                opacity: 0.7;
            }
        }

        .task-main {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            min-width: 22px;
            border: 2px solid #FFB6C1;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
            margin-top: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .task-checkbox:hover {
            background: rgba(255, 182, 193, 0.2);
            transform: scale(1.1);
        }

        .task-checkbox.checked {
            background: rgba(255, 182, 193, 0.6);
        }
        
        .task-checkbox.checked::after {
            content: '‚úì';
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #ffffff;
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
        }

        .task-text:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .task-text:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .task-meta {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-urgent {
            background: rgba(255, 107, 157, 0.3);
            color: #FF6B9D;
            border: 1px solid #FF6B9D;
        }

        .priority-high {
            background: rgba(255, 107, 157, 0.2);
            color: #FF6B9D;
            border: 1px solid #FF6B9D;
        }

        .priority-medium {
            background: rgba(255, 218, 185, 0.2);
            color: #FFDAB9;
            border: 1px solid #FFDAB9;
        }

        .time-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: rgba(216, 191, 216, 0.2);
            color: #D8BFD8;
            border: 1px solid #D8BFD8;
        }

        .subtask-toggle {
            margin-top: 12px;
            color: #D8BFD8;
            font-size: 0.9rem;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            user-select: none;
        }

        .subtask-toggle:hover {
            opacity: 1;
            color: #FFB6C1;
        }

        .subtask-list {
            margin-top: 15px;
            margin-left: 35px;
            padding-left: 20px;
            border-left: 3px solid rgba(255, 182, 193, 0.3);
        }

        .subtask-item {
            padding: 10px 0;
            font-size: 1rem;
            color: #D8BFD8;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .subtask-number {
            min-width: 28px;
            height: 28px;
            background: rgba(255, 182, 193, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #FFB6C1;
            flex-shrink: 0;
            font-weight: 600;
        }

        .subtask-text {
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
            flex-grow: 1;
        }

        .subtask-text:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .subtask-text:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .subcategory {
            margin-left: 30px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 182, 193, 0.05);
            border-left: 4px solid rgba(255, 182, 193, 0.4);
            border-radius: 10px;
        }

        .subcategory-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .subcategory-title {
            font-size: 1.2rem;
            color: #FFE4C4;
            font-weight: 600;
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
        }

        .subcategory-title:hover {
            background: rgba(255, 182, 193, 0.1);
        }

        .subcategory-title:focus {
            background: rgba(255, 182, 193, 0.15);
            box-shadow: 0 0 0 2px #FFB6C1;
        }

        .add-subtask-btn {
            width: 28px;
            height: 28px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.1);
            color: #FFB6C1;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            line-height: 1;
        }

        .add-subtask-btn:hover {
            background: rgba(255, 182, 193, 0.3);
            border-color: #FFB6C1;
            transform: scale(1.15) rotate(90deg);
        }

        /* Indicator Dots */
        .carousel-indicator {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .carousel-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.3);
            border: 2px solid rgba(255, 182, 193, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: #FFB6C1;
            transform: scale(1.4);
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.6);
        }

        .carousel-dot:hover {
            background: rgba(255, 182, 193, 0.6);
            transform: scale(1.2);
        }

        /* Zoom Controls */
        .zoom-controls {
            position: fixed;
            bottom: 40px;
            right: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            z-index: 100;
        }

        .zoom-btn {
            width: 55px;
            height: 55px;
            border: 3px solid rgba(255, 182, 193, 0.4);
            border-radius: 50%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            color: #FFB6C1;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
            transform: scale(1.15);
        }
        
        .zoom-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }
        
        .zoom-btn:hover .zoom-icon {
            transform: rotate(180deg);
        }

        /* Save indicator - hidden but functional */
        .save-indicator {
            display: none;
        }

        /* Add Task Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            animation: modal-pop 0.3s ease-out;
        }

        @keyframes modal-pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal h2 {
            color: #FFDAB9;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            margin-bottom: 15px;
        }

        .modal-input:focus {
            border-color: #FFB6C1;
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.2);
        }

        .modal-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .modal-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-select {
            flex: 1;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
        }

        .modal-select option {
            background: #1a1f3a;
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(255, 182, 193, 0.4);
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .modal-btn.primary {
            background: rgba(255, 182, 193, 0.3);
            color: #FFB6C1;
        }

        .modal-btn.primary:hover {
            background: rgba(255, 182, 193, 0.5);
            transform: scale(1.02);
        }

        .modal-btn.secondary {
            background: transparent;
            color: #D8BFD8;
        }

        .modal-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Steps Modal Specific Styles */
        .modal-steps {
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .steps-list-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        
        .step-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            animation: stepFadeIn 0.2s ease-out;
        }
        
        @keyframes stepFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-number-badge {
            width: 28px;
            height: 28px;
            background: rgba(255, 182, 193, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFB6C1;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .step-input {
            flex: 1;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .step-input:focus {
            border-color: #FFB6C1;
            background: rgba(255, 182, 193, 0.1);
        }
        
        .step-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        .step-remove-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 107, 157, 0.15);
            color: #FF6B9D;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .step-remove-btn:hover {
            background: rgba(255, 107, 157, 0.3);
            transform: scale(1.1);
        }
        
        .add-step-modal-btn {
            padding: 12px;
            background: transparent;
            border: 2px dashed rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #D8BFD8;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .add-step-modal-btn:hover {
            background: rgba(255, 182, 193, 0.1);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Icon Picker */
        .icon-picker-section {
            margin-bottom: 15px;
            position: relative;
        }
        
        .icon-picker-label {
            display: block;
            color: #D8BFD8;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .icon-picker-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .icon-picker-btn:hover {
            border-color: #FFB6C1;
            background: rgba(255, 182, 193, 0.1);
        }
        
        #selectedIconDisplay {
            font-size: 1.8rem;
        }
        
        .icon-picker-arrow {
            color: #D8BFD8;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .icon-picker-btn.open .icon-picker-arrow {
            transform: rotate(180deg);
        }
        
        .icon-picker-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            padding: 12px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            animation: dropdown-appear 0.2s ease-out;
        }
        
        .icon-picker-dropdown.show {
            display: block;
        }
        
        @keyframes dropdown-appear {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .icon-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            background: rgba(255, 182, 193, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-option:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: rgba(255, 182, 193, 0.4);
            transform: scale(1.1);
        }
        
        .icon-option.selected {
            background: rgba(255, 182, 193, 0.3);
            border-color: #FFB6C1;
        }
        
        /* Add Group Button */
        .add-group-btn {
            margin-top: 20px;
            padding: 12px 20px;
            background: rgba(255, 182, 193, 0.1);
            border: 2px dashed rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            color: #D8BFD8;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .add-group-btn:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Add Steps Button */
        .add-steps-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: transparent;
            border: 1px dashed rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #D8BFD8;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .task-item:hover .add-steps-btn {
            opacity: 1;
        }
        
        .add-steps-btn:hover {
            background: rgba(255, 182, 193, 0.1);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Remove Step Button */
        .remove-step-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: rgba(255, 107, 157, 0.5);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        .subtask-item:hover .remove-step-btn {
            opacity: 1;
        }
        
        .remove-step-btn:hover {
            background: rgba(255, 107, 157, 0.2);
            color: #FF6B9D;
            transform: scale(1.1);
        }
        
        /* Edit Steps Button */
        .edit-steps-btn {
            margin-top: 12px;
            padding: 8px 14px;
            background: rgba(255, 182, 193, 0.1);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 8px;
            color: #D8BFD8;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .edit-steps-btn:hover {
            background: rgba(255, 182, 193, 0.2);
            border-color: #FFB6C1;
            color: #FFB6C1;
        }
        
        /* Make subtask item a flex row */
        .subtask-item {
            display: flex;
            align-items: center;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            header {
                padding: 12px 20px;
            }
            
            .header-left h1 {
                font-size: 1.5rem;
            }
            
            .header-left .tagline {
                font-size: 0.75rem;
            }
            
            .photo-import-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .photo-import-btn .btn-text {
                display: none;
            }
            
            .photo-import-btn .camera-icon {
                font-size: 1.3rem;
            }
            
            .modal-photo {
                width: 95%;
                max-width: none;
                padding: 20px;
            }
            
            .carousel-container {
                top: 70px;
            }
            
            .category-card {
                width: 92%;
                max-width: 400px;
                padding: 20px;
                max-height: calc(100vh - 150px);
            }
            
            .category-header {
                padding-bottom: 12px;
                margin-bottom: 15px;
            }
            
            .category-icon {
                font-size: 1.8rem;
            }
            
            .category-title {
                font-size: 1.3rem;
            }
            
            .task-item {
                padding: 14px 0;
            }
            
            .task-text {
                font-size: 0.95rem;
            }
            
            /* Overview mode - flexible layout on mobile */
            body.overview-mode .carousel-track {
                gap: 12px;
                padding: 30px 15px;
            }
            
            body.overview-mode .category-card {
                min-width: 80px;
                max-width: 120px;
            }
            
            body.overview-mode .category-icon {
                font-size: 2rem;
            }
            
            body.overview-mode .category-title {
                font-size: 0.65rem;
            }
            
            .zoom-controls {
                bottom: 25px;
                right: 20px;
            }
            
            .zoom-btn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
            
            .carousel-indicator {
                bottom: 25px;
            }
            
            .carousel-dot {
                width: 10px;
                height: 10px;
            }
            
            .add-task-btn {
                width: 34px;
                height: 34px;
                font-size: 1.4rem;
            }
            
            /* Modal adjustments for mobile */
            .modal {
                width: 92%;
                max-width: 360px;
                padding: 25px;
            }
            
            .modal h2 {
                font-size: 1.3rem;
            }
            
            .modal-input {
                padding: 14px;
                font-size: 1rem;
            }
            
            /* Make buttons always visible on touch devices */
            .add-steps-btn {
                opacity: 0.7;
            }
            
            .remove-step-btn {
                opacity: 0.6;
            }
            
            /* Larger touch targets */
            .remove-step-btn {
                width: 28px;
                height: 28px;
                font-size: 1.3rem;
            }
            
            .step-remove-btn {
                width: 36px;
                height: 36px;
            }
        }
        
        /* Small phones */
        @media (max-width: 380px) {
            body.overview-mode .carousel-track {
                gap: 10px;
            }
            
            body.overview-mode .category-card {
                min-width: 75px;
                max-width: 110px;
            }
            
            body.overview-mode .category-icon {
                font-size: 1.8rem;
            }
            
            body.overview-mode .category-title {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="background" id="background"></div>
    
    <div class="view-transition-overlay" id="viewTransitionOverlay"></div>

    <div class="save-indicator" id="saveIndicator">‚úì Saved</div>

    <header>
        <div class="header-left">
            <h1>MyList</h1>
            <div class="tagline">Organize your life with ease ‚ú®</div>
        </div>
        <button class="photo-import-btn" onclick="openPhotoModal()">
            <span class="camera-icon">üì∑</span>
            <span class="btn-text">Import</span>
        </button>
    </header>

    <div class="carousel-container">
        <div class="carousel-track" id="carouselTrack"></div>
    </div>

    <div class="carousel-indicator" id="carouselIndicator"></div>

    <div class="zoom-controls">
        <button class="zoom-btn zoom-toggle" id="zoomToggleBtn">
            <span class="zoom-icon" id="zoomIcon">‚àí</span>
        </button>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal">
            <h2>‚ú® Add New Task</h2>
            <input type="text" class="modal-input" id="newTaskText" placeholder="What needs to be done?">
            <select class="modal-select" id="newTaskPriority" style="width: 100%;">
                <option value="">Priority (optional)</option>
                <option value="urgent">üî• Urgent</option>
                <option value="high">‚ö° High</option>
                <option value="medium">üìå Medium</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAddModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewTask()">Add Task</button>
            </div>
        </div>
    </div>
    
    <!-- Add Group Modal -->
    <div class="modal-overlay" id="addGroupModal">
        <div class="modal">
            <h2>üìÅ Add New Group</h2>
            <input type="text" class="modal-input" id="newGroupName" placeholder="Group name (e.g., Investments)">
            <div class="icon-picker-section">
                <label class="icon-picker-label">Choose an icon:</label>
                <button class="icon-picker-btn" id="iconPickerBtn" onclick="toggleIconPicker()">
                    <span id="selectedIconDisplay">üìå</span>
                    <span class="icon-picker-arrow">‚ñº</span>
                </button>
                <div class="icon-picker-dropdown" id="iconPickerDropdown">
                    <div class="icon-picker-grid" id="iconPickerGrid"></div>
                </div>
            </div>
            <input type="hidden" id="newGroupIcon" value="üìå">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addNewGroup()">Add Group</button>
            </div>
        </div>
    </div>
    
    <!-- Add Steps Modal -->
    <div class="modal-overlay" id="addStepsModal">
        <div class="modal modal-steps">
            <h2>üìù Manage Steps</h2>
            <p style="color: #D8BFD8; margin-bottom: 15px; font-size: 0.9rem;">Add steps to break down this task</p>
            <div class="steps-list-container" id="stepsListContainer">
                <!-- Steps will be dynamically added here -->
            </div>
            <button class="add-step-modal-btn" id="addStepBtn" onclick="addStepInput()">+ Add Step</button>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeStepsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveStepsFromModal()">Save Steps</button>
            </div>
        </div>
    </div>

    <!-- Photo Import Modal -->
    <div class="modal-overlay" id="photoImportModal">
        <div class="modal modal-photo">
            <h2>üì∑ Import from Photo</h2>
            
            <!-- API Key Section -->
            <div class="api-key-section">
                <label>Claude API Key (stored locally in your browser)</label>
                <input type="password" class="api-key-input" id="claudeApiKey" placeholder="sk-ant-api03-...">
                <div class="api-key-saved" id="apiKeySaved" style="display: none;">‚úì API key saved</div>
            </div>
            
            <!-- Upload Area -->
            <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                <div class="photo-upload-icon">üìù</div>
                <div class="photo-upload-text">Click to upload a photo of your handwritten notes</div>
                <div class="photo-upload-hint">Supports JPG, PNG ‚Ä¢ Works best with clear handwriting</div>
                <img class="photo-preview" id="photoPreview" alt="Preview">
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
            
            <!-- Processing Indicator -->
            <div class="processing-indicator" id="processingIndicator">
                <div class="spinner"></div>
                <div class="processing-text">Reading your notes with Claude AI...</div>
            </div>
            
            <!-- Error Message -->
            <div class="import-error" id="importError"></div>
            
            <!-- Import Preview -->
            <div class="import-preview" id="importPreview"></div>
            
            <!-- Success Message -->
            <div class="import-success" id="importSuccess">
                <div class="import-success-icon">‚ú®</div>
                <div>Tasks imported successfully!</div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closePhotoModal()">Cancel</button>
                <button class="modal-btn primary" id="processPhotoBtn" onclick="processPhoto()" style="display: none;">Process Photo</button>
                <button class="modal-btn primary" id="confirmImportBtn" onclick="confirmImport()" style="display: none;">Import Tasks</button>
            </div>
        </div>
    </div>

    <script>
        // Default Data
        const defaultData = {
            categories: {
                urgent: {
                    id: 'urgent',
                    name: '‚ö° Urgent & Important',
                    icon: 'üî•',
                    isVirtual: true,
                    tasks: []
                },
                work: {
                    id: 'work',
                    name: 'Work & Projects',
                    icon: 'üíº',
                    tasks: [
                        { id: 1, text: 'Complete quarterly report', priority: 'urgent', completed: false },
                        { id: 2, text: 'Schedule team sync meeting', priority: 'high', completed: false },
                        { id: 3, text: 'Review project proposals', priority: 'medium', completed: false }
                    ],
                    subcategories: [
                        {
                            id: 'design',
                            icon: 'üé®',
                            name: 'Design Tasks',
                            tasks: [
                                { id: 4, text: 'Update portfolio website', priority: 'medium', completed: false },
                                { id: 5, text: 'Create presentation slides', completed: false }
                            ]
                        }
                    ]
                },
                home: {
                    id: 'home',
                    name: 'Home & Living',
                    icon: 'üè†',
                    tasks: [
                        { id: 10, text: 'Grocery shopping', priority: 'high', completed: false },
                        { id: 11, text: 'Clean kitchen', completed: false },
                        { id: 12, text: 'Fix leaky faucet', completed: false }
                    ]
                },
                health: {
                    id: 'health',
                    name: 'Health & Wellness',
                    icon: 'üí™',
                    tasks: [
                        { id: 20, text: 'Morning workout', priority: 'high', completed: false },
                        { id: 21, text: 'Meal prep for the week', completed: false },
                        { id: 22, text: 'Schedule annual checkup', priority: 'medium', completed: false },
                        { 
                            id: 23, 
                            text: 'Start meditation practice', 
                            completed: false,
                            subtasks: [
                                'Download meditation app',
                                'Set daily reminder for 7am',
                                'Complete 7-day beginner course',
                                'Establish 10-min daily habit'
                            ]
                        }
                    ]
                },
                personal: {
                    id: 'personal',
                    name: 'Personal Growth',
                    icon: 'üå±',
                    tasks: [
                        { id: 30, text: 'Read 20 pages daily', completed: false },
                        { id: 31, text: 'Learn new language - practice', priority: 'medium', completed: false },
                        { id: 32, text: 'Journal reflection', completed: false }
                    ]
                },
                social: {
                    id: 'social',
                    name: 'Social & Relationships',
                    icon: 'üë•',
                    tasks: [
                        { id: 35, text: 'Call mom', priority: 'high', completed: false },
                        { id: 36, text: 'Plan weekend dinner with friends', completed: false }
                    ]
                },
                finance: {
                    id: 'finance',
                    name: 'Finance & Planning',
                    icon: 'üí∞',
                    tasks: [
                        { id: 37, text: 'Review monthly budget', priority: 'urgent', completed: false },
                        { id: 38, text: 'Pay utility bills', priority: 'high', completed: false }
                    ],
                    subcategories: [
                        {
                            id: 'investments',
                            icon: 'üìà',
                            name: 'Investments',
                            tasks: [
                                { id: 39, text: 'Research investment options', completed: false }
                            ]
                        }
                    ]
                }
            },
            categoryOrder: ['urgent', 'work', 'home', 'health', 'personal', 'social', 'finance']
        };

        // State
        let categories = defaultData.categories;
        let categoryOrder = defaultData.categoryOrder;
        let currentIndex = 0;
        let overviewMode = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let addingToCategory = null;
        let addingToSubcategory = null;
        let nextTaskId = 100;

        // Swipe state for tasks
        let swipeState = {};

        // Storage
        function saveToStorage() {
            const data = {
                categories,
                categoryOrder,
                currentIndex,
                overviewMode,
                nextTaskId
            };
            localStorage.setItem('myListData', JSON.stringify(data));
            showSaveIndicator();
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('myListData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    categories = data.categories || categories;
                    categoryOrder = data.categoryOrder || categoryOrder;
                    currentIndex = data.currentIndex || 0;
                    overviewMode = data.overviewMode || false;
                    nextTaskId = data.nextTaskId || 100;
                } catch (e) {}
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // Add Task Modal
        function openAddModal(categoryId, subcatId = null) {
            addingToCategory = categoryId;
            addingToSubcategory = subcatId;
            document.getElementById('addTaskModal').classList.add('show');
            document.getElementById('newTaskText').value = '';
            document.getElementById('newTaskPriority').value = '';
            setTimeout(() => document.getElementById('newTaskText').focus(), 100);
        }

        function closeAddModal() {
            document.getElementById('addTaskModal').classList.remove('show');
            addingToCategory = null;
            addingToSubcategory = null;
        }

        function addNewTask() {
            const text = document.getElementById('newTaskText').value.trim();
            if (!text) return;

            const priority = document.getElementById('newTaskPriority').value;

            const newTask = {
                id: nextTaskId++,
                text: text,
                completed: false
            };

            if (priority) newTask.priority = priority;

            if (addingToSubcategory) {
                const subcat = categories[addingToCategory].subcategories.find(s => s.id === addingToSubcategory);
                if (subcat) subcat.tasks.push(newTask);
            } else {
                if (!categories[addingToCategory].tasks) {
                    categories[addingToCategory].tasks = [];
                }
                categories[addingToCategory].tasks.push(newTask);
            }

            closeAddModal();
            renderCarousel();
            saveToStorage();
        }
        
        // Group Modal Functions
        let addingGroupToCategory = null;
        
        // Available icons for the picker
        const availableIcons = [
            'üìà', 'üìä', 'üíπ', 'üìâ', 'üí∞', 'üíµ', 'üí≥', 'üè¶',
            'üìÅ', 'üìÇ', 'üìã', 'üìù', '‚úèÔ∏è', 'üìå', 'üìé', 'üîñ',
            'üéØ', 'üé®', 'üé≠', 'üé™', 'üé¨', 'üé§', 'üéß', 'üéµ',
            'üíº', 'üè¢', 'üè†', 'üè°', 'üèóÔ∏è', 'üîß', 'üî®', '‚öôÔ∏è',
            'üí°', 'üî¨', 'üî≠', 'üì°', 'üíª', 'üñ•Ô∏è', 'üì±', '‚å®Ô∏è',
            '‚úàÔ∏è', 'üöó', 'üöÄ', 'üõí', 'üéÅ', 'üì¶', 'üìÆ', '‚úâÔ∏è',
            '‚ù§Ô∏è', '‚≠ê', 'üåü', '‚ú®', 'üî•', '‚ö°', 'üíé', 'üèÜ',
            'üå±', 'üåø', 'üçÄ', 'üå∏', 'üå∫', 'üåª', 'üå¥', 'üå≤',
            'üçé', 'üçï', 'üçî', '‚òï', 'üç∑', 'üéÇ', 'üç™', 'ü•ó',
            'üí™', 'üèÉ', 'üßò', 'üèãÔ∏è', '‚öΩ', 'üèÄ', 'üéæ', 'üèä',
            'üìö', 'üìñ', 'üéì', 'üß†', 'üí≠', 'üó£Ô∏è', 'üë•', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
            'üê∂', 'üê±', 'üê¶', 'ü¶ã', 'üê†', 'ü¶Å', 'üêª', 'ü¶ä'
        ];
        
        function openGroupModal(categoryId) {
            addingGroupToCategory = categoryId;
            document.getElementById('addGroupModal').classList.add('show');
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupIcon').value = 'üìå';
            document.getElementById('selectedIconDisplay').textContent = 'üìå';
            document.getElementById('iconPickerDropdown').classList.remove('show');
            document.getElementById('iconPickerBtn').classList.remove('open');
            
            // Populate the icon grid
            const grid = document.getElementById('iconPickerGrid');
            grid.innerHTML = '';
            availableIcons.forEach(icon => {
                const option = document.createElement('div');
                option.className = 'icon-option' + (icon === 'üìå' ? ' selected' : '');
                option.textContent = icon;
                option.onclick = () => selectIcon(icon);
                grid.appendChild(option);
            });
            
            setTimeout(() => document.getElementById('newGroupName').focus(), 100);
        }
        
        function toggleIconPicker() {
            const dropdown = document.getElementById('iconPickerDropdown');
            const btn = document.getElementById('iconPickerBtn');
            dropdown.classList.toggle('show');
            btn.classList.toggle('open');
        }
        
        function selectIcon(icon) {
            document.getElementById('newGroupIcon').value = icon;
            document.getElementById('selectedIconDisplay').textContent = icon;
            
            // Update selected state in grid
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.classList.toggle('selected', opt.textContent === icon);
            });
            
            // Close dropdown
            document.getElementById('iconPickerDropdown').classList.remove('show');
            document.getElementById('iconPickerBtn').classList.remove('open');
        }
        
        function closeGroupModal() {
            document.getElementById('addGroupModal').classList.remove('show');
            document.getElementById('iconPickerDropdown').classList.remove('show');
            document.getElementById('iconPickerBtn').classList.remove('open');
            addingGroupToCategory = null;
        }
        
        function addNewGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const icon = document.getElementById('newGroupIcon').value || 'üìå';
            
            if (!name) return;
            
            const newSubcat = {
                id: 'subcat_' + Date.now(),
                icon: icon,
                name: name,
                tasks: []
            };
            
            if (!categories[addingGroupToCategory].subcategories) {
                categories[addingGroupToCategory].subcategories = [];
            }
            categories[addingGroupToCategory].subcategories.push(newSubcat);
            
            closeGroupModal();
            renderCarousel();
            saveToStorage();
        }
        
        // Steps Modal Functions
        let addingStepsToTask = null;
        let addingStepsCategoryId = null;
        let addingStepsSubcatId = null;
        
        function openStepsModal(taskId, categoryId, subcatId) {
            addingStepsToTask = taskId;
            addingStepsCategoryId = categoryId;
            addingStepsSubcatId = subcatId;
            
            // Get existing steps if any
            const task = findTask(taskId, categoryId, subcatId);
            const existingSteps = task?.subtasks || [];
            
            // Build the steps list
            const container = document.getElementById('stepsListContainer');
            container.innerHTML = '';
            
            if (existingSteps.length > 0) {
                existingSteps.forEach((step, index) => {
                    addStepInputRow(step);
                });
            } else {
                // Start with one empty step
                addStepInputRow('');
            }
            
            document.getElementById('addStepsModal').classList.add('show');
            
            // Focus the first input
            setTimeout(() => {
                const firstInput = container.querySelector('.step-input');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        function addStepInputRow(value = '') {
            const container = document.getElementById('stepsListContainer');
            const stepCount = container.querySelectorAll('.step-input-row').length + 1;
            
            const row = document.createElement('div');
            row.className = 'step-input-row';
            row.innerHTML = `
                <div class="step-number-badge">${stepCount}</div>
                <input type="text" class="step-input" placeholder="Enter step ${stepCount}..." value="${value.replace(/"/g, '&quot;')}">
                <button class="step-remove-btn" onclick="removeStepInput(this)" title="Remove step">√ó</button>
            `;
            container.appendChild(row);
            
            // Add Enter key handler to the new input
            const input = row.querySelector('.step-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addStepInput();
                }
            });
            
            // Focus the new input if it's empty
            if (!value) {
                setTimeout(() => input.focus(), 50);
            }
            
            updateStepNumbers();
        }
        
        function addStepInput() {
            addStepInputRow('');
            // Scroll to bottom of container
            const container = document.getElementById('stepsListContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        function removeStepInput(btn) {
            const row = btn.closest('.step-input-row');
            const container = document.getElementById('stepsListContainer');
            
            // Don't remove if it's the only step
            if (container.querySelectorAll('.step-input-row').length <= 1) {
                // Just clear the input instead
                row.querySelector('.step-input').value = '';
                row.querySelector('.step-input').focus();
                return;
            }
            
            row.style.animation = 'stepFadeIn 0.2s ease-out reverse';
            setTimeout(() => {
                row.remove();
                updateStepNumbers();
            }, 150);
        }
        
        function updateStepNumbers() {
            const container = document.getElementById('stepsListContainer');
            const rows = container.querySelectorAll('.step-input-row');
            rows.forEach((row, index) => {
                row.querySelector('.step-number-badge').textContent = index + 1;
                row.querySelector('.step-input').placeholder = `Enter step ${index + 1}...`;
            });
        }
        
        function closeStepsModal() {
            document.getElementById('addStepsModal').classList.remove('show');
            addingStepsToTask = null;
            addingStepsCategoryId = null;
            addingStepsSubcatId = null;
        }
        
        // Track which task just had steps added (to show them expanded)
        let justAddedStepsToTask = null;
        
        function saveStepsFromModal() {
            const container = document.getElementById('stepsListContainer');
            const inputs = container.querySelectorAll('.step-input');
            
            const steps = [];
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    steps.push(value);
                }
            });
            
            const task = findTask(addingStepsToTask, addingStepsCategoryId, addingStepsSubcatId);
            if (task) {
                if (steps.length > 0) {
                    task.subtasks = steps;
                    // Remember this task so we can show its steps expanded
                    justAddedStepsToTask = addingStepsToTask;
                } else {
                    delete task.subtasks;
                    justAddedStepsToTask = null;
                }
            }
            
            closeStepsModal();
            renderCarousel();
            saveToStorage();
            
            // Clear the flag after a short delay (after render completes)
            setTimeout(() => {
                justAddedStepsToTask = null;
            }, 100);
        }
        
        // Remove a single step from a task (from the main view)
        function removeStep(taskId, stepIndex, categoryId, subcatId) {
            const task = findTask(taskId, categoryId, subcatId);
            if (task && task.subtasks) {
                task.subtasks.splice(stepIndex, 1);
                if (task.subtasks.length === 0) {
                    delete task.subtasks;
                }
                renderCarousel();
                saveToStorage();
            }
        }
        
        // Open steps modal for adding more (from inline button)
        function addSingleStep(taskId, categoryId, subcatId) {
            openStepsModal(taskId, categoryId, subcatId);
        }

        // Poof Animation - Subtle fade with soft particles
        function createPoofEffect(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            // Create very subtle particles - few and soft
            const colors = ['rgba(255,182,193,0.4)', 'rgba(255,218,185,0.35)', 'rgba(216,191,216,0.35)'];
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'poof-particle';
                const angle = (i / 5) * Math.PI * 2 + Math.random() * 0.5;
                const distance = 20 + Math.random() * 15;
                particle.style.cssText = `
                    left: ${centerX}px;
                    top: ${centerY}px;
                    background: ${colors[i % colors.length]};
                    --tx: ${Math.cos(angle) * distance}px;
                    --ty: ${Math.sin(angle) * distance}px;
                `;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 400);
            }
        }

        function deleteTaskWithPoof(taskItem, categoryId, subcatId, taskId) {
            // Trigger subtle poof effect
            createPoofEffect(taskItem);
            taskItem.classList.add('poofing');

            setTimeout(() => {
                // Actually delete the task
                if (subcatId) {
                    const subcat = categories[categoryId].subcategories.find(s => s.id === subcatId);
                    if (subcat) {
                        subcat.tasks = subcat.tasks.filter(t => t.id !== taskId);
                    }
                } else {
                    categories[categoryId].tasks = categories[categoryId].tasks.filter(t => t.id !== taskId);
                }
                renderCarousel();
                saveToStorage();
            }, 300);
        }

        // Helpers
        function populateUrgentCategory() {
            const urgentTasks = [];
            
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                if (cat.tasks) {
                    cat.tasks.forEach(task => {
                        if (task.priority === 'urgent' || task.priority === 'high') {
                            urgentTasks.push({
                                ...task,
                                sourceCategory: cat.name,
                                sourceCategoryId: cat.id,
                                sourceCategoryIcon: cat.icon,
                                sourceSubcatId: null
                            });
                        }
                    });
                }
                
                if (cat.subcategories) {
                    cat.subcategories.forEach(subcat => {
                        subcat.tasks.forEach(task => {
                            if (task.priority === 'urgent' || task.priority === 'high') {
                                urgentTasks.push({
                                    ...task,
                                    sourceCategory: `${cat.name} ‚Üí ${subcat.name}`,
                                    sourceCategoryId: cat.id,
                                    sourceCategoryIcon: cat.icon,
                                    sourceSubcatId: subcat.id
                                });
                            }
                        });
                    });
                }
            });
            
            urgentTasks.sort((a, b) => {
                if (a.priority === 'urgent' && b.priority === 'high') return -1;
                if (a.priority === 'high' && b.priority === 'urgent') return 1;
                return 0;
            });
            
            categories.urgent.tasks = urgentTasks;
        }

        function countVisibleTasks(category) {
            if (category.id === 'urgent') {
                populateUrgentCategory();
                return category.tasks.length;
            }
            
            let count = 0;
            if (category.tasks) count += category.tasks.length;
            if (category.subcategories) {
                category.subcategories.forEach(sub => {
                    count += sub.tasks.length;
                });
            }
            return count;
        }

        function findTask(taskId, categoryId, subcatId) {
            const category = categories[categoryId];
            if (!category) return null;
            // Handle both null and empty string as "no subcategory"
            if (subcatId && subcatId !== '') {
                const subcat = category.subcategories?.find(s => s.id === subcatId);
                return subcat?.tasks.find(t => t.id === taskId);
            }
            return category.tasks?.find(t => t.id === taskId);
        }

        // Render
        function renderCarousel() {
            populateUrgentCategory();
            
            const track = document.getElementById('carouselTrack');
            const indicator = document.getElementById('carouselIndicator');
            track.innerHTML = '';
            indicator.innerHTML = '';

            categoryOrder.forEach((catId, index) => {
                const cat = categories[catId];
                if (!cat) return;

                const card = createCategoryCard(cat);
                updateCardPosition(card, index);
                
                if (overviewMode) {
                    card.onclick = () => {
                        // Trigger view transition effect
                        const overlay = document.getElementById('viewTransitionOverlay');
                        overlay.classList.add('active');
                        setTimeout(() => overlay.classList.remove('active'), 600);
                        
                        overviewMode = false;
                        currentIndex = index;
                        document.body.classList.remove('overview-mode');
                        renderCarousel();
                        saveToStorage();
                    };
                }
                
                track.appendChild(card);

                const dot = document.createElement('div');
                dot.className = 'carousel-dot';
                if (index === currentIndex) dot.classList.add('active');
                dot.onclick = () => goToSlide(index);
                indicator.appendChild(dot);
            });

            attachEventListeners();
        }

        function createCategoryCard(category) {
            const card = document.createElement('div');
            card.className = 'category-card';
            card.dataset.categoryId = category.id;

            const taskCount = countVisibleTasks(category);
            const showAddBtn = !category.isVirtual;

            let html = `
                <div class="category-header">
                    <span class="category-icon">${category.icon}</span>
                    <span class="category-title" contenteditable="${!category.isVirtual}" data-category-id="${category.id}">${category.name}</span>
                    <span class="category-count">${taskCount} tasks</span>
                    ${showAddBtn ? `<button class="add-task-btn" data-category-id="${category.id}" title="Add task">+</button>` : ''}
                </div>
            `;

            if (category.summary) {
                html += `<div class="category-summary">${category.summary}</div>`;
            }

            if (category.tasks && category.tasks.length > 0) {
                html += '<ul class="task-list">';
                category.tasks.forEach(task => {
                    html += renderTask(task, category.id, null);
                });
                html += '</ul>';
            }

            if (category.subcategories && !category.isVirtual) {
                category.subcategories.forEach(subcat => {
                    html += renderSubcategory(subcat, category.id);
                });
            }
            
            // Add "Add Group" button for non-virtual categories
            if (!category.isVirtual) {
                html += `<button class="add-group-btn" data-category-id="${category.id}">üìÅ Add Group</button>`;
            }

            card.innerHTML = html;
            return card;
        }

        function renderSubcategory(subcat, parentCatId) {
            let html = `<div class="subcategory">
                <div class="subcategory-header">
                    <div class="subcategory-title" contenteditable="true" data-subcat-id="${subcat.id}" data-parent-id="${parentCatId}">${subcat.icon} ${subcat.name}</div>
                    <button class="add-subtask-btn" data-category-id="${parentCatId}" data-subcat-id="${subcat.id}" title="Add task">+</button>
                </div>
                <ul class="task-list">`;
            
            subcat.tasks.forEach(task => {
                html += renderTask(task, parentCatId, subcat.id);
            });
            
            html += '</ul></div>';
            return html;
        }

        function renderTask(task, categoryId, subcatId) {
            const completedClass = task.completed ? 'completed' : '';
            const checkedClass = task.completed ? 'checked' : '';
            const priorityBadge = task.priority ? `<span class="priority-badge priority-${task.priority}">${task.priority.toUpperCase()}</span>` : '';
            const sourceBadge = task.sourceCategory ? `<span class="time-badge">${task.sourceCategoryIcon} ${task.sourceCategory}</span>` : '';
            
            const actualCategoryId = task.sourceCategoryId || categoryId;
            const actualSubcatId = task.sourceSubcatId || subcatId || '';
            
            let subtasksHtml = '';
            if (task.subtasks && task.subtasks.length > 0) {
                // Show steps expanded if they were just added, otherwise collapsed
                const isExpanded = justAddedStepsToTask === task.id;
                const displayStyle = isExpanded ? 'block' : 'none';
                const toggleText = isExpanded ? '‚Üì' : '‚Üí';
                
                subtasksHtml = `
                    <div class="subtask-toggle" data-task-id="${task.id}">
                        ${toggleText} ${task.subtasks.length} steps
                    </div>
                    <div class="subtask-list" id="subtasks-${task.id}" style="display: ${displayStyle};">
                        ${task.subtasks.map((st, i) => `
                            <div class="subtask-item">
                                <div class="subtask-number">${i + 1}</div>
                                <div class="subtask-text" contenteditable="true" data-task-id="${task.id}" data-subtask-index="${i}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">${st}</div>
                                <button class="remove-step-btn" data-task-id="${task.id}" data-subtask-index="${i}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}" title="Remove step">√ó</button>
                            </div>
                        `).join('')}
                        <button class="edit-steps-btn" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">‚úèÔ∏è Edit Steps</button>
                    </div>
                `;
            }
            
            // Show "Add Steps" button only for non-virtual category tasks without steps
            const isVirtualTask = task.sourceCategory ? true : false;
            const addStepsBtn = (!task.subtasks || task.subtasks.length === 0) && !isVirtualTask && !task.completed
                ? `<button class="add-steps-btn" data-task-id="${task.id}" data-category-id="${categoryId}" data-subcat-id="${subcatId || ''}">+ Add steps</button>`
                : '';

            const swipeHint = task.completed ? '<div class="swipe-hint">‚Üê Swipe to delete</div>' : '';

            return `
                <li class="task-item ${completedClass}" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">
                    <div class="task-swipe-container">
                        <div class="task-delete-bg">üóëÔ∏è Delete</div>
                        <div class="task-swipe-content">
                            <div class="task-main">
                                <div class="task-checkbox ${checkedClass}" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}"></div>
                                <div class="task-content">
                                    <span class="task-text" contenteditable="true" data-task-id="${task.id}" data-category-id="${actualCategoryId}" data-subcat-id="${actualSubcatId}">${task.text}</span>
                                    <div class="task-meta">
                                        ${priorityBadge}
                                        ${sourceBadge}
                                    </div>
                                    ${addStepsBtn}
                                    ${swipeHint}
                                </div>
                            </div>
                            ${subtasksHtml}
                        </div>
                    </div>
                </li>
            `;
        }

        function updateCardPosition(card, index) {
            const total = categoryOrder.length;
            const diff = (index - currentIndex + total) % total;
            
            card.classList.remove('active', 'prev', 'next', 'hidden');
            
            if (diff === 0) {
                card.classList.add('active');
            } else if (diff === 1 || diff === -(total - 1)) {
                card.classList.add('next');
            } else if (diff === total - 1 || diff === -1) {
                card.classList.add('prev');
            } else {
                card.classList.add('hidden');
            }
        }

        function goToSlide(index) {
            currentIndex = index;
            const cards = document.querySelectorAll('.category-card');
            cards.forEach((card, i) => updateCardPosition(card, i));
            
            document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            saveToStorage();
        }

        function nextSlide() {
            currentIndex = (currentIndex + 1) % categoryOrder.length;
            goToSlide(currentIndex);
        }

        function prevSlide() {
            currentIndex = (currentIndex - 1 + categoryOrder.length) % categoryOrder.length;
            goToSlide(currentIndex);
        }

        function toggleOverview() {
            // Trigger view transition effect
            const overlay = document.getElementById('viewTransitionOverlay');
            overlay.classList.add('active');
            setTimeout(() => overlay.classList.remove('active'), 600);
            
            overviewMode = !overviewMode;
            document.body.classList.toggle('overview-mode', overviewMode);
            document.getElementById('zoomIcon').textContent = overviewMode ? '+' : '‚àí';
            renderCarousel();
            saveToStorage();
        }

        // Event Listeners
        function attachEventListeners() {
            // Add task buttons
            document.querySelectorAll('.add-task-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openAddModal(this.dataset.categoryId);
                };
            });

            document.querySelectorAll('.add-subtask-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openAddModal(this.dataset.categoryId, this.dataset.subcatId);
                };
            });
            
            // Add group buttons
            document.querySelectorAll('.add-group-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openGroupModal(this.dataset.categoryId);
                };
            });
            
            // Add steps buttons
            document.querySelectorAll('.add-steps-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openStepsModal(
                        parseInt(this.dataset.taskId),
                        this.dataset.categoryId,
                        this.dataset.subcatId || null
                    );
                };
            });
            
            // Remove step buttons
            document.querySelectorAll('.remove-step-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    removeStep(
                        parseInt(this.dataset.taskId),
                        parseInt(this.dataset.subtaskIndex),
                        this.dataset.categoryId,
                        this.dataset.subcatId || null
                    );
                };
            });
            
            // Edit steps buttons (opens the modal with existing steps)
            document.querySelectorAll('.edit-steps-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    openStepsModal(
                        parseInt(this.dataset.taskId),
                        this.dataset.categoryId,
                        this.dataset.subcatId || null
                    );
                };
            });

            // Checkboxes
            document.querySelectorAll('.task-checkbox').forEach(box => {
                box.onclick = function(e) {
                    e.stopPropagation();
                    const categoryId = this.dataset.categoryId;
                    const subcatId = this.dataset.subcatId;
                    const task = findTask(parseInt(this.dataset.taskId), categoryId, subcatId);
                    if (task) {
                        task.completed = !task.completed;
                        renderCarousel();
                        saveToStorage();
                    }
                };
            });

            // Swipe to delete for completed tasks - improved for mobile
            document.querySelectorAll('.task-item.completed .task-swipe-container').forEach(container => {
                const taskItem = container.closest('.task-item');
                const swipeContent = container.querySelector('.task-swipe-content');
                const deleteBg = container.querySelector('.task-delete-bg');
                const taskId = parseInt(taskItem.dataset.taskId);
                const categoryId = taskItem.dataset.categoryId;
                const subcatId = taskItem.dataset.subcatId;

                let startX = 0;
                let startY = 0;
                let currentX = 0;
                let isSwiping = false;
                let isHorizontalSwipe = null; // null = undetermined, true = horizontal, false = vertical
                let startTime = 0;
                const SWIPE_THRESHOLD = 80; // pixels needed to trigger delete
                const DIRECTION_LOCK_THRESHOLD = 10; // pixels before locking direction
                const MAX_SWIPE = 120; // max swipe distance

                const handleStart = (e) => {
                    const touch = e.touches ? e.touches[0] : e;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    currentX = startX;
                    isSwiping = true;
                    isHorizontalSwipe = null;
                    startTime = Date.now();
                    swipeContent.classList.add('swiping');
                    swipeContent.classList.remove('snapping');
                };

                const handleMove = (e) => {
                    if (!isSwiping) return;
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = startX - touch.clientX;
                    const deltaY = startY - touch.clientY;
                    
                    // Determine swipe direction if not yet locked
                    if (isHorizontalSwipe === null && (Math.abs(deltaX) > DIRECTION_LOCK_THRESHOLD || Math.abs(deltaY) > DIRECTION_LOCK_THRESHOLD)) {
                        isHorizontalSwipe = Math.abs(deltaX) > Math.abs(deltaY) * 1.2;
                        
                        // If vertical scroll, cancel swipe
                        if (!isHorizontalSwipe) {
                            isSwiping = false;
                            swipeContent.classList.remove('swiping');
                            swipeContent.style.transform = 'translateX(0)';
                            deleteBg.classList.remove('visible', 'ready');
                            return;
                        }
                    }
                    
                    // Only process horizontal swipes
                    if (isHorizontalSwipe) {
                        currentX = touch.clientX;
                        const diff = startX - currentX;
                        
                        if (diff > 0) {
                            // Apply slight resistance as swipe increases
                            const resistance = 1 - (diff / (MAX_SWIPE * 3));
                            const translateX = Math.min(diff * Math.max(resistance, 0.5), MAX_SWIPE);
                            swipeContent.style.transform = `translateX(-${translateX}px)`;
                            
                            // Show delete background
                            deleteBg.classList.toggle('visible', diff > 20);
                            deleteBg.classList.toggle('ready', diff > SWIPE_THRESHOLD);
                        } else {
                            // Don't allow swiping right
                            swipeContent.style.transform = 'translateX(0)';
                        }
                    }
                };

                const handleEnd = () => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    swipeContent.classList.remove('swiping');
                    
                    const diff = startX - currentX;
                    const velocity = diff / (Date.now() - startTime);
                    
                    // Delete if swiped far enough OR swiped fast enough
                    if (diff > SWIPE_THRESHOLD || (diff > 50 && velocity > 0.5)) {
                        // Smooth slide out then delete
                        swipeContent.classList.add('snapping');
                        swipeContent.style.transform = `translateX(-${MAX_SWIPE + 50}px)`;
                        setTimeout(() => {
                            deleteTaskWithPoof(taskItem, categoryId, subcatId, taskId);
                        }, 150);
                    } else {
                        // Snap back smoothly
                        swipeContent.classList.add('snapping');
                        swipeContent.style.transform = 'translateX(0)';
                        deleteBg.classList.remove('visible', 'ready');
                    }
                };

                // Touch events
                container.addEventListener('touchstart', handleStart, { passive: true });
                container.addEventListener('touchmove', handleMove, { passive: false });
                container.addEventListener('touchend', handleEnd);
                container.addEventListener('touchcancel', handleEnd);

                // Mouse events for desktop testing
                container.addEventListener('mousedown', handleStart);
                container.addEventListener('mousemove', (e) => {
                    if (isSwiping) handleMove(e);
                });
                container.addEventListener('mouseup', handleEnd);
                container.addEventListener('mouseleave', handleEnd);
            });

            // Subtask toggles
            document.querySelectorAll('.subtask-toggle').forEach(toggle => {
                toggle.onclick = function(e) {
                    e.stopPropagation();
                    const subtasks = document.getElementById(`subtasks-${this.dataset.taskId}`);
                    if (subtasks) {
                        const isHidden = subtasks.style.display === 'none';
                        subtasks.style.display = isHidden ? 'block' : 'none';
                        // Update arrow direction
                        const text = this.textContent;
                        if (isHidden) {
                            this.textContent = text.replace('‚Üí', '‚Üì');
                        } else {
                            this.textContent = text.replace('‚Üì', '‚Üí');
                        }
                    }
                };
            });

            // Editable fields
            document.querySelectorAll('.category-title').forEach(title => {
                title.onblur = function() {
                    const catId = this.dataset.categoryId;
                    if (categories[catId] && !categories[catId].isVirtual) {
                        categories[catId].name = this.textContent.trim();
                        saveToStorage();
                    }
                };
            });

            document.querySelectorAll('.task-text').forEach(text => {
                text.onblur = function() {
                    const task = findTask(parseInt(this.dataset.taskId), this.dataset.categoryId, this.dataset.subcatId);
                    if (task) {
                        task.text = this.textContent.trim();
                        saveToStorage();
                    }
                };
            });

            document.querySelectorAll('.subcategory-title').forEach(title => {
                title.onblur = function() {
                    const cat = categories[this.dataset.parentId];
                    const subcat = cat?.subcategories?.find(s => s.id === this.dataset.subcatId);
                    if (subcat) {
                        const newText = this.textContent.trim();
                        const match = newText.match(/^(.) (.+)$/);
                        if (match) {
                            subcat.icon = match[1];
                            subcat.name = match[2];
                        } else {
                            subcat.name = newText;
                        }
                        saveToStorage();
                    }
                };
            });

            document.querySelectorAll('.subtask-text').forEach(text => {
                text.onblur = function() {
                    const categoryId = this.dataset.categoryId || this.closest('.category-card').dataset.categoryId;
                    const subcatId = this.dataset.subcatId || this.closest('.subcategory')?.querySelector('.subcategory-title')?.dataset?.subcatId || '';
                    const task = findTask(parseInt(this.dataset.taskId), categoryId, subcatId);
                    if (task && task.subtasks) {
                        task.subtasks[parseInt(this.dataset.subtaskIndex)] = this.textContent.trim();
                        saveToStorage();
                    }
                };
            });
        }

        // Navigation (swipe only, no buttons)
        document.getElementById('zoomToggleBtn').onclick = toggleOverview;

        // Modal keyboard support
        document.getElementById('newTaskText').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewTask();
            } else if (e.key === 'Escape') {
                closeAddModal();
            }
        });
        
        document.getElementById('newGroupName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewGroup();
            } else if (e.key === 'Escape') {
                closeGroupModal();
            }
        });
        
        // Escape key to close steps modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('addStepsModal').classList.contains('show')) {
                closeStepsModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('addTaskModal').addEventListener('click', (e) => {
            if (e.target.id === 'addTaskModal') {
                closeAddModal();
            }
        });
        
        document.getElementById('addGroupModal').addEventListener('click', (e) => {
            if (e.target.id === 'addGroupModal') {
                closeGroupModal();
            }
            // Close icon picker if clicking outside of it
            if (!e.target.closest('.icon-picker-section')) {
                document.getElementById('iconPickerDropdown').classList.remove('show');
                document.getElementById('iconPickerBtn').classList.remove('open');
            }
        });
        
        document.getElementById('addStepsModal').addEventListener('click', (e) => {
            if (e.target.id === 'addStepsModal') {
                closeStepsModal();
            }
        });

        // Touch/swipe for carousel - improved for mobile
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('.task-swipe-container')) return;
            if (e.target.closest('.modal')) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (overviewMode) return;
            if (e.target.closest('.task-swipe-container')) return;
            if (e.target.closest('.modal')) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const touchDuration = Date.now() - touchStartTime;

            // Require horizontal swipe, not too slow, and significant distance
            if (Math.abs(deltaX) > Math.abs(deltaY) * 1.5 && Math.abs(deltaX) > 40 && touchDuration < 500) {
                if (deltaX > 0) prevSlide();
                else nextSlide();
            }
        });

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.target.closest('[contenteditable]')) return;
            if (e.target.closest('.modal')) return;
            if (overviewMode) return;

            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevSlide();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextSlide();
            }
        });

        // Particles
        class Particle {
            constructor(x, y, vx, vy, radius, color) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.radius = radius;
                this.color = color;
                this.pulsePhase = Math.random() * Math.PI * 2;
                this.element = document.createElement('div');
                this.element.className = 'wisp';
                this.element.style.width = (radius * 2) + 'px';
                this.element.style.height = (radius * 2) + 'px';
                this.element.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
                this.element.style.filter = `blur(${radius}px)`;
                this.element.style.opacity = '0.25';
                document.getElementById('background').appendChild(this.element);
            }

            update(time) {
                this.pulsePhase += 0.02;
                this.element.style.transform = `scale(${Math.sin(this.pulsePhase) * 0.15 + 0.85})`;

                this.vx += (Math.random() - 0.5) * 0.02;
                this.vy += (Math.random() - 0.5) * 0.02;
                this.vx += Math.sin(this.y * 0.003 + time * 0.0005) * 0.015;
                this.vy += Math.cos(this.x * 0.003 + time * 0.0005) * 0.015;

                this.x += this.vx;
                this.y += this.vy;

                const width = window.innerWidth;
                const height = window.innerHeight;

                if (this.x < this.radius) {
                    this.x = this.radius;
                    this.vx = Math.abs(this.vx) * 0.4;
                } else if (this.x > width - this.radius) {
                    this.x = width - this.radius;
                    this.vx = -Math.abs(this.vx) * 0.4;
                }

                if (this.y < this.radius) {
                    this.y = this.radius;
                    this.vy = Math.abs(this.vy) * 0.4;
                } else if (this.y > height - this.radius) {
                    this.y = height - this.radius;
                    this.vy = -Math.abs(this.vy) * 0.4;
                }

                this.vx *= 0.95;
                this.vy *= 0.95;

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > 0.8) {
                    this.vx = (this.vx / speed) * 0.8;
                    this.vy = (this.vy / speed) * 0.8;
                }
                if (speed < 0.1 && speed > 0) {
                    this.vx = (this.vx / speed) * 0.1;
                    this.vy = (this.vy / speed) * 0.1;
                }

                this.element.style.left = (this.x - this.radius) + 'px';
                this.element.style.top = (this.y - this.radius) + 'px';
            }
        }

        // Ripple effect
        function createRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = (x - 0) + 'px';
            ripple.style.top = (y - 0) + 'px';
            document.getElementById('background').appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 6000);
        }

        function createAmbientRipple() {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            createRipple(x, y);
        }

        const particles = [];
        const colors = ['rgba(255,182,193,1)', 'rgba(255,218,185,1)', 'rgba(216,191,216,1)', 'rgba(255,228,196,1)', 'rgba(255,192,203,1)', 'rgba(230,190,255,1)', 'rgba(255,200,180,1)', 'rgba(200,220,255,1)'];

        for (let i = 0; i < 12; i++) {
            const angle = (i / 12) * Math.PI * 2;
            const spreadRadius = Math.min(window.innerWidth, window.innerHeight) * 0.3;
            const x = window.innerWidth / 2 + Math.cos(angle) * spreadRadius + (Math.random() - 0.5) * 200;
            const y = window.innerHeight / 2 + Math.sin(angle) * spreadRadius + (Math.random() - 0.5) * 200;
            particles.push(new Particle(x, y, (Math.random() - 0.5) * 0.3, (Math.random() - 0.5) * 0.3, 35 + Math.random() * 25, colors[i % colors.length]));
        }

        let time = 0;
        function animate() {
            time++;
            particles.forEach(p => p.update(time));
            
            if (Math.random() < 0.001) {
                createAmbientRipple();
            }
            
            requestAnimationFrame(animate);
        }

        // Initialize
        loadFromStorage();
        if (overviewMode) {
            document.body.classList.add('overview-mode');
            document.getElementById('zoomIcon').textContent = '+';
        }
        renderCarousel();
        animate();
        
        // Show swipe hint on first visit (only once)
        if (!localStorage.getItem('mylist_swipe_hint_shown') && !overviewMode) {
            setTimeout(() => {
                const activeCard = document.querySelector('.category-card.active');
                if (activeCard) {
                    activeCard.classList.add('swipe-hint');
                    setTimeout(() => {
                        activeCard.classList.remove('swipe-hint');
                        localStorage.setItem('mylist_swipe_hint_shown', 'true');
                    }, 3000);
                }
            }, 500);
        }
        
        setTimeout(() => createAmbientRipple(), 500);
        setTimeout(() => createAmbientRipple(), 1500);
        setTimeout(() => createAmbientRipple(), 2500);
        
        // Load saved API key
        const savedApiKey = localStorage.getItem('claude_api_key');
        if (savedApiKey) {
            document.getElementById('claudeApiKey').value = savedApiKey;
        }

        // ==========================================
        // PHOTO IMPORT FUNCTIONALITY
        // ==========================================
        
        let selectedPhotoBase64 = null;
        let parsedImportData = null;
        
        function openPhotoModal() {
            document.getElementById('photoImportModal').classList.add('show');
            resetPhotoModal();
            
            // Show saved indicator if key exists
            const savedKey = localStorage.getItem('claude_api_key');
            if (savedKey) {
                document.getElementById('claudeApiKey').value = savedKey;
                document.getElementById('apiKeySaved').style.display = 'block';
            }
        }
        
        function closePhotoModal() {
            document.getElementById('photoImportModal').classList.remove('show');
            resetPhotoModal();
        }
        
        function resetPhotoModal() {
            selectedPhotoBase64 = null;
            parsedImportData = null;
            
            document.getElementById('photoPreview').classList.remove('show');
            document.getElementById('photoPreview').src = '';
            document.getElementById('photoUploadArea').classList.remove('has-image');
            document.getElementById('photoUploadArea').querySelector('.photo-upload-icon').style.display = 'block';
            document.getElementById('photoUploadArea').querySelector('.photo-upload-text').style.display = 'block';
            document.getElementById('photoUploadArea').querySelector('.photo-upload-hint').style.display = 'block';
            
            document.getElementById('processingIndicator').classList.remove('show');
            document.getElementById('importError').classList.remove('show');
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('importSuccess').classList.remove('show');
            
            document.getElementById('processPhotoBtn').style.display = 'none';
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('photoInput').value = '';
        }
        
        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showImportError('Please select an image file.');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showImportError('Image too large. Please use an image under 10MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                selectedPhotoBase64 = base64;
                
                // Show preview
                const preview = document.getElementById('photoPreview');
                preview.src = base64;
                preview.classList.add('show');
                
                // Update upload area
                const uploadArea = document.getElementById('photoUploadArea');
                uploadArea.classList.add('has-image');
                uploadArea.querySelector('.photo-upload-icon').style.display = 'none';
                uploadArea.querySelector('.photo-upload-text').style.display = 'none';
                uploadArea.querySelector('.photo-upload-hint').style.display = 'none';
                
                // Show process button
                document.getElementById('processPhotoBtn').style.display = 'inline-block';
                document.getElementById('importError').classList.remove('show');
            };
            reader.readAsDataURL(file);
        }
        
        function showImportError(message) {
            const errorEl = document.getElementById('importError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        async function processPhoto() {
            const apiKey = document.getElementById('claudeApiKey').value.trim();
            
            if (!apiKey) {
                showImportError('Please enter your Claude API key.');
                return;
            }
            
            if (!selectedPhotoBase64) {
                showImportError('Please select a photo first.');
                return;
            }
            
            // Save API key
            localStorage.setItem('claude_api_key', apiKey);
            document.getElementById('apiKeySaved').style.display = 'block';
            
            // Show processing
            document.getElementById('processingIndicator').classList.add('show');
            document.getElementById('processPhotoBtn').style.display = 'none';
            document.getElementById('importError').classList.remove('show');
            
            // Build category context for Claude
            const categoryContext = buildCategoryContext();
            
            // Extract base64 data (remove data URL prefix)
            const base64Data = selectedPhotoBase64.split(',')[1];
            const mediaType = selectedPhotoBase64.split(';')[0].split(':')[1];
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4096,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `You are a task extraction assistant. Look at this handwritten note and extract all tasks/items from it.

Here are the existing categories and groups in the user's task app:
${categoryContext}

Please analyze the handwritten notes and:
1. Extract each task/item you can read
2. Assign each task to the most appropriate existing category or subcategory/group
3. If a task doesn't fit any category, assign it to "work" as default
4. Try to infer priority (urgent, high, medium) if the handwriting suggests urgency (underlines, stars, exclamation marks)

Respond ONLY with valid JSON in this exact format (no other text):
{
  "tasks": [
    {
      "text": "task description",
      "categoryId": "work",
      "subcategoryId": null,
      "priority": null
    }
  ]
}

categoryId must be one of: ${Object.keys(categories).filter(c => c !== 'urgent').join(', ')}
subcategoryId should be the subcategory/group id if applicable, or null
priority should be "urgent", "high", "medium", or null`
                                }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const content = data.content[0].text;
                
                // Parse the JSON response
                try {
                    // Extract JSON from response (in case there's any extra text)
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('No valid JSON found in response');
                    }
                    
                    parsedImportData = JSON.parse(jsonMatch[0]);
                    
                    if (!parsedImportData.tasks || parsedImportData.tasks.length === 0) {
                        throw new Error('No tasks found in the image');
                    }
                    
                    // Show preview
                    showImportPreview(parsedImportData.tasks);
                    
                } catch (parseError) {
                    throw new Error('Could not parse tasks from image. Try a clearer photo.');
                }
                
            } catch (error) {
                console.error('Photo processing error:', error);
                showImportError(error.message || 'Failed to process photo. Please try again.');
                document.getElementById('processPhotoBtn').style.display = 'inline-block';
            } finally {
                document.getElementById('processingIndicator').classList.remove('show');
            }
        }
        
        function buildCategoryContext() {
            let context = '';
            categoryOrder.forEach(catId => {
                if (catId === 'urgent') return;
                const cat = categories[catId];
                if (!cat) return;
                
                context += `\nCategory: "${cat.name}" (id: ${catId})`;
                
                if (cat.subcategories && cat.subcategories.length > 0) {
                    cat.subcategories.forEach(sub => {
                        context += `\n  - Group: "${sub.name}" (id: ${sub.id})`;
                    });
                }
            });
            return context;
        }
        
        function showImportPreview(tasks) {
            const previewEl = document.getElementById('importPreview');
            
            // Group tasks by category
            const grouped = {};
            tasks.forEach(task => {
                const catId = task.categoryId || 'work';
                const cat = categories[catId];
                const catName = cat ? cat.name : catId;
                const key = task.subcategoryId ? `${catId}/${task.subcategoryId}` : catId;
                
                if (!grouped[key]) {
                    let displayName = catName;
                    if (task.subcategoryId && cat?.subcategories) {
                        const sub = cat.subcategories.find(s => s.id === task.subcategoryId);
                        if (sub) displayName = `${catName} ‚Üí ${sub.name}`;
                    }
                    grouped[key] = { name: displayName, tasks: [] };
                }
                grouped[key].tasks.push(task);
            });
            
            // Build HTML
            let html = '';
            Object.values(grouped).forEach(group => {
                html += `<div class="import-category">
                    <div class="import-category-title">${group.name}</div>
                    <ul class="import-task-list">
                        ${group.tasks.map(t => `
                            <li class="import-task-item">
                                ${t.text}
                                ${t.priority ? `<span class="priority-badge priority-${t.priority}">${t.priority.toUpperCase()}</span>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>`;
            });
            
            previewEl.innerHTML = html;
            previewEl.classList.add('show');
            document.getElementById('confirmImportBtn').style.display = 'inline-block';
        }
        
        function confirmImport() {
            if (!parsedImportData || !parsedImportData.tasks) return;
            
            parsedImportData.tasks.forEach(task => {
                const catId = task.categoryId || 'work';
                const cat = categories[catId];
                if (!cat) return;
                
                const newTask = {
                    id: nextTaskId++,
                    text: task.text,
                    completed: false
                };
                
                if (task.priority) {
                    newTask.priority = task.priority;
                }
                
                if (task.subcategoryId) {
                    const sub = cat.subcategories?.find(s => s.id === task.subcategoryId);
                    if (sub) {
                        sub.tasks.push(newTask);
                    } else {
                        // Fallback to main category
                        if (!cat.tasks) cat.tasks = [];
                        cat.tasks.push(newTask);
                    }
                } else {
                    if (!cat.tasks) cat.tasks = [];
                    cat.tasks.push(newTask);
                }
            });
            
            // Show success
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('importSuccess').classList.add('show');
            
            // Save and re-render
            saveToStorage();
            renderCarousel();
            
            // Close modal after delay
            setTimeout(() => {
                closePhotoModal();
            }, 1500);
        }
        
        // Close photo modal on overlay click
        document.getElementById('photoImportModal').addEventListener('click', (e) => {
            if (e.target.id === 'photoImportModal') {
                closePhotoModal();
            }
        });
        
        // Escape to close photo modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('photoImportModal').classList.contains('show')) {
                closePhotoModal();
            }
        });
    </script>
</body>
</html>
